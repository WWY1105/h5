function earnCheck(e){y=setInterval(function(){rest("/order/"+e+"/pay/result",{},"get",function(e){"200"==e.code||"404014"==e.code?(clearInterval(y),earnTrue()):$.toast("支付结果查询中")})},1e3)}function chooseCity(){rest("/dict/city",{},"get",function(e){if(200==e.code){var t=e.result,i="";for(var a in t)$(".am-padding-sm").append("<a class='box external' href='shops.html"+location.search+"&code="+t[a].code+"&name="+encodeURIComponent(t[a].name)+"'>"+t[a].name+"</a>");$("#city").html(i),$("#total").show()}else toast(e.message)})}function refresh(){window.location.href=location.href+"&time="+(new Date).getTime()}function couponName(e){if(e.hasOwnProperty("amount"))var t="<div class='left'><span class='dollar'></span>"+e.amount+"</div>";else var t="<div class='left coupon-icon'></div>";return t+="<div class='right'><div class='ellipsis'>"+e.name+"</div>"+(e.count>1?"<div class='countNo'>X"+e.count+"</div>":"")+"<div class='grey'>"+e.times+"</div></div>"}function setTitle(e){document.title=e;var t=document.createElement("iframe");t.style.display="none",t.onload=function(){setTimeout(function(){t.remove()},9)},document.body.appendChild(t)}function checkTime(e){return e<10&&(e="0"+e),""+e}function replaceMethod(e){if(!e)return"";var t=e.split("\n");return t.join("<br/>")}function replaceFont(e){var t="";"number"==typeof e&&(e+="");for(var i in e)t+='<i class="iconfont icon-icon-test'+("."==e.charAt(i)?"dot":e.charAt(i))+'"></i>';return t}function replaceUrl(e){if(!e.activityCategory)return void(e.linkUrl&&(location.href=e.linkUrl));switch(e.activityCategory){case"6004":ajaxUrl("couponActivity.html?aid="+e.activityId);break;case"6015":ajaxUrl("mealActivity.html?aid="+e.activityId);break;case"6002":redirectUrl("charge");break;case"6001":redirectUrl("upgrade?tid="+e.activityId);break;case"6003":redirectUrl("exchange");break;case"6041":location.href="/grouponInfo.html?aid="+e.activityId+"&guestid="+e.guestId;break;case"6050":location.href="/lottery.html?aid="+e.activityId+"&guestid="+e.guestId;break;case"6051":location.href="/raffleActivity.html?aid="+e.activityId+"&guestid="+e.guestId;break;default:ajaxUrl("activity.html?aid="+e.activityId)}}function grouponInfo(){var e=new Vue({el:"#app",data:{data:"",view:{},time:[],state:!1,transversePicUrl:""},beforeCreate:function(){var e=this;return key_json.aid?void rest("/groupon/activity/"+key_json.aid,{},"get",function(t){function i(){var t=new Date(e.data.activity.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),n=parseInt(t/1e3/60/60%24,10),s=parseInt(t/1e3/60%60,10),o=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(n)),Vue.set(e.time,2,checkTime(s)),Vue.set(e.time,3,checkTime(o))}if(200==t.code){$("#loading").addClass("hide"),setTitle(t.result.brandName+"邀您来砍价"),t.result.groupon&&rest("/groupon/"+t.result.groupon.grouponId+"/record",{},"get",function(t){200==t.code&&(e.view={list:t.result},setTimeout(function(){$("#Marquee_x").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100))}),e.data=t.result,e.data.advertisement&&e.data.advertisement.transversePicUrl&&(e.transversePicUrl=e.data.advertisement.transversePicUrl);var a=setInterval(i,1e3);if("WXPAY"==version){var n={};n.url=location.href,rest("/auth/sign",n,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.shareTitle,desc:(e.data.activity.unUsedCount?"仅剩"+e.data.activity.unUsedCount+"份":"")+"最低砍到"+e.data.activity.finalAmount+"！你也有机会！猛戳抢",link:e.data.groupon?location.origin+"/groupee.html?gid="+e.data.groupon.grouponId+"&guestid="+key_json.guestid:location.href,imgUrl:e.data.logoUrl,type:"",dataUrl:"",success:function(){rest("/groupon/activity/"+key_json.aid+"/invitation",{},"post",function(e){})},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.shareTitle,link:e.data.groupon?location.origin+"/groupee.html?gid="+e.data.groupon.grouponId+"&guestid="+key_json.guestid:location.href,imgUrl:e.data.logoUrl,success:function(){}})})}})}}else alert(t.message),location.href="error.html#4"}):(alert(location.href),void ajaxUrl("groupee.html?gid="+key_json.id))},methods:{bargainFn:function(){_self=this,rest("/groupon/activity/"+key_json.aid,{},"post",function(e){200==e.code?($.toast("成功砍减"+e.result.amount+"元"),setTimeout(function(){refresh()},2500)):alert(e.message)})},ruleFn:function(){$.showIndicator();var e=this;rest("/groupon/activity/"+key_json.aid+"/content",{},"get",function(t){200==t.code&&(Vue.set(e.view,"rule",t.result),$("#modal").show())})},earnFn:function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},closeFn:function(){$(".gmodal").hide()},buyFn:function(e){ajaxUrl("buy.html?aid="+key_json.aid)},inviteFn:function(){$(".gmadal-black").append("<div id='loading'></div>");var e=this;$(".gmadal-black").show(),$("#canvas").html()?rest("/groupon/activity/"+key_json.aid+"/invitation",{},"post",function(t){200==t.code&&(e.qrcode=t.result,e.$nextTick(function(){var e=new QRCode($("#my-code1"),{width:100,height:100});e.makeCode(t.result.qrCode);var i=$("#canvas"),a=i.width(),n=i.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=a*e,t.height=n*e,t.style.width=a*e+"px",t.style.height=n*e+"px";var i=t.getContext("2d");i.scale(e,e),html2canvas($("#canvas"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$("#img").attr("src",t),$("#canvas").remove(),$(".gmadal-black #loading").remove()}})},100)}))}):$(".gmadal-black #loading").remove()},pageFn:function(){var e=this;e.view.list.page>=e.view.list.pageSize||rest("/groupon/"+this.data.groupon.grouponId+"/record",{page:++e.view.list.page,count:e.view.list.count},"get",function(t){200==t.code&&(e.view.list.items=e.view.list.items.concat(t.result.items))})}}});e.$watch("data.groupon.amount",function(e){console.log(e)},{deep:!0})}function groupon(){grouponInfo()}function groupee(){new Vue({el:"#app",data:{data:"",view:{},time:[],state:!1},beforeCreate:function(){var e=this;return key_json.gid?void rest("/groupon/"+key_json.gid,{},"get",function(t){function i(){var t=new Date(e.data.activity.endTime)-new Date;if(!t)return void clearInterval(n);var i=parseInt(t/1e3/60/60/24,10),s=parseInt(t/1e3/60/60%24,10),o=parseInt(t/1e3/60%60,10),r=parseInt(t/1e3%60,10);Vue.set(e.time,0,a(i)),Vue.set(e.time,1,a(s)),Vue.set(e.time,2,a(o)),Vue.set(e.time,3,a(r))}function a(e){return e<10&&(e="0"+e),""+e}if(200==t.code){if($("#loading").addClass("hide"),e.data=t.result,setTitle(t.result.brandName),1==t.result.self)return void ajaxUrl("groupon.html?aid="+t.result.activity.activityId);rest("/groupon/"+key_json.gid+"/record",{},"get",function(t){200==t.code?(e.view={list:t.result},setTimeout(function(){$("#Marquee_x").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100)):$(".infinite-scroll-preloader").remove()});var n=setInterval(i,1e3);if("WXPAY"==version){var s={};s.url=location.href,rest("/auth/sign",s,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.shareTitle,desc:(e.data.activity.unUsedCount?"仅剩"+e.data.activity.unUsedCount+"份":"")+"最低砍到"+e.data.activity.finalAmount+"！你也有机会！猛戳抢",link:location.href,imgUrl:e.data.logoUrl,type:"",dataUrl:"",success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.shareTitle,link:location.href,imgUrl:e.data.logoUrl,success:function(){}})})}})}}else alert(t.message),location.href="error.html#4"}):void alert("no")},methods:{bargainFn:function(){var e=this;rest("/groupon/"+key_json.gid,{},"post",function(t){200==t.code?($.toast("成功砍减"+t.result.amount+"元"),rest("/groupon/"+key_json.gid,{},"get",function(t){200==t.code&&(e.data=t.result,rest("/groupon/"+key_json.gid+"/record",{},"get",function(t){200==t.code&&(e.view={list:t.result})}))})):405015==t.code?($("#my-code2").html()||(qrcode=new QRCode($("#my-code2"),{width:140,height:140}),qrcode.makeCode(t.result.qrCode)),$("#qrcode").show()):alert(t.message)})},ruleFn:function(){var e=this;$.showIndicator(),rest("/groupon/activity/"+e.data.activity.activityId+"/content",{},"get",function(t){200==t.code?(Vue.set(e.view,"rule",t.result),$("#modal").show()):alert(t.message)})},earnFn:function(){$.showIndicator(),ajaxUrl("buyRecord.html?aid="+this.data.activity.activityId)},closeFn:function(){$(".gmodal").hide()},buyFn:function(e){ajaxUrl("buy.html?aid="+this.data.activity.activityId+"&gid="+key_json.gid)},restartFn:function(){ajaxUrl("groupon.html?aid="+this.data.activity.activityId)},pageFn:function(){var e=this;e.view.list.page>=e.view.list.pageSize||rest("/groupon/"+this.data.groupon.grouponId+"/record",{page:++e.view.list.page,count:e.view.list.count},"get",function(t){200==t.code&&(e.view.list.items=e.view.list.items.concat(t.result.items))})}}})}function buy(){new Vue({el:"#app",data:{data:"",payment:""},beforeCreate:function(){function e(e){e&&e.payMode&&(t.payment=e.payMode);var i={};key_json.gid&&(i.grouponId=key_json.gid),rest("/groupon/"+key_json.aid+"/buy",i,"get",function(e){200==e.code?($("#loading").addClass("hide"),t.data=e.result):history.back()})}var t=this;setPayMode(e)},methods:{buyFn:function(e){$.showIndicator(),$(".button-big").addClass("disabled");var t=this,i={activityId:key_json.aid,url:encodeURIComponent(location.href),failedUrl:encodeURIComponent(location.href)};if(t.payment)i.payCategory=payment;else if(t.data.amount>0)return void alert("暂无可支持的方式");key_json.gid&&(i.grouponId=key_json.gid),rest("/groupon/buy",i,"post",function(e){if(405009==e.code)return void $.confirm("支付遇到问题，是否重新支付？",function(){rest("/order/"+e.result.orderId+"/pay/revoke",{},"post",function(e){200==e.code?refresh():(alert(e.message),$(".button-big").removeClass("disabled"))})},function(){$(".button-big").removeClass("disabled")});if(200!=e.code)return alert(e.message),$(".button-big").removeClass("disabled"),void $.hideIndicator();if(0==t.data.amount)return $("#succed").show(),void setTimeout(function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},1500);var i=e.result.orderId;if($.fn.cookie("order_id",i),e.result.url)return void(location.href=e.result.url);switch(payment){case"1005":var a=e.result.js,n=e.result.pay;n.success=function(){$.hideIndicator(),$(".pay-fixed").hide(),$("#succed").show(),setTimeout(function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},1500)},n.cancel=function(){$.hideIndicator(),$(".button-big").removeClass("disabled"),cancelPay()},n.fail=function(e){$.hideIndicator(),$(".button-big").removeClass("disabled"),cancelPay(),alert("支付失败")},a.debug=!1,a.jsApiList=["chooseWXPay"],delete a.url,wx.config(a),wx.ready(function(){wx.chooseWXPay(n)});break;case"1101":AlipayJSBridge.call("tradePay",{tradeNO:e.result.pay.tradeNO},function(e){return"6001"==e.resultCode?($(".button-big").removeClass("disabled"),void cancelPay()):("9000"==e.resultCode&&($.hideIndicator(),$(".pay-fixed").hide(),$("#succed").show(),setTimeout(function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},1500)),void $.hideIndicator())})}})},closeFn:function(){$(".gmodal").hide()}}})}function buyRecord(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){$("#loading").addClass("hide");var e=this;rest("/groupon/"+key_json.aid+"/buy/record",{},"get",function(t){200==t.code&&(e.data=t.result,"WXPAY"==version&&rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;t.subscribe||loadImage(t.url,'$(".shop_url").attr("src", url);$("#addon").attr("style","justify-content: center;-webkit-justify-content: center;display:flex")')}))})},methods:{pageFn:function(){var e=this;e.data.page>=e.data.pageSize||rest("/groupon/"+key_json.aid+"/buy/record",{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}})}function mealDetail(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/activities/activity/"+key_json.aid+"/setmeal/"+key_json.rid,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):alert(t.message)})}})}function mealActivity(){rest("/activities/setmeal/"+key_json.aid,{},"get",function(e){if(200==e.code){var t=e.result;t.remainCount&&$(".relative-label").html("剩"+t.remainCount+"份"),$(".coupon-name").html(t.name);for(var i=0;i<t.strategy.length;i++){var a=t.strategy[i],n=$(".hide .item").clone();n.attr("onclick","ajaxUrl('mealDetail.html?aid="+a.activityId+"&rid="+a.ruleTupleId+"')"),a.desUrl&&n.find(".m-bg").attr("style","background-image:url("+a.desUrl+")"),a.from&&n.find(".i-grade").html("<span>"+a.from+"可参加</span>"),n.find(".m-bg .m-title").html(a.name),a.content&&n.find(".m-content .m-title").html(a.content[0]),n.find(".text-orange").html("￥"+a.benefit),n.find(".amount").html("￥"+a.amount),$(".set-coupon").append(n)}$("#loading").addClass("hide")}})}function my(){location.href="admin.html#/user"+location.search}function user(){location.href="admin.html#/user"+location.search}function face(){rest("/check/code",{},"get",function(e){200==e.code?($("#my-code1").html()||(qrcode=new QRCode($("#my-code1"),{width:150,height:150}),qrcode.makeCode(e.result.code)),setInterval(refreshCode,6e4),$("#loading").addClass("hide"),socket()):history.back(),$.init()})}function couponActivity(){function e(){$.showIndicator(),rest("/benefit/obtain/guest/"+_id,{activityId:key_json.aid},"post",function(e){switch(e.code){case 200:earnTrue();break;case 405017:alert(e.message),key_json.guestid?ajaxUrl("more.html"):chooseIndex();break;case 405015:rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;$.modal({title:"<strong>关注本店公众号<br/>才可参与本活动</strong>",afterText:'<div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><div class=""><img style="width: 68%;min-height: 8rem" src="'+t.url+'"></div><div class="text-grey" style="padding: 1rem 0 .5rem">长按二维码关注</div><img src="/sui_assets/img/finger.gif"><div class="md-close"></div></div>',extraClass:"bg-green"})});break;case 405029:$.toast(e.message),setTimeout(function(){ajaxUrl("birth.html")},2500);break;case 4050781:$.toast(e.message,5e3);break;default:$.toast(e.message)}$.hideIndicator()})}rest("/activities/activity/"+key_json.aid+"/coupon",{},"get",function(e){if(200==e.code){$("title").html(e.result.brandName),e.result.logo&&loadImage(e.result.logo,'$(".avatar").attr("src", url)'),e.result.existPhone||($("#bind").show(),$("#phone").hide(),$(".strength").show()),e.result.remainCount&&$(".relative-label").html("剩"+e.result.remainCount+"份"),$(".coupon-name").html(e.result.name),$(".set-coupon").html("");for(var t=e.result.cells,i=0;i<t.length;i++)for(var a=0;a<t[i].coupons.length;a++){var n=t[i].coupons[a],s=$(".hide .coupon_show").clone();switch(s.attr("index",n.id),0==a?s.find(".i-grade").html("<span>"+t[i].name+"尊享</span>"):s.find(".i-grade").remove(),n.category){case"9021":case"902":s.find(".i-uncoupon").addClass("dui"),s.addClass("more"),s.find(".follow-box").append(' <div class="right"> <div class="currentAmount" style="font-weight: 700">'+(n.currentAmount?"￥"+n.currentAmount:"免费")+'</div> <div class="amount" style="font-size: .5rem">￥'+n.amount+"</div> </div>");break;case"903":s.find(".i-uncoupon").addClass("di"),s.addClass("more");break;case"904":s.find(".i-uncoupon").addClass("gift1")}"902"==n.category||"9021"==n.category||"904"==n.category,n.useStrategy&&s.find(".follow-box .left").append("<div>"+n.useStrategy+"</div>"),n.times&&s.find(".follow-box .left").append("<div>"+n.times+"</div>"),s.find(".text-lg").html(n.name),$(".set-coupon").append(s)}if($("#time").html(e.result.time||"不限"),e.result.limit){var o="";for(var r in e.result.limit)o+="<li>"+e.result.limit[r]+"</li>";$("#content").html(o)}e.result.additional&&$("#content").append("<li>"+e.result.additional+"</li>"),$("#loading").addClass("hide")}else location.href="error.html#1"});var t;$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){var i=90;t=setInterval(function(){return i--,i?void $(".input-text").html("已发送 "+i+" s"):(clearInterval(t),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#bindPhone").off().click(function(){11==$("#tel").val().length&&6==$("#validate").val().length?$(this).hasClass("disabled")||($(this).addClass("disabled"),rest("/phone/bindup",{phone:$("#tel").val(),validateCode:$("#validate").val(),guestId:key_json.guestid,shopId:key_json.id},"post",function(i){200==i.code?(i.result&&i.result.token&&$.fn.cookie("token",i.result.token,{expires:30,path:"/"}),e()):($("#validate").val(""),clearInterval(t),$(".input-text").removeClass("disabled").html("重新获取验证码"),$.toast(i.message),$("#bindPhone").removeClass("disabled"))})):$.toast("输入框不能为空")}),$("body").on("click",".earnCoupon",function(){e()})}function success(){"fail"==key_json.type&&$(".success").addClass("fail"),rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;setTitle(t.name),t&&t.url?$(".wx-img img").attr("src",t.url):$(".direct-content").hide()}),$.init(),$("#loading").addClass("hide")}function waiting(){socket();var e=$.fn.cookie("order_id");e||(alert("订单不存在"),chooseIndex()),rest("/check/coupons/"+_id,{},"get",function(e){200==e.code&&(setCoupon({items:e.result}),$("#coupon").show())}),$.init(),$("#loading").addClass("hide"),rest("/check/"+e,{},"get",function(e){function t(){var e=[];e[0]=Math.floor(a%60),e[1]=Math.floor(a%3600/60),e[2]=Math.floor(a/3600);for(var t=0;t<3;t++)e[t]<10&&(e[t]="0"+e[t]);$(".clark").html(e[2]+" : "+e[1]+" : "+e[0]),a+=1}if(200!=e.code)return void history.back();if(1!=e.result.step)return void state();var i=e.result,a=i.times||0;setInterval(t,1e3)}),$(".cancel").click(function(){$.closeModal(),$.modal({title:"注意",afterText:"<p>为了保障上宾权益，您一天最多可以取消三次买单</p>",buttons:[{text:"不取消",bold:!0},{text:"确认取消",bold:!0,onClick:function(){rest("/check/"+$.fn.cookie("order_id")+"/cancel",{},"post",function(e){200==e.code?chooseIndex():$.toast(e.message)})}}]})})}function chooseIndex(){if(key_json.id){var e="/admin.html#/selfpay";key_json.cashier&&(e="/admin.html#/cashier"),e+="?id="+key_json.id,key_json.d&&(e+="&d="+key_json.d),key_json.cashier&&(e+="&cashier="+key_json.cashier),location.href=e}else redirectUrl()}function cancelPay(){rest("/order/"+$.fn.cookie("order_id")+"/pay/revoke",{},"post",function(e){200==e.code&&("strategy"==basicName||$.hideIndicator())})}function bargain(){rest("/bargain/"+key_json.bid,{},"post",function(e){switch($.init(),$("#loading").addClass("hide"),e.code){case 405326:$("#text").html("还没人为我凑单"),$(".self").removeClass("hide"),$(".continue").show(),$("body").on("click",".continue",function(){location.href="strategy.html?id="+e.result.shopId+"&oid="+e.result.orderId});break;case 405325:$(".top").addClass("fail"),$(".auth").removeClass("hide");break;case 405324:$(".top").addClass("fail"),$(".auth").removeClass("hide");break;case 405323:$(".top").addClass("fail"),$(".expire").removeClass("hide");break;case 200:$(".done").removeClass("hide");break;case 405328:$(".top").addClass("fail"),$(".top").html('<div style="padding: 0 20px"><div class="c-expire"></div><div>本次凑单已经结束啦~</div></div>');break;default:$(".top").addClass("fail"),$(".top").html('<div style="padding: 0 20px"><div class="c-expire"></div><div>'+e.message+"</div></div>")}if($(".currentAmount").html((e.result.effective||0)+"元"),$(".reduce").html((e.result.eachAmount||0)+"元"),$(".time").html(e.result.timesLimit),$(".name").html(e.result.nickname||""),e.result.details){$(".media-list").html("");for(var t=0;t<e.result.details.length;t++){var i=$(".hide ul").clone(),a=e.result.details[t];if(!a.enabled)break;i.find(".item-title").html(a.nickname),a.myself&&(i.find(".item-title").html("我"),i.css("background","beige")),i.find(".c-star").html(t+1),i.find(".item-media img").attr("src",a.avatarUrl),i.find(".text-orange").html(a.amount+"元"),i.find(".text-xs").html(a.createTime),$(".media-list").append(i)}}})}function record(){rest("/order/guest/"+_id,{},"get",function(e){function t(e){for(var t=0;t<e.length;t++){var i=$(".hide .card").clone();i.find("#finalAmount").html("实付款 ￥"+(e[t].amount-(e[t].reduceAmount||0)).toFixed(2)),i.find("#amount").html("消费 ￥"+e[t].amount),i.find(".c-record .text-grey").html(e[t].checkTime),i.find(".shop").html(e[t].shopName+"<span class='text-grey pull-right' style='padding-top: 0'>订单号："+e[t].no+"</span>"),i.find(".btn-w").attr("onclick","ajaxUrl('admin.html#/payment?order="+e[t].orderId+"')"),"1000"==e[t].state&&i.find(".c-b-box .pull-left").removeClass("hide"),i.find(".operate .pull-right").html(e[t].staffName||"");var a=e[t].strategy;if(a){if(a.coupons)for(var n=0;n<a.coupons.length;n++){var s=a.coupons[n],o=$(".hide .c-coupon").clone();"901"==s.category?o.find(".left").html("现金券"):"904"==s.category&&o.find(".left").html("礼品券"),o.find(".right").html(s.name+" "+s.count+"张<div class='text-xs'>"+s.times+"</div>"),i.find(".set-coupon").append(o)}a.points&&i.find(".c-point").html('<img src="/sui_assets/img/svg/2@1x.svg">'+a.points.point+"积分")}else i.find(".c-box").remove(),i.find(".c-record").addClass("empty");$(".set-code").append(i)}}var i,a=1,n=20,s=!1;200==e.code?(e.result.items&&t(e.result.items),i=e.result.total,i<=n&&$(".infinite-scroll-preloader").remove(),$.init(),$("#loading").addClass("hide")):($(".infinite-scroll-preloader").remove(),$(".content").append('<div class="text-center" style="padding: 3rem 2.5rem"><div class="v_green_wrong_coupon" style="margin: 0 auto;float: inherit"></div><p class="text">您还没有成功的买单哦~</p></div>')),$(document).on("infinite",".infinite-scroll-bottom",function(){s||(s=!0,setTimeout(function(){return s=!1,a*n>=i?void $(".infinite-scroll-preloader").remove():(a++,rest("/order/guest/"+_id,{page:a,count:n},"get",function(e){e.result&&t(e.result.items)}),void $.refreshScroller())},1e3))})})}function orderDetail(){return key_json.order?void rest("/order/"+key_json.order+"/detail",{},"get",function(e){if(200==e.code){var t=e.result,i=e.result.strategy;if($(".shop").html(e.result.shopName),$("#finalAmount").html("实付款 ￥"+i.finalAmount),$("#amount").html(t.paymentModeText),"1000"==t.state&&$("#amount").append("<span class=''> （已退款）</span>"),$(".plan-box").html('<div class="padding-xs"> <div class="left">原单金额</div> <div class="right">￥'+t.amount+"</div> </div>"),!t.hasOwnProperty("obtained")||t.obtained?"906"==t.state?($(".btn-w").removeClass("hide"),shopId&&$(".btn-w").attr("onclick","redirectUrl()")):($(".c-text").html("奖励已发放至您的账户:"),$(".set-coupon").attr("onclick","redirectUrl()"),$(".c-point").attr("onclick","redirectUrl('exchange')")):$(".btn-g").removeClass("hide"),t.strategy.coupons)for(var a=0;a<t.strategy.coupons.length;a++){var n=t.strategy.coupons[a],s=$("#code .c-coupon").clone();"901"==n.category?s.find(".left").html("现金券"):"904"==n.category&&s.find(".left").html("礼品券"),s.find(".right").html(n.name+" "+n.count+"张<div class='text-xs'>"+n.times+"</div>"),$(".set-coupon").append(s)}if(t.strategy.points&&$(".c-point").html('<img src="/sui_assets/img/svg/2@1x.svg">'+t.strategy.points.point+"积分"),t.strategy.points||t.strategy.coupons||$(".c-box").remove(),i.nonPart){var o='<div class="padding-xs"><div class="left">不计优惠</div><div class="right">'+i.nonPart.name+'<span class="pull-right">￥'+i.nonPart.amount+"</span></div></div>";$(".plan-box").append(o)}if(i.used){for(var o='<div class="padding-xs"><div class="left">金额抵用</div><div class="right">',r=0;r<i.used.length;r++){var d=i.used[r].count?"("+i.used[r].count+" 张)":"";o+="<div>"+i.used[r].content+'<span class="pull-right">- ￥'+i.used[r].amount+d+"</span></div>"}o+="</div></div>",$(".plan-box").append(o)}$(".plan-box").append('<div class="padding-xs"> <div class="left">操作人员</div> <div class="right">'+(t.staffName||"自助买单")+"</div> </div>"),$.init(),$("#loading").addClass("hide")}else alert(e.message)}):void alert("无订单信息")}function couponFn(){Vue.component("coupon",{props:["item","use","use1","use2"],template:'<div class="item" v-bind:class="{\'used\':use,\'used1\':use1,\'used2\':use2,\'reward\':item.category == \'1017\'}" v-on:click="couponDetailFn(item.id,item.category)"><div class="left" v-if="item.amount > \'0\' "><div v-if="item.category == \'1016\' "><div v-if="item.couponCategory == \'901\'"><div class="amount"><span class="dollar"></span>{{item.amount}}</div></div><div v-if="item.couponCategory == \'9011\'"><div class="amount"><span class="dollar"></span>{{item.amount}}</div></div><div v-if="item.couponCategory == \'902\'"><div class="amount"><span class="dollar"></span>{{item.amount}}</div><div class="grey" style="text-decoration: line-through">原价￥{{+item.amount + +item.currentAmount}}</div></div><div v-if="item.couponCategory == \'9021\'"><div class="amount"><span class="dollar"></span>{{item.amount}}</div><div class="grey">价值￥{{item.amount}}</div></div><div v-if="item.couponCategory == \'903\'"><span class="amount">{{item.amount}}<span style="font-size: .9rem">折</span></span></div><div v-if="item.couponCategory == \'9031\'"><span class="amount">{{item.amount}}<span style="font-size: .9rem">折</span></span></div><div v-if="item.couponCategory == \'904\'"><div class="amount"><span class="dollar"></span>{{item.amount}}</div></div></div><div v-if="item.category !== \'1016\'"><div class="amount" style="color:#f7a00e"><span class="dollar" style="color:#f7a00e"></span>{{item.amount}}</div></div></div><div class="left coupon-icon" v-if="item.amount == \'0\' "></div><div class="right"><div class="title">{{item.category == \'1017\'?\'代用币\':(item.name + (item.count>1?"（"+item.count +"张）":""))}}</div><ul><li>{{item.useStrategy}}</li><li v-if="item.times">{{item.times}}</li></ul></div><div class="countsN" v-if="item.count> \'1\' ">{{item.count}}张</div></div>',methods:{couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))}}})}function prizesFn(){Vue.component("prizes",{props:["prize"],data:function(){return{category:{901:"simple",9011:"simple",902:"multi",9021:"multi",903:"simple",9031:"simple",904:"multi"}}},template:'<div class="prizes"><div v-on:click="couponDetailFn(item.benefits[0].id,item.benefits[0].category)" :class="{\'gap\':index!=0||prize.length%2==0}" v-for="(item,index) in prize"><div class="item multi" :style="{\'backgroundImage\':\'url(\'+item.benefits[0].picUrl+\')\'}" v-if="category[item.benefits[0].couponCategory]==\'multi\'&&(index!=0||prize.length%2==0)"><div class="border"><div>{{item.benefits[0].name}}<div v-if="item.benefits[0].couponCategory==\'904\'">价值 <span class="text-red">￥{{item.benefits[0].amount}}</span></div><div v-else><span class="text-red">￥{{item.benefits[0].currentAmount}}</span> <span class="text-through">价值￥{{item.benefits[0].amount}}</span></div></div><div class="addon"><span class="label"><span v-if="item.start">发红包数</span><span v-else>{{item.name}}</span></span><span class="label1"><span v-if="item.start">第{{item.start}}</span><span v-else>{{item.count}}</span><span v-if="item.end">~{{item.end}}</span>名</span></div></div></div><div class="item simple" :class="{\'reward\':item.benefits[0].category==\'1017\'}" v-else><div class="left has-pic" v-if="category[item.benefits[0].couponCategory]==\'multi\'":style="{\'backgroundImage\':\'url(\'+item.benefits[0].picUrl+\')\'}"></div><div class="left" v-else><div v-if="item.benefits[0].couponCategory==\'903\'||item.benefits[0].couponCategory==\'9031\'">{{item.benefits[0].amount}}折</div><div v-else-if="item.benefits[0].couponCategory==\'9011\'">{{item.benefits[0].name}}</div><div v-else><span class="dollar"></span>{{item.benefits[0].amount}}</div></div><div class="right" v-if="category[item.benefits[0].couponCategory]==\'multi\'">    <div style="overflow: hidden">{{item.benefits[0].name}}</div><div class="text-right" v-if="item.benefits[0].couponCategory==\'904\'"><span style="color: #8e8e8e; font-size: 14px;">价值</span> <div class="text-red" >￥{{item.benefits[0].amount}}</div></div><div class="text-right" v-else><div class="text-red">￥{{item.benefits[0].currentAmount}}</div> <div class="text-through">价值￥{{item.benefits[0].amount}}</div></div></div><div class="right" v-else><span v-if="item.benefits[0].category==\'1017\'">代用币</span><span v-else-if="item.benefits[0].couponCategory==\'901\'">代金券</span><span v-else-if="item.benefits[0].couponCategory==\'903\'">全场折扣</span><span v-else-if="item.benefits[0].couponCategory==\'9011\'">抵扣优惠</span><span v-else>{{item.benefits[0].name}}</span></div><div class="addon"><span class="label"><span v-if="item.start">发红包数</span><span v-else>{{item.name}}</span></span><span class="label1"><span v-if="item.start">第{{item.start}}</span><span v-else>{{item.count}}</span><span v-if="item.end">~{{item.end}}</span>名</span></div></div></div></div>',methods:{couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))}}})}function ads(e){if(e.linkUrl)location.href=e.linkUrl;else switch(e.activityCategory){case"6051":ajaxUrl("raffleActivity.html?aid="+e.id)}}function bindPhone(e,t){$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group").show().html('<div class="bg-green"><div class="title">'+(e||"补全手机 领取权益")+'</div><div class="text">'+(t||"绑定手机号后，您的权益将立即到账")+'</div><input type="tel" placeholder="手机号" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="验证码" id="validate" maxlength="6"/><div class="btn-green" id="submitFn">确定</div><div class="close" onclick="  $(\'.page-group\').hide();$(\'#app\').css(\'overflow\', \'\');"></div></div>'),$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")})}function comment(){prizesFn();new Vue({el:"#app",data:{data:"",post:{content:""},rule:"",stars:{}},beforeCreate:function(){var e=this;rest("/praise/activity/order/"+key_json.oid,{},"get",function(t){if(200==t.code){if(t.result.step<3)return void ajaxUrl("praise.html?pid="+t.result.id);3==t.result.step&&ajaxUrl("prize.html?cid="+t.result.candidateId),$("#loading").addClass("hide"),e.data=t.result,e.stars={text:["吐槽","凑合","一般","满意","很棒"],star:[{id:"cuisine",name:"菜品",check:4,content:new Array(5)},{id:"service",name:"服务",check:4,content:new Array(5)},{id:"surroundings",name:"卫生",check:4,content:new Array(5)}]},t.result.lastWinners&&setTimeout(function(){$("#LastWinners").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100)}else key_json.id?location.href="admin.html#/payment?id="+key_json.id+"&order="+$.fn.cookie("order_id"):location.href="admin.html#/payment?guestid="+key_json.guestid+"&order="+$.fn.cookie("order_id")})},methods:{ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{},"get",function(e){200==e.code&&(_self.rule=e.result,$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group1").show())})},joinFn:function(){var e=this;if(""==this.post.content)this.post.content=null;else if(this.post.content.length<5)return void $.toast("请先填写五个字以上评价");for(var t=0;t<e.stars.star.length;t++)e.post[e.stars.star[t].id]="1005"-e.stars.star[t].check;$.showIndicator(),$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),rest("/praise/comment/"+key_json.oid,this.post,"post",function(e){if(200==e.code){$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden");
var t="from=comment&";if(e.result.praiseId?t="pid="+e.result.praiseId:e.result.commentId&&(t="mid="+e.result.commentId),e.result.needPhone)$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group").show().html('<div class="bg-green"><div class="title"><img src="/sui_assets/img/payment1/success1.svg" style="vertical-align: middle;margin-right: 5px;">提交成功</div><div class="text">'+(e.result.benefit?"验证手机号即获“ "+e.result.benefit+"”<br>成功后可在公众号查看":"")+'</div><input type="tel" placeholder="手机号" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="验证码" id="validate" maxlength="6"/><div class="btn-green" id="submitFn">确定</div><div class="close" onclick="ajaxUrl(\'praise.html?'+t+"')\"></div></div>"),$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var i={};i.phone=$("#tel").val(),i.validateCode=$("#validate").val(),i.commentId=e.result.commentId,rest("/praise/benefits",i,"post",function(i){200==i.code?(e.result.benefit&&$.toast("红包已到账"),ajaxUrl("praise.html?"+t)):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(i.message))})}else $.toast("请输入正确的验证码")});else{var i="";e.result.benefit&&(i='<div class="text">恭喜获得“ '+e.result.benefit+" ”<br>可在公众号查看</div>"),$(".page-group").show().html('<div class="achieve"><div class="title"><img src="/sui_assets/img/payment1/success1.svg" style="vertical-align: middle;margin-right: 5px;">提交成功</div>'+i+'<div class="btn" onclick="ajaxUrl(\'praise.html?'+t+"')\">我知道了</div></div>")}}else alert(e.message),$("#app").css("overflow","")})},couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))}}})}function couponDetail(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/activities/"+("reward"==key_json.type?"reward":"coupon")+"/"+key_json.cid,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):alert(t.message)})},methods:{}})}function praise(){prizesFn();new Vue({el:"#app",data:{data:"",rule:"",time:[]},beforeCreate:function(){var e=this,t="";key_json.pid?t="/praise/"+key_json.pid+"/activity":key_json.mid?t="/praise/comment/"+key_json.mid:key_json.cid&&(t="/praise/activity/candidate/"+key_json.cid),rest(t,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result,t.result.service&&(e.data.stars={text:["吐槽","凑合","一般","满意","很棒"],star:[{id:"cuisine",name:"菜品",check:5-t.result.cuisine.substr(3,1),content:new Array(5)},{id:"service",name:"服务",check:5-t.result.service.substr(3,1),content:new Array(5)},{id:"surroundings",name:"卫生",check:5-t.result.surroundings.substr(3,1),content:new Array(5)}]}),e.$nextTick(function(){function i(){var t=new Date(e.data.lottery.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),n=parseInt(t/1e3/60/60%24,10),s=parseInt(t/1e3/60%60,10),o=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(n)),Vue.set(e.time,2,checkTime(s)),Vue.set(e.time,3,checkTime(o))}if(t.result.lottery){var a=setInterval(i,1e3);t.result.lastWinners&&setTimeout(function(){$("#LastWinners").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100)}if("WXPAY"==version){var n={};n.url=location.href,rest("/auth/sign",n,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){e.data.lottery?(str="老板发狠！",e.data.redEnvelopes&&(str="猛戳领红包！"),str+="多份礼包大派送！你也有机会！"):str="礼轻情意重！猛戳领红包！",wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.shareTitle,desc:str,link:location.origin+"/paymentee.html?pid="+e.data.id+"&guestid="+e.data.brand.guestId,imgUrl:e.data.brand.logo,type:"",dataUrl:"",success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.shareTitle,link:location.origin+"/paymentee.html?pid="+e.data.id+"&guestid="+e.data.brand.guestId,imgUrl:e.data.brand.logo,success:function(){}})})}}),rest("/shop/"+_id+"/mp",{},"get",function(e){e.result&&!e.result.subscribe&&$(".float-icon2").show()})}})):location.href="error.html#5"})},mounted:function(){"comment"==key_json.from&&this.inviteFn()},methods:{inviteFn:function(){if($(".gmadal-black").append("<div id='loading'></div>"),$(".gmodal").show(),$("#htmlCode").html()){var e=new QRCode($("#my-code1"),{width:108,height:108});e.makeCode(this.data.qrCode);var t=$("#htmlCode"),i=t.width(),a=t.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=i*e,t.height=a*e,t.style.width=i*e+"px",t.style.height=a*e+"px";var n=t.getContext("2d");n.scale(e,e),html2canvas($("#htmlCode"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$(".gmadal-black #loading").remove(),$("#img").attr("src",t),$("#htmlCode").remove()}})},100)}else $(".gmadal-black #loading").remove()},ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{},"get",function(e){200==e.code&&(_self.rule=e.result,$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group1").show())})},benefitFn:function(){var e={};return _self=this,this.data.commentId?(e.commentId=this.data.commentId,void rest("/praise/benefits",e,"get",function(e){if(200==e.code)if(e.result.needPhone)bindPhone("领取权益",e.result.benefit?"验证手机号即获“ "+e.result.benefit[0].name+"”<br>成功后可在公众号查看":""),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var t={};key_json.id?t.shopId=_id:t.guestId=_id,t.commentId=_self.data.commentId,t.phone=$("#tel").val(),t.validateCode=$("#validate").val(),rest("/praise/benefits",t,"post",function(t){200==e.code?(e.result&&e.result.token&&$.fn.cookie("token",e.result.token,{expires:30}),$.toast("操作成功"),refresh()):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(t.message?t.message:"请重试"))})}else $.toast("请输入正确的验证码")});else{var t={commentId:_self.data.commentId};rest("/praise/benefits",t,"post",function(e){200==e.code?($.toast("领取成功,红包已发放至您的账户"),setTimeout(function(){refresh()},2e3)):$.toast(e.message)})}})):void $.toast("您没有待领取的红包")},pageFn:function(){var e=this,t={};t.page=this.data.candidaters.page+1,t.count=this.data.candidaters.count,t.praiseId=e.data.id,rest("/praise/candidate",t,"get",function(t){200==t.code&&(e.data.candidaters.page++,e.data.candidaters.items=e.data.candidaters.items.concat(t.result.items))})},directFn:function(){ajaxUrl("upvoters.html?cid="+this.data.candidateId)},biggerFn:function(){$("#my-code2").html("");var e=new QRCode($("#my-code2"),{width:100,height:100});e.makeCode(this.data.qrCode),$(".page-group2").show()},couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))}}})}function setCouponText(e){var t="";return t+=e.name}function upvoters(){new Vue({el:"#app",data:{data:"",data1:"",time:[],state:!1},beforeCreate:function(){var e,t=this;if(key_json.pid)e="/praise/"+key_json.pid+"/supporter";else{if(!key_json.cid)return void alert("当前链接已失效");e="/praise/supporter/"+key_json.cid}rest(e,{},"get",function(e){$("#loading").addClass("hide"),t.data=e.result})},methods:{pageFn:function(){var e=this;if(!(e.data.page>=e.data.pageSize)){var t;key_json.pid?t="/praise/"+key_json.pid+"/supporter":key_json.cid&&(t="/praise/supporter/"+key_json.cid),rest(t,{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}}})}function paymentee(){couponFn(),prizesFn(),app=new Vue({el:"#app",data:{data:"",time:[],rule:"",canvas:"",state:!1,stars:""},beforeCreate:function(){var e=this;rest("/praise/"+key_json.pid+"/activity/support",{},"get",function(t){function i(){var t=new Date(e.data.lottery.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),n=parseInt(t/1e3/60/60%24,10),s=parseInt(t/1e3/60%60,10),o=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(n)),Vue.set(e.time,2,checkTime(s)),Vue.set(e.time,3,checkTime(o))}if(200==t.code){if(3==t.result.step)return void ajaxUrl("prize.html?cid="+t.result.candidateId);if(e.data=t.result,e.data.service&&(e.data.stars={text:["吐槽","凑合","一般","满意","很棒"],star:[{id:"cuisine",name:"菜品",check:5-e.data.cuisine.substr(3,1),content:new Array(5)},{id:"service",name:"服务",check:5-e.data.service.substr(3,1),content:new Array(5)},{id:"surroundings",name:"卫生",check:5-e.data.surroundings.substr(3,1),content:new Array(5)}]}),$("#loading").addClass("hide"),t.result.lottery)var a=setInterval(i,1e3);if("WXPAY"==version){var n={};n.url=location.href,rest("/auth/sign",n,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){e.data.lottery?(str="老板发狠！",e.data.redEnvelopes&&(str="猛戳领红包！"),str+="多份礼包大派送！你也有机会！"):str="礼轻情意重！猛戳领红包！",wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.shareTitle,desc:str,link:location.href,imgUrl:e.data.brand.logo,type:"",dataUrl:"",success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.shareTitle,link:location.href,imgUrl:e.data.brand.logo,success:function(){}})})}})}}else location.href="error.html#5"})},methods:{submitFn:function(){var e=this;rest("/praise/support",{praiseId:key_json.pid},"post",function(t){200==t.code||4050892==t.code?($("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),t.result&&t.result.needPhone?($("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),4050892==t.code?str='<div style="color: black" class="text">'+(t.result.benefit?"抱歉您已超本日助力限制<br>但验证手机号后依旧可获得“ "+t.result.benefit+"”<br>成功后可在公众号查看":"")+"</div>":str='<img src="/sui_assets/img/payment1/success1.svg" style="vertical-align: middle;margin-right: 5px;">'+(e.data.self?"领取成功":"助力成功")+'</div><div class="text">'+(t.result.benefit?"验证手机号即获“ "+t.result.benefit+"”<br>成功后可在公众号查看":"")+"</div>",$(".page-group").show().html('<div class="bg-green"><div class="title">'+str+'<input type="tel" placeholder="手机号" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="验证码" id="validate" maxlength="6"/><div class="btn-green" id="submitFn">确定</div><div class="close" onclick="refresh()"></div></div>'),$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),e.praiseId=key_json.pid,rest("/praise/redEnvelopes",e,"post",function(e){200==e.code?(t.result.benefit&&$.toast("红包已到账"),refresh()):($.hideIndicator(),$("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message))})}else $.toast("请输入正确的验证码")})):(t.result&&t.result.benefit?$.toast('<img src="/sui_assets/img/payment1/bingo.svg" ><div>助力成功！<br>红包已到账</div>'):$.toast('<img src="/sui_assets/img/payment1/bingo.svg" ><div>助力成功！</div>'),setTimeout(function(){refresh()},1500))):(alert(t.message),refresh())})},participantFn:function(){var e=this;return e.data.self?($(".gmadal-black").append("<div id='loading'></div>"),$(".gmadal-black").show(),void($("#htmlCode").html()?(e.canvas={},e.$nextTick(function(){var t=new QRCode($("#my-code1"),{width:108,height:108});t.makeCode(e.data.qrCode);var i=$("#htmlCode"),a=i.width(),n=i.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=a*e,t.height=n*e,t.style.width=a*e+"px",t.style.height=n*e+"px";var i=t.getContext("2d");i.scale(e,e),html2canvas($("#htmlCode"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$("#img").attr("src",t),$("#htmlCode").remove(),$(".gmadal-black #loading").remove()}})},100)})):$(".gmadal-black #loading").remove())):void rest("/praise/lottery",{guestId:this.data.brand.guestId},"post",function(t){return e.data.existPraise?void ajaxUrl("praise.html?pid="+t.result.id):($.toast('<img src="/sui_assets/img/payment1/bingo.svg" ><div>报名成功！</div>'),void setTimeout(function(){ajaxUrl("praise.html?pid="+t.result.id)},2500))})},redirectFn:function(){ajaxUrl("brandStory.html?guestid="+this.data.brand.guestId)},redirect1Fn:function(){ajaxUrl("upvoters.html?cid="+this.data.candidateId)},couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))},benefitFn:function(){$.showIndicator();var e={};return _self=this,e.praiseId=key_json.pid,_self.self?void rest("/praise/redEnvelopes",e,"post",function(e){200==e.code?($.toast("领取成功"),setTimeout(function(){refresh()},2e3)):$.toast(e.message)}):void rest("/praise/redEnvelopes",e,"get",function(e){if(200==e.code)if(e.result.needPhone)bindPhone("领取权益",e.result.benefit?"验证手机号即获“ "+e.result.benefit[0].name+"”<br>成功后可在公众号查看":""),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};key_json.id?e.shopId=_id:e.guestId=_id,e.praiseId=key_json.pid,e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),rest("/praise/redEnvelopes",e,"post",function(e){200==e.code?(e.result&&e.result.token&&$.fn.cookie("token",e.result.token,{expires:30}),$.toast("操作成功"),refresh()):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message?e.message:"请重试"))})}else $.toast("请输入正确的验证码")});else{var t={praiseId:key_json.pid};rest("/praise/redEnvelopes",t,"post",function(e){200==e.code?($.toast("领取成功"),setTimeout(function(){refresh()},2e3)):$.toast(e.message)})}})},pageFn:function(){var e=this,t={};t.page=this.data.candidaters.page+1,t.count=this.data.candidaters.count,t.praiseId=key_json.pid,rest("/praise/candidate",t,"get",function(t){200==t.code&&(e.data.candidaters.page++,e.data.candidaters.items=e.data.candidaters.items.concat(t.result.items))})},directFn:function(){this.data.redEnvelopes&&"1017"!==this.data.redEnvelopes[0].category&&ajaxUrl("couponDetail.html?cid="+this.data.redEnvelopes[0].id)},ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{},"get",function(e){200==e.code&&(_self.rule=e.result,$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group1").show())})}}})}function lottery(){prizesFn(),app=new Vue({el:"#app",data:{data:"",time:[],rule:"",canvas:"",state:!1,stars:""},beforeCreate:function(){var e=this;rest("/praise/activity/guest/"+key_json.guestid,{},"get",function(t){function i(){var t=new Date(e.data.lottery.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),n=parseInt(t/1e3/60/60%24,10),s=parseInt(t/1e3/60%60,10),o=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(n)),Vue.set(e.time,2,checkTime(s)),Vue.set(e.time,3,checkTime(o))}if(200==t.code){if(e.data=t.result,$("#loading").addClass("hide"),t.result.lottery){var a=setInterval(i,1e3);t.result.lastWinners&&setTimeout(function(){$("#LastWinners").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100)}if("WXPAY"==version){var n={};n.url=location.href,rest("/auth/sign",n,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.nickname+"邀您领“"+e.data.brand.brand+"”的红包",desc:"助力好友，领优惠",link:location.href,imgUrl:e.data.brand.logo,type:"",dataUrl:"",success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.nickname+"邀您领“"+e.data.brand.brand+"”的红包",link:location.href,imgUrl:e.data.brand.logo,success:function(){}})})}})}}else location.href="error.html#5"})},methods:{participantFn:function(){this.data.existPraise?ajaxUrl("praise.html?cid="+this.data.candidateId):rest("/praise/lottery",{guestId:this.data.brand.guestId},"post",function(e){200==e.code&&ajaxUrl("praise.html?pid="+e.result.id)})},couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))},pageFn:function(){var e=this;rest("/praise/candidate/"+key_json.guestid,{page:this.data.candidaters.page+1,count:this.data.candidaters.count},"get",function(t){200==t.code&&(e.data.candidaters.page++,e.data.candidaters.items=e.data.candidaters.items.concat(t.result.items))})},ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{},"get",function(e){200==e.code&&(_self.rule=e.result,$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group1").show())})}}})}function timeFormat(e){var t=new Date(e)-new Date;if(!t)return"00天00时00分00秒";var i=parseInt(t/1e3/60/60/24,10),a=parseInt(t/1e3/60/60%24,10),n=parseInt(t/1e3/60%60,10),s=parseInt(t/1e3%60,10);return checkTime(i)+"天"+checkTime(a)+"时"+checkTime(n)+"分"+checkTime(s)+"秒"}function lotteryMy(){app=new Vue({el:"#app",data:{data:"",time:[],rule:"",canvas:"",state:!1,stars:""},beforeCreate:function(){var e=this;rest("/praise/lottery/guest/"+key_json.guestid,{},"get",function(t){200==t.code?(e.data=t.result,$("#loading").addClass("hide")):(alert(t.message),history.back())})},methods:{redirectFn:function(e,t){ajaxUrl(2==t?"praise.html?cid="+e:"prize.html?cid="+e)}}})}function brandStory(){app=new Vue({el:"#app",data:{data:"",time:[],rule:"",canvas:"",state:!1,stars:""},beforeCreate:function(){var e=this;rest("/shop/"+_id+"/brand",{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):(alert(t.message),history.back())})}})}function prize(){couponFn();new Vue({el:"#app",data:{data:"",winners:"",canvas:"",stars:{},rule:""},beforeCreate:function(){key_json.cid=key_json.comment?key_json.comment:key_json.cid;var e=this;rest("/praise/lottery/"+key_json.cid,{},"get",function(t){200==t.code&&($("#loading").addClass("hide"),e.data=t.result)})},methods:{participantFn:function(){_self=this,rest("/praise/lottery",{candidateId:key_json.cid},"post",function(e){if(200==e.code){if(_self.data.existPraise)return void ajaxUrl("praise.html?pid="+e.result.id);$.toast('<img src="/sui_assets/img/payment1/bingo.svg" ><div>报名成功！</div>'),setTimeout(function(){ajaxUrl("praise.html?pid="+e.result.id)},2500)}else alert(e.message)})},benefitFn:function(){var e={};_self=this,e.candidateId=key_json.cid,rest("/praise/benefits",e,"get",function(e){if(200==e.code)if(e.result.needPhone)bindPhone("领取权益",e.result.benefit?"验证手机号即获“ "+e.result.benefit[0].name+"”<br>成功后可在公众号查看":""),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};key_json.id?e.shopId=_id:e.guestId=_id,e.candidateId=key_json.cid,e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),rest("/praise/benefits",e,"post",function(e){200==e.code?(e.result&&e.result.token&&$.fn.cookie("token",e.result.token,{expires:30}),$(".page-group").hide(),$.toast("操作成功"),refresh()):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message?e.message:"请重试"))})}else $.toast("请输入正确的验证码")});else{var t={candidateId:key_json.cid};rest("/praise/benefits",t,"post",function(e){200==e.code?($.toast("领取成功"),setTimeout(function(){refresh()},2e3)):$.toast(e.message)})}})},ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{},"get",function(e){200==e.code&&(_self.rule=e.result,$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group1").show())})},pageFn:function(){var e=this,t={};t.page=this.data.candidaters.page+1,t.count=this.data.candidaters.count,t.candidateId=key_json.cid,rest("/praise/candidate",t,"get",function(t){200==t.code&&(e.data.candidaters.page++,e.data.candidaters.items=e.data.candidaters.items.concat(t.result.items))})}}})}function raffleActivity(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/lottery/activity/"+key_json.aid+"/cover",{},"get",function(t){if(200==t.code){if(3==t.result.step&&ajaxUrl(t.result.id?"raffleResult.html?lid="+t.result.id:"raffleWinners.html?aid="+key_json.aid),t.result.step==-1&&ajaxUrl("raffleWinners.html?aid="+key_json.aid),$("#loading").addClass("hide"),setTitle(t.result.brandName+"大奖免费抽"),e.data=t.result,e.category={901:"simple",9011:"simple",902:"multi",9021:"multi",903:"simple",9031:"simple",904:"multi"},"WXPAY"==version){var i={};i.url=location.href,rest("/auth/sign",i,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.shareTitle,desc:"抢到就是赚到!仅限"+e.data.requirements+"名！大小奖品"+e.data.lottery.awardCount+"份！满额即时开奖",link:location.origin+"/raffleActivity.html?aid="+key_json.aid+(e.data.id?"&lid="+e.data.id:"")+"&guestid="+_id,imgUrl:e.data.logoUrl,type:"",dataUrl:"",success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.shareTitle,link:location.origin+"/raffleActivity.html?aid="+key_json.aid+(e.data.id?"&lid="+e.data.id:"")+"&guestid="+_id,imgUrl:e.data.logoUrl,success:function(){}})})}})}}else location.href="error.html#6"})},methods:{redirectFn:function(){location.href=location.origin+"/raffleActivity1.html"+location.search},couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))}}})}function raffleActivity1(){new Vue({el:"#app",data:{data:{category:{901:"simple",9011:"simple",902:"multi",9021:"multi",903:"simple",9031:"simple",904:"multi"}},applicants:"",sponsors:""},beforeCreate:function(){var e=this;rest("/lottery/guest/"+_id+"/activity/"+key_json.aid,{},"get",function(t){if(200==t.code){if(3==t.result.step&&ajaxUrl("raffleResult.html?lid="+t.result.id),!t.result.enrolled&&t.result.applicants&&rest("/lottery/activity/"+key_json.aid+"/applicants",{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.applicants=t.result):alert(t.message)}),t.result.enrolled&&t.result.inviterBenefit.total&&rest("/lottery/"+t.result.id+"/sponsors",{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.sponsors=t.result):alert(t.message)}),$("#loading").addClass("hide"),setTitle(t.result.brand.brand+"大奖免费抽"),e.data=t.result,e.$nextTick(function(){if(e.data.needSubscribe&&e.data.enrolled)if(e.data.qrCode){var t=new QRCode($("#my-code2"),{width:60,height:60});t.makeCode(e.data.qrCode)}else rest("/lottery/activity/"+key_json.aid+"/invitation",{},"post",function(t){if(200==t.code){e.data.qrCode=t.result.qrCode;var i=new QRCode($("#my-code2"),{width:100,height:100});i.makeCode(e.data.qrCode)}})}),"WXPAY"==version){var i={};i.url=location.href,rest("/auth/sign",i,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage","onMenuShareTimeline"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.onMenuShareAppMessage({title:e.data.shareTitle,desc:"抢到就是赚到!仅限"+e.data.requirements+"名！大小奖品"+e.data.lottery.awardCount+"份！满额即时开奖",link:location.origin+"/raffleActivity.html?aid="+key_json.aid+(e.data.id?"&lid="+e.data.id:"")+"&guestid="+_id,imgUrl:e.data.brand.logo,type:"",dataUrl:"",success:function(){},cancel:function(){}}),wx.onMenuShareTimeline({title:e.data.shareTitle,link:location.origin+"/raffleActivity.html?aid="+key_json.aid+(e.data.id?"&lid="+e.data.id:"")+"&guestid="+_id,imgUrl:e.data.brand.logo,success:function(){}})})}})}}else location.href="error.html#6"})},methods:{submitFn:function(){function e(e){if(!e)return void alert("不支持在线支付");$.showIndicator();var t={};key_json.lid&&(t.lotteryId=key_json.lid),t.activityId=key_json.aid,t.payCategory=e.payMode,t.url=encodeURIComponent(location.href),t.failedUrl=encodeURIComponent(location.href),rest("/lottery/buy",t,"post",function(t){if(200==t.code){$.showIndicator();var i=t.result.orderId;switch($.fn.cookie("order_id",i),e.payMode){case"1005":var a=t.result.js,n=t.result.pay;n.success=function(){$("#pay").removeClass("disabled"),rest("/order/"+i+"/pay/result",{},"get",function(){}),$(".page-group1").show()},n.cancel=function(){cancelPay(),$("#pay").removeClass("disabled"),$.hideIndicator()},n.fail=function(e){cancelPay(),$.hideIndicator(),$("#pay").removeClass("disabled"),alert("支付失败")},a.debug=!1,a.jsApiList=["chooseWXPay"],delete a.url,wx.config(a),wx.chooseWXPay(n);break;case"1101":AlipayJSBridge.call("tradePay",{tradeNO:t.result.pay.tradeNO},function(e){return"6001"==e.resultCode?($("#pay").removeClass("disabled"),void cancelPay()):("9000"==e.resultCode&&($("#pay").removeClass("disabled"),rest("/order/"+i+"/pay/result",{},"get",function(){}),$(".page-group1").show()),void $.hideIndicator())})}}else 405009==t.code?$.confirm("支付遇到问题，是否重新支付？",function(){rest("/order/"+t.result.orderId+"/pay/revoke",{},"post",function(e){200==e.code?_self.submitFn():($("#pay").removeClass("disabled"),alert(e.message))})},function(){$("#pay").removeClass("disabled")}):alert(t.message)})}if(!$(".preloader-indicator-modal").length){if(_self=this,this.data.needPhone)return void this.bindPhone();$("#pay").addClass("disabled"),setPayMode(e)}},bindPhone:function(){_self=this,bindPhone("验证手机号码","为了在您获得大奖后能及时通知<br>请先验证手机号码"),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};e.guestId=_id,e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),rest("/phone/bindup",e,"post",function(e){200==e.code?(e.result&&e.result.token&&$.fn.cookie("token",e.result.token,{expires:30}),$(".page-group").hide(),_self.data.needPhone=!1,$.toast("操作成功"),_self.submitFn()):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message?e.message:"请重试"))})}else $.toast("请输入正确的验证码")})},inviteFn:function(){function e(){if($(".gmadal-black").append("<div id='loading'></div>"),$(".gmodal").show(),$("#htmlCode").html()){var e=new QRCode($("#my-code1"),{width:100,height:100});e.makeCode(t);var i=$("#htmlCode"),a=i.width(),n=i.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=a*e,t.height=n*e,t.style.width=a*e+"px",t.style.height=n*e+"px";var i=t.getContext("2d");i.scale(e,e),html2canvas($("#htmlCode"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$(".gmadal-black #loading").remove(),$("#img").attr("src",t),$("#htmlCode").remove()}})},100)}else $(".gmadal-black #loading").remove()}var t=this.data.qrCode;this.data.qrCode?e():rest("/lottery/activity/"+key_json.aid+"/invitation",{},"post",function(i){200==i.code&&(t=i.result.qrCode,e())})},redirectFn:function(){ajaxUrl("raffleJoin.html?aid="+key_json.aid)},couponDetailFn:function(e,t){ajaxUrl("couponDetail.html?cid="+e+("1017"==t?"&type=reward":""))},applicantsPageFn:function(){var e=this;e.applicants.page>=e.applicants.pageSize||rest("/lottery/activity/"+key_json.aid+"/applicants",{page:++e.applicants.page,count:e.applicants.count},"get",function(t){200==t.code&&(e.applicants.items=e.applicants.items.concat(t.result.items))})},sponsorsPageFn:function(){var e=this;e.sponsors.page>=e.sponsors.pageSize||rest("/lottery/"+key_json.lid+"/sponsors",{page:++e.sponsors.page,count:e.sponsors.count},"get",function(t){200==t.code&&(e.sponsors.items=e.sponsors.items.concat(t.result.items))})}}})}function raffleJoin(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/lottery/activity/"+key_json.aid+"/applicants",{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):(alert(t.message),history.back())})},methods:{pageFn:function(){var e=this;e.data.page>=e.data.pageSize||rest("/lottery/activity/"+key_json.aid+"/applicants",{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}})}function raffles(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/lottery/"+key_json.lid+"/sponsors",{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):(alert(t.message),history.back())})},methods:{pageFn:function(){var e=this;e.data.page>=e.data.pageSize||rest("/lottery/"+key_json.lid+"/sponsors",{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}})}function raffleWinners(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/lottery/guest/"+_id+"/activity/"+key_json.aid+"/winners",{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):location.href="error.html#6"})},methods:{pageFn:function(){var e=this;e.data.page>=e.data.pageSize||rest("/lottery/guest/"+_id+"/activity/"+key_json.aid+"/winners",{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}})}function raffleResult(){couponFn();new Vue({el:"#app",data:{data:"",rule:""},beforeCreate:function(){var e=this;rest("/lottery/"+key_json.lid,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):(alert(t.message),location.href="error.html#6")})},methods:{rafflesFn:function(){ajaxUrl("raffles.html?lid="+key_json.lid)},listFn:function(){ajaxUrl("raffleWinners.html?aid="+this.data.activityId)},ruleFn:function(){_self=this,rest("/lottery/activity/"+this.data.activityId+"/content",{},"get",function(e){200==e.code&&(_self.rule=e.result,$(".page-group1").show(),$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"))})}}})}function userInfo(){rest("/user",{},"get",function(e){function t(e){var t="";switch(e){case"F":t='女士 <span class="F"></span>';break;case"M":t='男士 <span class="M"></span>';break;default:t="保密"}$("#gender .item-after").html(t)}200==e.code&&($(".name").html(e.result.nickname),$(".avatar").attr("src",e.result.avatarUrl),e.result.phone?($.fn.cookie("phone",e.result.phone),$("#phone").attr("onclick","ajaxUrl('changePhone.html')"),$("#phone .item-after").html(e.result.phone+"<span class='text-green'> 修改手机</span>")):($("#set").addClass("round"),"coupon"==key_json.type?(phoneModal(),$(".earn-box1").removeClass("hide")):phoneModal("phone"),$("#phone").addClass("round")),e.result.gender&&t(e.result.gender),e.result.birthday&&($("#birth .item-after").html(e.result.birthday),$("#birth").addClass("has-birth")),$("#gender").click(function(){var t="F"==e.result.gender?2:"M"==e.result.gender?3:4;$.modal({title:"请选择您的性别",afterText:'<div class="text-center" style="font-size: .75rem;line-height: 2"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><div><input type="radio" id="radio1" name="gender" value="F"/> <label for="radio1">女士 <span class="F"></span></label></div><div><input type="radio" id="radio2" name="gender" value="M"/> <label for="radio2">男士 <span class="M"></span></label></div><div><input type="radio" id="radio3" name="gender" value="N"/> <label for="radio3">保密 <span class="N"></span></label></div><div class="btn-green" style="width: 100%;margin: 1rem -1px 0;height: 2rem;line-height: 2rem" id="gender-submit">确认</div><div class="md-close"></div>',extraClass:"bg-green"}),$(".modal-inner .text-center div:nth-child("+t+") input").attr("checked","checked");
}),$("body").on("click","#gender-submit",function(){if($("input:checked").val()){rest("/user",{gender:$("input:checked").val()},"post",function(i){200==i.code?($.closeModal(),$.toast("操作成功!"),e.result.gender=$("input:checked").val(),t($("input:checked").val())):toast(i.message)})}else $.toast("请先选择性别！")}),$.init(),$("#loading").addClass("hide"))})}function brand(){var e={};e.type="WXPAY"==version?"wx":"ali",rest("/activities/guest/"+_id,e,"get",function(e){if(e.result){$("#loading").addClass("hide"),$(".shop").html(e.result.brandName),$("title").html(e.result.brandName);var t=e.result;if(t.cardUrl&&(e.result.cardUrl&&loadImage(e.result.cardUrl,'$(".card-bg").attr("style", "background-image:url(" + url + ")")'),e.result.logo&&loadImage(e.result.logo,'$(".card-content .avatar").attr("src", url)'),$(".card-bg").attr("onclick","ajaxUrl('vip.html')"),$(".set-content").html('<div class="coupon-content"> <div class="right"><span class="iconA"></span></div> </div>'),$(".card-grey").removeClass("hide")),t.activeActivities&&setActivityCode(t.activeActivities),t.checkActivities&&setCheckCode(t.checkActivities),t.topActivity){var i=[t.topActivity];t.topActivity.activityCategory<6005||"6007"==t.topActivity.activityCategory?setActivityCode(i,1):setCheckCode(i,1)}if(t.followActivity){for(var a="",n=t.followActivity,s=n.coupons.length>2?2:n.coupons.length,o=0;o<s;o++)switch(n.coupons[o].category){case"9021":case"902":a+='<div class="food-box">'+n.coupons[o].value+'<span class="pull-right">￥'+n.coupons[o].currentAmount+'<span class="amount" style="font-size: .5rem;"> ￥'+n.coupons[o].amount+"</span></span></div>";break;case"901":a+='<div class="money-box">'+n.coupons[o].name+"</div>";break;case"9011":a+='<div class="discount-box">'+n.coupons[o].name+"</div>";break;case"904":a+='<div class="gift-box">'+n.coupons[o].name+"</div>";break;case"9031":a+='<div class="di-box">'+n.coupons[o].name+"</div>";break;case"903":a+='<div class="di-box">全场'+n.coupons[o].name+"</div>"}$(".separate").html('<div class="follow-card" onclick="ajaxUrl(\'follow.html\')"><div class="follow">'+a+"</div></div>")}$.init(),$("#loading").addClass("hide")}})}function more(){var e={};e.type="WXPAY"==version?"wx":"ali",e.id=_id,rest("/activities/shop",e,"get",function(e){if(e.result){$(".shop").html(e.result.brandName),$("title").html(e.result.brandName);var t=e.result;if(t.cardUrl&&shopId&&(t.cardUrl&&loadImage(t.cardUrl,'$(".card-bg").attr("style", "background-image:url(" + url + ")")'),e.result.logo&&loadImage(e.result.logo,'$(".card-content .avatar").attr("src", url)'),$(".card-bg").attr("onclick","ajaxUrl('vip.html')"),$(".set-content").html('<div class="coupon-content"><div class="right"><span class="iconA"></span></div> </div>'),$(".card-grey").removeClass("hide")),t.activeActivities&&setActivityCode(t.activeActivities),t.checkActivities&&setCheckCode(t.checkActivities),t.topActivity){var i=[t.topActivity];t.topActivity.activityCategory<6005||"6007"==t.topActivity.activityCategory?setActivityCode(i,1):setCheckCode(i,1)}if(t.followActivity){for(var a="",n=t.followActivity,s=n.coupons.length>2?2:n.coupons.length,o=0;o<s;o++)switch(n.coupons[o].category){case"9021":case"902":a+='<div class="food-box">'+n.coupons[o].value+'<span class="pull-right">￥'+n.coupons[o].currentAmount+'<span class="amount" style="font-size: .5rem;"> ￥'+n.coupons[o].amount+"</span></span></div>";break;case"901":a+='<div class="money-box">'+n.coupons[o].value+"元代金券</div>";break;case"9011":a+='<div class="discount-box">'+n.coupons[o].name+"</div>";break;default:a+='<div class="gift-box">'+n.coupons[o].value+"</div>"}$(".separate").html('<div class="follow-card" onclick="ajaxUrl(\'follow.html\')"><div class="">关注本店公众号，即可获专享优惠</div> <div class="follow">'+a+"</div></div>")}$.init(),$("#loading").addClass("hide")}})}function follow(){rest("/activities/follow/guest/"+_id,{},"get",function(e){200!=e.code&&$.modal({title:"",afterText:"<div >您不是本店的新粉丝<br>不能参加此活动哦~<br>我们将带您到活动中心</div>",buttons:[{text:"我知道了",onClick:function(){ajaxUrl("more.html")}}]}),rest("/shop/"+_id+"/mp",{},"get",function(t){if(200==t.code){$("title").html(e.result.brandName);for(var i=e.result,a="",n=i.coupons.length,s=0;s<n;s++)switch(i.coupons[s].category){case"902":case"9021":a+='<div class="food-box"><span class="ellipsis">'+i.coupons[s].value+'</span><span class="pull-right">￥'+i.coupons[s].currentAmount+'<span class="amount" style="font-size: .5rem"> ￥'+i.coupons[s].amount+"</span></span></div>";break;case"901":a+='<div class="money-box">'+i.coupons[s].value+"元代金券</div>";break;case"9011":a+='<div class="discount-box">'+i.coupons[s].name+"</div>";break;default:a+='<div class="gift-box">'+i.coupons[s].value+"</div>"}t.result.subscribe?e.result.existPhone?$(".inner").html('<div class="text-xs">您已关注！快来领取专属好礼！</div><div class="coupon-list">'+a+'</div><div class="phone-box1"><div><img onclick="earn(\''+i.activityId+"','"+i.ruleTupleId+'\')" src="/sui_assets/img/follow/submit.svg" style="width: 3.5rem;margin-top: 1rem"></div>'):($(".inner").html('<div class="text-xs">您已关注！快来领取专属好礼！</div><div class="coupon-list">'+a+'</div><div class="phone-box1" id="bind"><input type="tel" placeholder="请输入手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="输入验证码" id="validate" maxlength="6"/></div><div id="bindPhone" index="'+i.activityId+"&"+i.ruleTupleId+'"><img src="/sui_assets/img/follow/submit.svg" style="width: 3.5rem;margin-top: -.25rem"></div>'),bind()):$(".inner").html('<div class="text-xs">关注本店公众号，即可获专属优惠</div><div class="coupon-list">'+a+'</div><div class="follow-wx"><div> <div>长按关注再领券</div><img src="/sui_assets/img/finger.gif"> </div> <div > <img src="'+t.result.url+'" class="shop_url"> </div> </div>'),$.init(),$("#loading").addClass("hide")}})})}function bind(){$("#loading").addClass("hide"),$(".input-text").click(function(){$(".toast").hasClass("modal-in")||(11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号"))}),$("#bindPhone").off().click(function(){if(!$(".toast").hasClass("modal-in"))if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};key_json.id?e.shopId=_id:e.guestId=_id,e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),rest("/phone/bindup",e,"post",function(e){if(200==e.code)switch($.closeModal(),e.result&&e.result.token&&$.fn.cookie("token",e.result.token,{expires:30}),basicName){case"bind":alert("绑定手机成功，请继续您未完成的操作"),history.go(-1);break;case"follow":earn($("#bindPhone").attr("index").split("&")[0],$("#bindPhone").attr("index").split("&")[1]);break;case"payment":case"orderDetail":$.toast("正在同步您的权益，请稍后",3e3),setTimeout(function(){redirectUrl()},2e3);break;case"userInfo":"coupon"==key_json.type?$.toast("权益已自动发放，请刷新查看",3e3):$.toast("补全手机成功"),location.href=location.href+"&time="+new Date;break;case"strategy":app.data.strategies[_self.key].needValidate=!1,$(".md-close").click(),app.submitFn();break;default:alert("操作成功"),redirectUrl()}else $("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message?e.message:"请重试")})}else 11==$("#tel").val().length?$.toast("请输入正确的验证码"):$.toast("请输入正确的手机号")})}function reuion(){app=new Vue({el:"#bind",data:{data:"",post:{},list:""},beforeCreate:function(){$("#loading").addClass("hide")},methods:{validateFn:function(){_self=this,$(".input-text").hasClass("disabled")||($(".input-text").addClass("disabled"),rest("/membership/"+this.data.id+"/binding/validate",{},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled")}))},searchFn:function(){_self=this,rest("/membership/binding/guest/"+_id,{param:this.post.tel},"get",function(e){200==e.code?_self.data=e.result:(console.log($(document)),$(document).dialog({type:"confirm",titleText:"提示",content:"查询不到您的老系统信息！可能如下原因导致：<br> 1.您输入手机号错误，请检查；<br> 2.您在老系统中的账户权益为0，请在新系统领取新卡即可；<br> 3.其他情况呼叫服务员为您处理。",buttonTextConfirm:"我知道了"}))})},submitFn:function(){return _self=this,6!=this.post.validate.length?void $.toast("请先填写正确的验证码"):void rest("/membership/"+this.data.id+"/binding",{validateCode:this.post.validate},"post",function(e){200==e.code?_self.list=e.result:$.toast(e.message)})},redirectFn:function(){redirectUrl()}}})}function birth(){rest("/user",{},"get",function(e){var t=e.result;t&&$(".name").html(t.nickname),$("input").calendar({maxDate:"2018-01-01",dateFormat:"yyyy-mm-dd",value:["1990-01-01"],onOpen:function(){$(".picker-calendar-year-picker").insertBefore($(".picker-calendar-month-picker"),$(".toolbar-inner"))}}),$(".btn-orange").click(function(){$("input").val()?$.confirm("注意！请填写您的真实生日，生日一旦设置将不可更改！您设置的生日将可能影响您在商家正常行使权益。",function(){rest("/user",{birthday:$("input").val()},"post",function(e){200==e.code?($.toast("操作成功!"),history.back()):toast(e.message)})}):$.toast("请填写生日！")}),$.init(),$("#loading").addClass("hide")})}function control(){function e(){var e="";"c"==key_json.t?(e="902"==dataS.category||"9021"==dataS.category?"<div class='m-title'>恭喜获得价值<span style='color: #ed393a'>"+(dataS.amount-dataS.currentAmount)+"元</span>优惠礼</div>":"901"==dataS.category?"<div class='m-title'>恭喜获得价值<span style='color: #ed393a'>"+dataS.amount+"元</span>优惠礼</div>":"<div class='m-title'>恭喜获得<span style='color: #ed393a'>"+dataS.name+"</span></div>",e+="<div class='coupon-box1'>"+dataS.name+"</div><div style='font-size: 10px;color:#ad1c1b'>"+dataS.times+"</div>"):e="<div class='m-title'>恭喜获得<span style='color: #ed393a'>"+dataS.value+"积分</span></div><div class='point-box1'>"+dataS.value+"积分</div>",rest("/shop/"+_id+"/mp",{},"get",function(t){var i=t.result,a="";i&&i.url&&(a="<div class='addon'><div><img src='"+i.url+"'/></div><div>长按识别<br>查看获赠权益</div></div>"),$.modal({afterText:"<div class='bg-green'><div class='modal-title'>领取成功</div>"+e+"<div class='grey'>下次扫码买单时将【自动使用权益】</div></div>"+a+"<div class='close' onclick=\"window.location.href = location.href + '&time=' + ((new Date()).getTime());\"></div>"})})}function t(e,t){$(e).html(t),setTimeout(function(){$(e).html("")},3e3)}key_json.guestid=key_json.id;var i;"c"==key_json.t?i="coupon":"p"==key_json.t?(i="point",$(".coupon-box").addClass("point")):location.href="error.html#1",rest("/user",{},"get",function(a){a.result.phone&&$(".user").hide(),$.init(),$("#loading").addClass("hide"),$(".new-in .button-fill").click(function(){if(a.result.phone)rest("/benefit/"+i,{id:$(this).attr("id")},"post",function(t){200==t.code?(t.result&&$.fn.cookie("token",t.result.token,{expires:30}),e()):$.toast(t.message)});else{var n=$("#code").val();6!==n.length?t(".title","请填写正确的验证码"):n.length?rest("/benefit/"+i,{phone:$("#phone").val(),id:$(this).attr("id"),validateCode:n},"post",function(i){200==i.code?(i.result&&$.fn.cookie("token",i.result.token,{expires:30}),e()):t(".title",i.message)}):t(".title","请正确填写手机号码！")}})}),rest("/benefit/"+i+"/"+key_json.v,{},"get",function(e){if(200==e.code){var i=e.result;if(dataS=i,setTitle(i.brandName),$("#shop").html(i.brandName),4004==i.state?$(".old-in").removeClass("hide1"):$(".new-in").removeClass("hide1"),"905"==i.category)$("#limits").remove(),$("#coupon").html(i.value+"积分");else{$("#coupon").html(i.name),"902"!=i.category&&"9021"!=i.category||($(".line-through").html("原价 ￥"+i.amount),$(".now").html(" 现价 ￥"+i.currentAmount));var a="";if("901"!=i.category&&"904"!=i.category||(a+='<div class="item"><div class="left">价值：</div><div class="right"> '+i.amount+"元</div></div>"),a+='<div class="item"><div class="left">使用条件：</div><div class="right">'+i.useStrategy+'</div></div><div class="item"><div class="left">有效期：</div><div class="right">'+i.times+'</div></div><div class="item"><div class="left">详情：</div><div class="right">',i.content)for(var n=0;n<i.content.length;n++)a+="<div>"+i.content[n]+"</div>";a+='</div></div><div class="item"><div class="left">备注：</div><div class="right"><div>本券不找零，不兑现，不做外卖使用</div><div>本活动在法律允许范围内商家拥有最终解释权</div></div></div>',$("#limits").html(a)}$(".button-fill").attr("id",i.id)}else alert(e.message);$(".help-btn").click(function(){var e=$("#phone").val();""==e?$.toast("手机号码不能为空！"):/^\s*1\d{10}\s*$/.test(e)?rest("/validate/bindup",{phone:e},"post",function(e){if(200==e.code){$(".help-btn").addClass("disabled"),t(".title","获取成功");var i=90,a=setInterval(function(){return i?($(".help-btn").html("已发送 "+i+" s"),void i--):(clearInterval(a),$(".help-btn").html("重新获取验证码"),void $(".help-btn").removeClass("disabled"))},1e3)}else $.toast(e.message)}):t(".title","请正确填写手机号码")})})}function vipNew(){location.href="admin.html#/vip"+location.search}function vip(){location.href="admin.html#/vip"+location.search}function changePhone(){var e,t=$.fn.cookie("phone");t&&$("#tel").val(t),$.init(),$("#loading").addClass("hide"),$("body").on("click",".code",function(){clearInterval(e),rest("/validate/binded",{},"post",function(t){e=validatePhone(t)})}),$("body").on("click",".submit",function(){clearInterval(e),$(".btn-orange").removeClass("submit"),rest("/phone/binded",{validateCode:$("#code").val()},"post",function(e){200==e.code?($.fn.cookie("validateResult",e.result.validateResult),$("#old").hide(),$("#new").show(),$("#new .btn-orange").addClass("disabled").removeClass("submit").html("收取验证码")):($(".btn-orange").addClass("code").removeClass("submit"),$(".code").html("重新获取验证码"),$.toast(e.message?e.message:"请重试"))})}),$("body").on("input","#new_tel",function(){11==$("#new_tel").val().length?$(".disabled").removeClass("disabled").addClass("code1"):$(".btn-orange").addClass("disabled")}),$("body").on("click",".code1",function(){clearInterval(e),$("#new_code").show();rest("/validate/binding",{phone:$("#new_tel").val()},"post",function(e){if(200==e.code){$("#new_code").show(),$(".btn-orange").addClass("disabled");var t=90;setInterval(function(){t-=1,6==$("#new_code").val().length?($(".btn-orange").addClass("submit1").removeClass("disabled code1"),$(".btn-orange").html("确定")):($(".btn-orange").removeClass("submit1").addClass("code1"),t<=0?($(".btn-orange").removeClass("disabled"),$(".btn-orange").html("重新获取验证码")):($(".btn-orange").addClass("disabled"),$(".btn-orange").html("验证码已发送 "+t+"s")))},1e3)}else $.toast(e.message)})}),$("body").on("click",".submit1",function(){$(".btn-orange").removeClass("submit1");rest("/phone/binding",{phone:$("#new_tel").val(),validateCode:$("#new_code").val(),validateResult:$.fn.cookie("validateResult")},"post",function(e){200==e.code?(alert("成功"),history.go(-1)):$.toast(e.message)})})}function remainder(){function e(e){var t="";for(var i in e.items){var a=$(".hide #record").html();a=a.replace("@date@",e.items[i].date);var n="";for(var s in e.items[i].records){var o=$(".hide #context").html();o="601"==e.items[i].records[s].type?o.replace("@color@",'<span class="text-orange">+@money@</span>'):o.replace("@color@",'<span class="text-blue">-@money@</span>'),o=o.replace("@name@",e.items[i].records[s].content),o=o.replace("@time@",e.items[i].records[s].time),o=o.replace("@money@",e.items[i].records[s].amount),n+=o}a=a.replace("@record@",n),t+=a}$(".set-code").append(t)}var t=$.fn.cookie("relation_id");if(!t)return void history.go(-1);var i,a=1,n=15,s=!1;$("#amount").html($.fn.cookie("charge")||0),rest("/benefit/"+t+"/record/charge",{page:a,count:n},"get",function(t){200==t.code?(t.result&&e(t.result),i=t.result.total,i<=n&&$(".infinite-scroll-preloader").remove(),$.init(),$("#loading").addClass("hide")):($(".infinite-scroll-preloader").remove(),$(".set-code").html('<img src="/assets/images/kong.png" style="width:40%;display:block;position:relative;margin: 20% auto;">'))}),$(document).on("infinite",".infinite-scroll-bottom",function(){s||(s=!0,setTimeout(function(){a*n>=i||(a++,rest("/benefit/"+t+"/record/charge",{page:a,count:n},"get",function(t){t.result&&e(t.result),s=!1,$.refreshScroller()}))},1e3))})}function pointRecord(){function e(e){var t="",i=$(".hide #record").html();for(var a in e.items){var n=i;n=n.replace("@date@",e.items[a].date),n=n.replace("@got@",e.items[a].got||0),n=n.replace("@use@",e.items[a].used||0);var s="";for(var o in e.items[a].records){var r=$(".hide #context").html();r="601"==e.items[a].records[o].type?r.replace("@color@",'<span class="text-orange">+@money@</span>'):r.replace("@color@",'<span class="text-blue">-@money@</span>'),r=r.replace("@name@",e.items[a].records[o].content),r=r.replace("@time@",e.items[a].records[o].time),r=r.replace("@money@",e.items[a].records[o].amount),s+=r}n=n.replace("@record@",s),t+=n}$(".set-code").append(t)}var t=$.fn.cookie("relation_id");t||history.go(-1);var i,a=1,n=20,s=!1;$("#amount").html($.fn.cookie("point")||0),rest("/benefit/"+t+"/record/point",{page:a,count:n},"get",function(t){if(200==t.code){var a=t.result;e(a),i=a.total,i<=n&&$(".infinite-scroll-preloader").remove(),$.init(),$("#loading").addClass("hide")}else $(".infinite-scroll-preloader").remove(),$(".set-code").html('<img src="/assets/images/kong.png" style="width:40%;display:block;position:relative;margin: 20% auto;">')}),$(document).on("infinite",".infinite-scroll-bottom",function(){s||(s=!0,setTimeout(function(){if(a*n>=i)return void $(".infinite-scroll-preloader").remove();a++;rest("/benefit/"+t+"/record/point",{page:a,count:n},"get",function(t){t.result&&e(t.result),s=!1,$.refreshScroller()})},1e3))})}function rewardRecord(){function e(e){var t="",i=$(".hide #record").html();for(var a in e.items){var n=i;n=n.replace("@date@",e.items[a].date),n=n.replace("@got@",e.items[a].got||0),n=n.replace("@use@",e.items[a].used||0);var s="";for(var o in e.items[a].records){var r=$(".hide #context").html();r="601"==e.items[a].records[o].type?r.replace("@color@",'<span class="text-orange">+@money@</span>'):r.replace("@color@",'<span class="text-blue">-@money@</span>'),r=r.replace("@name@",e.items[a].records[o].content),r=r.replace("@time@",e.items[a].records[o].time),r=r.replace("@money@",e.items[a].records[o].amount),s+=r}n=n.replace("@record@",s),t+=n}$(".set-code").append(t)}var t=$.fn.cookie("relation_id");t||history.go(-1);var i,a=1,n=20,s=!1;$.fn.cookie("reward")&&$("#amount").html($.fn.cookie("reward")),rest("/benefit/"+t+"/record/reward",{page:a,count:n},"get",function(t){if(200==t.code){var a=t.result;e(a),i=a.total,i<=n&&$(".infinite-scroll-preloader").remove(),$.fn.cookie("reward")&&$(".am-sticky .text-orange").html($.fn.cookie("reward")),$.init(),$("#loading").addClass("hide")}else $(".infinite-scroll-preloader").remove(),$(".set-code").html('<img src="/assets/images/kong.png" style="width:40%;display:block;position:relative;margin: 20% auto;">')}),$(document).on("infinite",".infinite-scroll-bottom",function(){s||(s=!0,setTimeout(function(){if(a*n>=i)return void $(".infinite-scroll-preloader").remove();a++;rest("/benefit/"+t+"/record/reward",{page:a,count:n},"get",function(t){t.result&&e(t.result),s=!1,$.refreshScroller()})},1e3))})}function activity(){rest("/activities/activity/"+key_json.aid,{},"get",function(e){if(200==e.code){var t=e.result;if(t.get||t.used){var i=t.get||[];i=i.concat(t.used||[]),t.get=i;for(var a=$("#code #get"),n=0;n<t.get.length;n++){var s=a.clone();if(s.find(".am-name").text(t.get[n].name),t.get[n].periods?s.find("#periods .lang").html(t.get[n].periods):s.find("#periods").hide(),t.get[n].shared?s.find("#shared .lang").html(t.get[n].shared):s.find("#shared").hide(),t.get[n].shops?s.find("#shops .lang").html(t.get[n].shops):s.find("#shops").hide(),t.get[n].nonParticipations?s.find("#nonParticipations .lang").html(t.get[n].nonParticipations):s.find("#nonParticipations").hide(),t.get[n].time?s.find("#time .lang").html(t.get[n].time):s.find("#time").hide(),t.get[n].descriptor?s.find("#descriptor .lang").html(t.get[n].descriptor):s.find("#descriptor").hide(),null!=t.get[n].limit){var o="";for(var r in t.get[n].limit){var d=$("#limit-content").html();d=d.replace("@limit@",t.get[n].limit[r]),o+=d}s.find("#limit-content").html(o)}else s.find("#limit").hide();var l="";for(var c in t.get[n].strategy){var u=$("#code #activity-title").html();u=u.replace("@class@",t.get[n].strategy[c].name);var m="",p=t.get[n].strategy[c].details;for(var f in p){var h=$("#code #activity-content").html();if(null!=p[f].content){var v="";for(var g in p[f].content){var y=s.find("#list-name").html();y=y.replace("@content@",p[f].content[g]),v+=y}h=h.replace($("#code #list-name").html(),v)}var b="";if(null!=p[f].coupons)for(var g in p[f].coupons){var k=p[f].coupons[g],x="";"901"==k.category?(x=$("#code #tmp-coupon-charge").html(),x=x.replace("@@name@@",k.name),x=x.replace("@@effectTimes@@",k.times),x=x.replace("@id@",k.id)):"902"==k.category||"9021"==k.category?(x=$("#code #tmp-coupon-consume").html(),x=x.replace("@@name@@",k.name),x=x.replace("@@amount@@",k.amount),x=x.replace("@@currentAmount@@",k.currentAmount?"￥"+k.currentAmount:"免费"),x=x.replace("@@effectTimes@@",k.times),x=x.replace("@id@",k.id)):(x=$("#code #tmp-coupon-charge").html(),x=x.replace("@@name@@",k.name),x=x.replace("@@effectTimes@@",k.times),x=x.replace("@id@",k.id),x=x.replace("代金券","礼品券")),b+=x}h=h.replace($("#code #coupon").html(),b),m+=h}u=u.replace($("#code #activity-content").html(),m),l+=u}s.find("#activity-title").html(l),$(".set_code").append(s),$(".loader-bg").hide()}}$.init(),$("#loading").addClass("hide")}else location.href="error.html#2"})}function reward(){app=new Vue({el:"#app",data:{data:""},beforeCreate:function(){$("#loading").addClass("hide"),_self=this,rest("/benefit/rewards/guest/"+_id,{},"get",function(e){200==e.code&&(_self.data=e.result)}),$.fn.cookie("relation_id")||$(".record").hide(),$.fn.cookie("reward")&&$(".number span").html("￥"+$.fn.cookie("reward"))}})}function mass(){app=new Vue({el:"#app",data:{data:"",type:{901:"本券买单时自动抵用",902:"本券在买单时出示使用",9021:"本券在买单时出示使用",9011:"本券买单时自动抵用",904:"到店出示给服务员即可使用",9031:"到店出示给服务员即可使用",903:"本券买单时自动抵用"}},beforeCreate:function(){_self=this,rest("/mass/guest/"+_id+"/"+key_json.mid,{},"get",function(e){200==e.code?(_self.data=e.result,$("#loading").addClass("hide")):alert(e.message)})},methods:{redirectFn:function(e){e&&(location.href=e)},couponDetailFn:function(e,t){t?ajaxUrl("couponDetail.html?cid="+t+("1017"==e?"&type=reward":"")):redirectUrl()}}})}function phoneModal(e){var t="phone"==e?"补全手机":"补全手机 领取权益";$.modal({title:"<strong>【"+t+"】</strong>",afterText:'<div class="text-xs" style="padding-top: .5rem">绑定手机号后，您的权益将立即到账</div><div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><input type="tel" placeholder="手机号" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="验证码" id="validate" maxlength="6"/></div><div class="btn-green" id="bindPhone">确认</div><div class="md-close"></div>',extraClass:"bg-green"}),bind()}function earnTrue(){var e=!0;if($(window).on("popstate",function(){e=!1}),"channel"==key_json.type)$.modal({title:"操作成功",text:"请在“会员中心”查看权益，使用自助买单可自动抵用优惠。",buttons:[{text:"我的权益",onClick:function(){"WXPAY"==version?rest("/user/guest/"+_id,{},"get",function(e){200!=e.code||e.result.subscribe?redirectUrl():ajaxUrl("success.html")}):redirectUrl()}},{text:"继续买单",bold:!0,onClick:function(){state()}}]});else{var t=this;$.modal({title:"操作成功",text:"请在“会员中心”查看权益，使用自助买单可自动抵用优惠。",buttons:[{text:"返回",onClick:function(){e=!0,window.history.back(-1),t.setTimeout(function(){e&&WeixinJSBridge.call("closeWindow")},300)}},{text:"去会员中心",onClick:function(){redirectUrl("user")}}]})}}function setPayMode(e){rest("/shop/"+_id+"/paymode",{type:version},"get",function(t){if(200==t.code){if(payment=t.result.payMode,$.fn.cookie("payment",JSON.stringify(t.result)),t.result.oasis)return void(location.href=location.origin+"/author/"+_id+"/fuiou?url="+encodeURIComponent(location.href))}else $.fn.cookie("payment","",{expires:0});e&&e(t.result)})}function toast(e){$("body").append("<div class='toast-center'><div class='toast'>"+e+"</div></div>"),setTimeout(function(){$(".toast-center").remove()},3e3)}function validatePhone(e){if(200==e.code){$("#code").show(),$(".btn-orange").addClass("disabled");var t=90,i=setInterval(function(){6==$("#code").val().length?($(".btn-orange").addClass("submit").removeClass("disabled code"),$(".btn-orange").html("确定")):($(".btn-orange").removeClass("submit").addClass("code"),t-=1,t<=0?($(".btn-orange").removeClass("disabled"),$(".btn-orange").html("重新获取验证码")):($(".btn-orange").addClass("disabled"),$(".btn-orange").html("验证码已发送 "+t+"s")))},1e3);return i}$.toast(e.message)}function earn(e,t){var i={activityId:e,ruleTupleId:t},a="/benefit/follow/guest/"+_id;rest(a,i,"post",function(e){200==e.code?($.closeModal(),earnTrue()):$.toast(e.message)})}function refreshCode(){rest("/check/code",{},"get",function(e){200==e.code&&($("#my-code1").html(""),qrcode=new QRCode($("#my-code1"),{width:200,height:200}),qrcode.makeCode(e.result.code))})}function check(){$.showIndicator();var e={},t="/check/shop/"+shopId;key_json.d&&(e={tableId:key_json.d}),rest(t,e,"post",function(e){switch(e.code){case 200:$.fn.cookie("order_id",e.result.orderId),$.fn.cookie("table_no",e.result.tableNo),ajaxUrl("waiting.html");break;case 405004:$("#loading").removeClass("hide"),$.confirm("您在"+(e.result.shopname||"本店"+e.result.tableNo+"号桌")+"有一个买单正在进行中,是否取消？",function(){rest("/check/shop/"+e.result.shopId+"/cancel",{},"post",function(e){200==e.code&&(alert("取消成功！"),check())})}),$("#loading").addClass("hide");break;case 405007:alert("当前桌台有个请求正在处理，请让服务员处理");break;default:alert(e.message)}})}function state(){rest("/check/"+$.fn.cookie("order_id"),{},"get",function(e){if(200==e.code){var t=e.result;1==t.step?t.online?($.fn.cookie("table_no",t.tableNo),ajaxUrl("waiting.html")):$.toast("上宾正在加速为您配置专属优惠方案"):t.state>=2?ajaxUrl("strategy.html?oid="+$.fn.cookie("order_id")):window.location.href=location.href+"&time="+(new Date).getTime()}else redirectUrl("selfPay")})}function setCoupon(e){for(var t=$(".hide .coupon_show"),i=0;i<e.items.length;i++){var a=t.clone(),n=e.items[i];switch(a.attr("id",n.id),a.find(".name").html(n.name),n.category){case"9021":case"902":a.find(".amount0").html("<span style='font-size: .6rem'>可抵 ￥</span>"+(n.amount-n.currentAmount)+'<div class="through">'+n.amount+"</div>");break;case"9031":a.find(".name").html(n.value),a.find(".amount0").html(n.amount+"<span style='font-size: .6rem'> 折</span>");break;case"904":n.amount&&a.find(".amount0").html("<span style='font-size: .6rem'>价值 ￥</span>"+n.amount);break;default:a.find(".amount0").remove()}a.find(".a4001").addClass("a"+n.state),a.find(".addon").html("<span>"+n.times+"</span>"),a.find(".addon").append("<span>"+n.useStrategy+"</span>"),$(".set-coupon").append(a)}$.fn.longPress=function(){for(var e=void 0,t=this,i=0;i<t.length;i++)t[i].addEventListener("touchstart",function(){var t=this;e=setTimeout(function(){document.getElementById(t.id).getElementsByClassName("deletefont")[0].style.display="block"},800)},!1),t[i].addEventListener("touchend",function(t){var i=this;"deletefont"==t.target.classList[0]&&(uri="/benefit/userCoupon/"+$(this).attr("id"),$.showIndicator(),rest(uri,{},"post",function(e){200==e.code?$("#"+i.id).remove():alert("删除失败！")})),clearTimeout(e)},!1)},$(".coupon_show").longPress()}function setCheckCode(e,t){for(var i={6001:"MEMBERUPGRADE",6002:"CHARGE",6003:"EXCHANGE",6004:"COUPONFREE",6005:"DISCOUNT",6006:"SPECIAL_PRICE",6007:"COUPON",6008:"POINT",6012:"SPENDAS",6014:"LIMITREDUCE",6015:"SETMEAL",6017:"CHARGEFREE"},a=0;a<e.length;a++){var n=e[a].activities;if("6007"!=e[a].activityCategory){more=$("#code #more");for(var s=0;s<n.length;s++){var o=n[s],r=i[e[a].activityCategory],d=more.clone();if(d.find(".set-title").addClass(r),0==s&&d.find(".set-title").append($("#code .content-title1").html()),d.find(".text").html(o.name),n.length>1)switch(d.find(".set-title").append($("#code .content-desc1").html()),d.find(".content-desc").html(o.name),d.find(".right").addClass("hide"),e[a].activityCategory){case"6005":d.find(".text").html("会员折扣有力度");break;case"6006":d.find(".text").html("特价促销");break;case"6008":d.find(".text").html("小积分大用处");break;case"6012":d.find(".text").html("抵扣活动");break;case"6014":d.find(".text").html("满额减免");break;case"6015":d.find(".text").html("套餐活动");break;case"6017":d.find(".text").html("充值免单")}var l=$("#code #more").find("li");d.attr("onclick","ajaxUrl('activity.html?aid="+o.activityId+"')");for(var c=0;c<o.strategy.length;c++){var u=o.strategy[c];if(u.coupons)for(var m=0;m<u.coupons.length;m++){var p=u.coupons[m],f=l.clone();f.find(".item-title .name").html(p.value),f.find(".item-title .text-grey .orange-lg").html("￥"+p.currentAmount),f.find(".item-title .text-grey .line-through").html(" ￥"+p.amount),f.find(".item-media").html('<img src="/sui_assets/img/space_coupon.png" class="space"/>'),f.find(".item-after").html(text),d.find("ul").append(f)}else{var f=l.clone();switch(f.find(".item-title .text-grey").html(o.time),r){case"POINT":f.find(".item-media").remove(),u.amount?f.find(".item-title .name").html((u.from?u.from+":":"")+"消费<span class='orange-lg'>"+u.amount+"</span>元积<span class='orange-lg'>"+u.benefit+"</span>分"):f.find(".item-title .name").html((u.from?u.from+"：":"")+"消费即获得<span class='orange-lg'>"+u.benefit+"</span>积分"),u.type&&"1007"==u.type&&f.find(".item-title .name").html(o.limit[0]);break;case"DISCOUNT":f.find(".item-media").remove(),u.amount?f.find(".item-title .name").html((u.from?u.from+"：":"")+"消费满<span class='orange-lg'>"+u.amount+"</span>元 享<span class='orange-lg'>"+u.benefit+"</span>折"):f.find(".item-title .name").html((u.from?u.from+"：":"")+"消费即享<span class='orange-lg'>"+u.benefit+"</span>折");break;case"SPECIAL_PRICE":u.desUrl?f.find(".item-media").html('<img src="'+u.desUrl+'" class="space"/>'):f.find(".item-media").html('<img src="/sui_assets/img/space.png" class="space"/>'),f.find(".item-title .name").html(u.name);break;case"LIMITREDUCE":f.find(".item-media").remove(),f.find(".item-title .name").html((u.from?u.from+"：":"")+"消费每满<span class='orange-lg'>"+u.amount+"</span>元减<span class='orange-lg'>"+u.benefit+"</span>元");break;case"SPENDAS":f.find(".item-media").remove(),f.find(".item-title .name").html((u.from?u.from+"：":"")+"<span class='orange-lg'>"+u.amount+"</span>元可抵<span class='orange-lg'>"+u.benefit+"</span>元消费");break;case"SETMEAL":u.desUrl?f.find(".item-media").html('<img src="'+u.desUrl+'" class="space"/>'):f.find(".item-media").html('<img src="/sui_assets/img/space.png" class="space"/>'),f.find(".item-title .name").html("<span class='orange-lg'>"+u.amount+"</span>套餐现价<span class='orange-lg'>"+u.benefit+"</span>元"),d.attr("onclick","ajaxUrl('mealActivity.html?aid="+o.activityId+"')");break;case"CHARGEFREE":f.find(".item-media").remove(),f.find(".item-title .name").html((u.from?u.from+"：":"")+"充值"+u.amount+"倍免单")}d.find("ul").append(f)}}t?$(".top").html(d):$(".code").append(d)}}else{var h=[e[a]];setActivityCode(h,"6007")}}}function setActivityCode(e,t){var i={6001:"MEMBERUPGRADE",6002:"CHARGE",6003:"EXCHANGE",6004:"COUPONFREE",6005:"DISCOUNT",6006:"SPECIAL_PRICE",6007:"COUPON",6008:"POINT"};if(e)for(var a=e,n=0;n<a.length;n++)for(var s=a[n].activities,o=a[n].activityCategory,r=0;r<s.length;r++){if("6004"==o||"6007"==o){for(var d=0;d<s[r].strategy.length;d++){var l=s[r].strategy[d],c=$("#code #coupons").clone();c.find(".set-title").addClass(i[o]),0==d&&c.find(".set-title").append($("#code .content-title1").html()),s[r].strategy.length>1?(c.find(".set-title").append($("#code .content-desc1").html()),c.find(".content-desc").html(s[r].name),"6004"==o?c.find(".text").html("免费领取礼遇"):c.find(".text").html("消费即送大礼")):c.find(".text").html(s[r].name);var u="";c.find(".text-grey").html(l.from),"6007"==o?(c.find(".btn-green-light").html("买单即享"),c.attr("onclick","ajaxUrl('activity.html?aid="+s[r].activityId+"')")):c.attr("onclick","ajaxUrl('couponActivity.html?aid="+s[r].activityId+"&rid="+l.ruleTupleId+"')");
for(var m=0;m<l.coupons.length;m++){var p=l.coupons[m];switch(p.category){case"901":u=$("#code .money-box").clone(),u.find(".coupon-content").addClass("money-box"),u.find(".name").html(p.value+"元代金券"),u.find(".text-gold").html(p.value);break;case"9021":case"902":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(p.value),u.find(".current-amount").html(p.currentAmount?"￥"+p.currentAmount:"免费"),u.find(".amount").html("￥"+p.amount);break;case"9011":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(p.currentAmount+"元抵"+p.amount+"元"),u.find("img").attr("src","sui_assets/img/card/dikou.svg").css("margin-top","0px");break;case"904":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(p.value);break;case"9031":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(p.value),u.find(".current-amount").html(p.amount+"折");break;case"903":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html("全场"+p.amount+"折"),u.find(".current-amount").html(p.amount+"折")}u.find("ul").append("<li>"+p.times+"</li>"),p.useStrategy&&u.find("ul").append("<li>"+p.useStrategy+"</li>");var f="";l.remainCount?u.find(".limit-label").html("剩"+l.remainCount+"份"):0==l.remainCount?(f="disabled",c.find(".btn-green-light").html("已抢光"),u.find(".limit-label").html("剩 0 份")):u.find(".limit-label").remove(),c[0].className="coupons row no-gutter "+i[o]+" "+f,c.find(".set_coupon").append(u?u.html():"")}1===t?$(".top").append(c):$(".code").append(c)}c=""}else if("6002"==o){var c=$("#code #coupons").clone(),u="";c.find(".set-title").append($("#code .content-title1").html()),c[0].className="coupons row no-gutter "+i[o],c.find(".text").html(s[r].name),c.attr("onclick","redirectUrl('charge');"),u=$("#code .charge-box").clone();for(var h=0;h<s[r].strategy.length;h++){var l=s[r].strategy[h],v=$("#code .charge-content").clone();if(v.find(".name").html(l.amount+"元"),l.benefits)switch(l.benefits[0].type){case"1014":v.find("ul").append("<li>"+(l.benefits[0].amount||0)+"元</li>");break;case"1015":v.find("ul").append("<li>"+l.benefits[0].amount+"积分</li>");break;case"1016":v.find("ul").append("<li>"+l.benefits[0].name+"（"+l.benefits[0].count+"张）</li>")}else v.find(".row").html("充值有礼");u.find(".card1").append(v)}c.find(".text-grey").html(s[r].strategy[0].from),c.find(".btn-green-light").html("立即充值"),c.find(".set_coupon").html(u?u.html():"")}else{var c=$("#code #coupons").clone(),u="";c.find(".set-title").append($("#code .content-title1").html()),c[0].className="coupons row no-gutter "+i[o],c.find(".text").html(s[r].name),c.attr("onclick","redirectUrl('exchange')"),u=$("#code .charge-box").clone();for(var h=0;h<s[r].strategy.length;h++){var v=$("#code .charge-content").clone();if(v.find(".no-gutter").addClass("exchange"),v.find(".name").html(s[r].strategy[h].amount+"积分"),s[r].strategy[h].coupons)for(var g=s[r].strategy[h].coupons,y=0;y<g.length;y++){var b="";b="901"==g[y].category?"元代金券":"902"==g[y].category||"9021"==g[y].category?"抵用券":"礼品券",v.find("ul").append("<li>"+s[r].strategy[h].coupons[y].value+b+"</li>")}else v.find("ul").append("<li>"+s[r].strategy[h].amount+"元</li>");u.find(".card1").append(v)}c.find(".text-grey").html(s[r].strategy[0].from),c.find(".btn-green-light").html("立即兑换"),c.find(".set_coupon").html(u?u.html():"")}t?$(".top").append(c):$(".code").append(c)}}function loadImage(url,callback){var img=new Image;img.src=url,img.onload=function(){eval(callback)}}function redirectUrl(e){$("body").html("");var t="?";e=e?"admin.html#/"+e:"admin.html#/user",2==e.split("?").length&&(t="&"),shopId?(e+=t+"id="+shopId,key_json.d&&(e+="&d="+key_json.d),key_json.cashier&&(e+="&cashier="+key_json.cashier)):e+=t+"guestid="+key_json.guestid,location.href=e,setTimeout(function(){location.href=e},10)}function goto(e){ajaxUrl(e)}function ajaxUrl(e){$("body").html("");var t="?";e||(e=shopId?cashier?"admin.html#/cashier":"admin.html#/selfPay":"admin.html#/user"),2==e.split("?").length&&(t="&"),shopId?(e+=t+"id="+shopId,key_json.d&&(e+="&d="+key_json.d),key_json.cashier&&(e+="&cashier="+key_json.cashier)):(e+=t+"guestid="+key_json.guestid,$.fn.cookie("relation_id")?location.href=e+"&relationid="+$.fn.cookie("relation_id"):""),location.href=e,setTimeout(function(){location.href=e},10)}function socket(){setTimeout(function(){var e,t=$.fn.cookie("user")||localStorage.getItem("userId");if(t){var i="wss://"+location.hostname+"/websocket?id="+t,a=new WebSocket(i);a.onopen=function(){e=setInterval(function(){a.send("1")},3e4)},a.onmessage=function(e){if("success"==e.data)return!1;var t=JSON.parse(e.data);switch(t.orderId&&$.fn.cookie("order_id",t.orderId,{path:"/"}),t.type){case"500000":ajaxUrl("waiting.html");break;case"500042":$.toast("支付完成"),key_json.id?location.href="admin.html#/payment?id="+key_json.id+"&order="+t.orderId:location.href="admin.html#/payment?guestid="+key_json.guestid+"&order="+t.orderId;break;case"500051":alert("买单被取消"),chooseIndex();break;case"500052":alert("pad下线"),chooseIndex();break;case"500053":alert("买单请求超时未处理被取消"),chooseIndex();break;case"500054":ajaxUrl("strategy.html?oid="+t.orderId);break;case"500005":key_json.id?location.href="admin.html#/payment?id="+key_json.id+"&order="+t.orderId:location.href="admin.html#/payment?guestid="+key_json.guestid+"&order="+t.orderId;break;case"500055":ajaxUrl("strategy.html?oid="+t.orderId);break;case"500050":alert("服务员未响应"),chooseIndex()}},a.onclose=function(){setTimeout(function(){refresh()},1e4)},a.onerror=function(){}}},100)}function rest(e,t,i,a){function n(e){var t="037925fa578c4ed98885d7b28ade5462",i=[];if(Object.keys(e).length)for(var a in e)i.push(a);e.timestamp=(new Date).getTime(),i.push("timestamp"),i.sort();var n="",s={};for(var o in i)n+=i[o]+"="+e[i[o]],s[i[o]]=e[i[o]];n+=t;for(var r=hex_md5(n),d="",l=0;l<r.length;l+=2)d+=r.charAt(l);for(var c=1;c<r.length;c+=2)d+=r.charAt(c);return s.signature=d,s}function s(){for(var e="037925fa578c4ed98885d7b28ade5462",t=(new Date).getTime(),i=hex_md5("timestamp="+t+e),a="",n=0;n<i.length;n+=2)a+=i.charAt(n);for(var s=1;s<i.length;s+=2)a+=i.charAt(s);return"timestamp="+t+"&signature="+a}$("#loading").hasClass("hide")&&$.showIndicator(),$.fn.cookie("apikey","6b774cc5eb7d45818a9c7cc0a4b6920f",{expire:30,path:"/"});var o=location.origin+e,r={};"get"==i?r=n(t):(o+="?"+s(),r=JSON.stringify(t)),xh=$.ajax({url:o,data:r,timeout:2e4,type:i,dataType:"json",async:!0,beforeSend:function(e){e.setRequestHeader("Content-Type","application/json")},success:function(e){if($.hideIndicator(),4e5==e.code)location.href="error.html#7";else{if(403e3==e.code)return $("body").html(""),$.fn.cookie("token","",{expires:0}),$.fn.cookie(_id,"false",{expires:0}),$.fn.cookie("url",location.href,{expires:.002}),void ajaxUrl("index.html");if(403060==e.code)return ajaxUrl("bind.html"),void alert("请先绑定手机号");a(e)}},complete:function(e,t){$.hideIndicator(),"timeout"==t&&(alert("请检查您的本地网络"),xh.abort())}})}var key_json={},shopId="",guestId,key="",_id="",version="ALIPAY",stop=1,payment,dataS={};if(location.search){for(var key_str=location.search.substr(1),i=0;i<key_str.split("&").length;i++){var j=key_str.split("&")[i].split("=");key_json[j[0]]=j[1]}key_json.id&&(shopId=key_json.id),key_json.cashier&&(cashier=key_json.cashier),key_json.guestid&&(guestId=key_json.guestid),_id=key_json.id||key_json.guestid,_id||(location.href="error.html"),key_json.token&&$.fn.cookie("token",key_json.token,{expires:7})}else location.href="error.html";$.config={router:!1};var basicName=location.pathname.split(".")[0].split("/")[1];$.fn.cookie("token")||($.fn.cookie("url",location.href,{expires:6e-4}),location.href="index.html"+location.search.split("&state=1")[0]);var ua=window.navigator.userAgent.toLowerCase();"micromessenger"==ua.match(/MicroMessenger/i)?(version="WXPAY",$.fn.cookie("token")&&($.fn.cookie(_id)?($.fn.cookie("url","",{expires:0}),eval(basicName)()):rest("/author/guest/"+_id+"/check",{},"get",function(data){200==data.code?($.fn.cookie(_id,"true",{expires:1}),eval(basicName)(),$.fn.cookie("url","",{expires:0})):403020==data.code?location.href=location.origin+"/author/guest/"+_id+"?url="+encodeURIComponent(location.href.split("&state=1")[0]):($.fn.cookie("url",location.href,{expires:6e-4}),location.href="index.html"+location.search.split("&state=1")[0])}))):($.fn.cookie("url",{expires:0}),eval(basicName)()),$(function(){if(shopId&&"WXPAY"==version&&"praise"!=basicName&&"paymentee"!=basicName&&"raffleActivity1"!=basicName){var e={};e.url=location.href,rest("/auth/sign",e,"post",function(e){if(200==e.code){var t=e.result;t.jsApiList=["hideOptionMenu","closeWindow"],wx.config(t),wx.ready(function(){wx.hideOptionMenu()})}})}if("WXPAY"==version&&"orderDetail"==basicName){var e={};e.url=location.href,rest("/auth/sign",e,"post",function(e){if(200==e.code){var t=e.result;t.jsApiList=["hideOptionMenu","closeWindow"],wx.config(t),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl"]}),wx.hideOptionMenu()})}})}$.fn.longPress=function(e){for(var t=void 0,i=this,a=0;a<i.length;a++)i[a].addEventListener("touchstart",function(i){t=setTimeout(e,800)},!1),i[a].addEventListener("touchend",function(e){clearTimeout(t)},!1)},$("body").on("click",".coupon_show",function(e){if("deletefont"!=e.target.classList[0]){var t,i=$(this);if($(this).attr("index"))ajaxUrl("couponDetail.html?cid="+$(this).attr("index"));else if(t="/benefit/userCoupon/"+$(this).attr("id"),$(this).find(".a4002").length||$(this).find(".a4003").length)return;$.showIndicator(),rest(t,{},"get",function(e){if(200==e.code){var t={901:"本券买单时自动抵用",902:"本券在买单时出示使用",9021:"本券在买单时出示使用",9011:"本券买单时自动抵用",904:"到店出示给服务员即可使用",9031:"到店出示给服务员即可使用",903:"本券买单时自动抵用"},a=e.result,n=$(".popup-coupon");n.length||(n=document.createElement("div"),n.innerHTML='<div class="popup popup-coupon bottom-fx"><div class="liner"><span class="text2"></span><span class="md-close"></span></div><div class="coupon-show-box"><div class="name_add"><div class="name"></div><div class="code"></div><div id="my-code"></div></div></div><div class="coupons-detail"></div>',$(".page-group").append(n),n=$(".popup-coupon")),n.find(".text2").html(t[a.category]),n.find(".name").html(a.name);var s="";"902"!=a.category&&"9021"!=a.category||(s+='<div class="item"><div class="left">价值：</div><div class="right">原价:'+a.amount+"元，现价:"+a.currentAmount+"元</div></div>"),!a.amount||"901"!=a.category&&"904"!=a.category||(s+='<div class="item"><div class="left">价值：</div><div class="right"> '+a.amount+"元</div></div>"),s+='<div class="item"><div class="left">使用条件：</div><div class="right">'+a.useStrategy+("904"!=a.category&&a.countLimit?"<div>每次消费最多可使用"+a.countLimit+"张</div>":"")+'</div></div><div class="item"><div class="left">有效期：</div><div class="right">'+a.times+'</div></div><div class="item"><div class="left">详情：</div><div class="right">';for(var o in a.content)s=s+"<div>"+a.content[o]+"</div>";if(s+='</div></div><div class="item"><div class="left">备注：</div><div class="right"><div>本券不找零，不兑现，不做外卖使用</div><div>本活动在法律允许范围内商家拥有最终解释权</div></div></div>',n.find(".coupons-detail").html(s),n.find(".code").html(a.code||""),$("#my-code").html(""),i.attr("id")&&("902"==a.category||"9021"==a.category||"904"==a.category||"9031"==a.category)){var r=new QRCode($("#my-code"),{width:100,height:100});r.makeCode(a.id)}$.popup(".popup-coupon")}})}}),$("body").on("click",".modal-overlay-visible",function(){$(this).hasClass("popup-overlay")&&($.closeModal(),setTimeout(function(){$(".modal-overlay-visible").removeClass("modal-overlay-visible")},100))}),$("body").on("click",".md-close",function(){"entrance"==basicName?($(".modal").hide(),$(".popup").hide(),$(this).parent().hasClass("liner")||($(".modal-overlay-visible").removeClass("modal-overlay-visible"),$.fn.cookie("limitcoupon","true",{expires:.0034722}))):($.closeModal(),$(".modal-overlay").removeClass("modal-overlay-visible"))})});var interval;