function hex_md5(r){return rstr2hex(rstr_md5(str2rstr_utf8(r)))}function hex_hmac_md5(r,d){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(r),str2rstr_utf8(d)))}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(r){return binl2rstr(binl_md5(rstr2binl(r),8*r.length))}function rstr_hmac_md5(r,d){var n=rstr2binl(r);n.length>16&&(n=binl_md5(n,8*r.length));for(var e=Array(16),t=Array(16),m=0;m<16;m++)e[m]=909522486^n[m],t[m]=1549556828^n[m];var _=binl_md5(e.concat(rstr2binl(d)),512+8*d.length);return binl2rstr(binl_md5(t.concat(_),640))}function rstr2hex(r){try{}catch(d){hexcase=0}for(var n,e=hexcase?"0123456789ABCDEF":"0123456789abcdef",t="",m=0;m<r.length;m++)n=r.charCodeAt(m),t+=e.charAt(n>>>4&15)+e.charAt(15&n);return t}function str2rstr_utf8(r){for(var d,n,e="",t=-1;++t<r.length;)d=r.charCodeAt(t),n=t+1<r.length?r.charCodeAt(t+1):0,55296<=d&&d<=56319&&56320<=n&&n<=57343&&(d=65536+((1023&d)<<10)+(1023&n),t++),d<=127?e+=String.fromCharCode(d):d<=2047?e+=String.fromCharCode(192|d>>>6&31,128|63&d):d<=65535?e+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|63&d):d<=2097151&&(e+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|63&d));return e}function rstr2binl(r){for(var d=Array(r.length>>2),n=0;n<d.length;n++)d[n]=0;for(var n=0;n<8*r.length;n+=8)d[n>>5]|=(255&r.charCodeAt(n/8))<<n%32;return d}function binl2rstr(r){for(var d="",n=0;n<32*r.length;n+=8)d+=String.fromCharCode(r[n>>5]>>>n%32&255);return d}function binl_md5(r,d){r[d>>5]|=128<<d%32,r[(d+64>>>9<<4)+14]=d;for(var n=1732584193,e=-271733879,t=-1732584194,m=271733878,_=0;_<r.length;_+=16){var i=n,f=e,o=t,h=m;n=md5_ff(n,e,t,m,r[_+0],7,-680876936),m=md5_ff(m,n,e,t,r[_+1],12,-389564586),t=md5_ff(t,m,n,e,r[_+2],17,606105819),e=md5_ff(e,t,m,n,r[_+3],22,-1044525330),n=md5_ff(n,e,t,m,r[_+4],7,-176418897),m=md5_ff(m,n,e,t,r[_+5],12,1200080426),t=md5_ff(t,m,n,e,r[_+6],17,-1473231341),e=md5_ff(e,t,m,n,r[_+7],22,-45705983),n=md5_ff(n,e,t,m,r[_+8],7,1770035416),m=md5_ff(m,n,e,t,r[_+9],12,-1958414417),t=md5_ff(t,m,n,e,r[_+10],17,-42063),e=md5_ff(e,t,m,n,r[_+11],22,-1990404162),n=md5_ff(n,e,t,m,r[_+12],7,1804603682),m=md5_ff(m,n,e,t,r[_+13],12,-40341101),t=md5_ff(t,m,n,e,r[_+14],17,-1502002290),e=md5_ff(e,t,m,n,r[_+15],22,1236535329),n=md5_gg(n,e,t,m,r[_+1],5,-165796510),m=md5_gg(m,n,e,t,r[_+6],9,-1069501632),t=md5_gg(t,m,n,e,r[_+11],14,643717713),e=md5_gg(e,t,m,n,r[_+0],20,-373897302),n=md5_gg(n,e,t,m,r[_+5],5,-701558691),m=md5_gg(m,n,e,t,r[_+10],9,38016083),t=md5_gg(t,m,n,e,r[_+15],14,-660478335),e=md5_gg(e,t,m,n,r[_+4],20,-405537848),n=md5_gg(n,e,t,m,r[_+9],5,568446438),m=md5_gg(m,n,e,t,r[_+14],9,-1019803690),t=md5_gg(t,m,n,e,r[_+3],14,-187363961),e=md5_gg(e,t,m,n,r[_+8],20,1163531501),n=md5_gg(n,e,t,m,r[_+13],5,-1444681467),m=md5_gg(m,n,e,t,r[_+2],9,-51403784),t=md5_gg(t,m,n,e,r[_+7],14,1735328473),e=md5_gg(e,t,m,n,r[_+12],20,-1926607734),n=md5_hh(n,e,t,m,r[_+5],4,-378558),m=md5_hh(m,n,e,t,r[_+8],11,-2022574463),t=md5_hh(t,m,n,e,r[_+11],16,1839030562),e=md5_hh(e,t,m,n,r[_+14],23,-35309556),n=md5_hh(n,e,t,m,r[_+1],4,-1530992060),m=md5_hh(m,n,e,t,r[_+4],11,1272893353),t=md5_hh(t,m,n,e,r[_+7],16,-155497632),e=md5_hh(e,t,m,n,r[_+10],23,-1094730640),n=md5_hh(n,e,t,m,r[_+13],4,681279174),m=md5_hh(m,n,e,t,r[_+0],11,-358537222),t=md5_hh(t,m,n,e,r[_+3],16,-722521979),e=md5_hh(e,t,m,n,r[_+6],23,76029189),n=md5_hh(n,e,t,m,r[_+9],4,-640364487),m=md5_hh(m,n,e,t,r[_+12],11,-421815835),t=md5_hh(t,m,n,e,r[_+15],16,530742520),e=md5_hh(e,t,m,n,r[_+2],23,-995338651),n=md5_ii(n,e,t,m,r[_+0],6,-198630844),m=md5_ii(m,n,e,t,r[_+7],10,1126891415),t=md5_ii(t,m,n,e,r[_+14],15,-1416354905),e=md5_ii(e,t,m,n,r[_+5],21,-57434055),n=md5_ii(n,e,t,m,r[_+12],6,1700485571),m=md5_ii(m,n,e,t,r[_+3],10,-1894986606),t=md5_ii(t,m,n,e,r[_+10],15,-1051523),e=md5_ii(e,t,m,n,r[_+1],21,-2054922799),n=md5_ii(n,e,t,m,r[_+8],6,1873313359),m=md5_ii(m,n,e,t,r[_+15],10,-30611744),t=md5_ii(t,m,n,e,r[_+6],15,-1560198380),e=md5_ii(e,t,m,n,r[_+13],21,1309151649),n=md5_ii(n,e,t,m,r[_+4],6,-145523070),m=md5_ii(m,n,e,t,r[_+11],10,-1120210379),t=md5_ii(t,m,n,e,r[_+2],15,718787259),e=md5_ii(e,t,m,n,r[_+9],21,-343485551),n=safe_add(n,i),e=safe_add(e,f),t=safe_add(t,o),m=safe_add(m,h)}return Array(n,e,t,m)}function md5_cmn(r,d,n,e,t,m){return safe_add(bit_rol(safe_add(safe_add(d,r),safe_add(e,m)),t),n)}function md5_ff(r,d,n,e,t,m,_){return md5_cmn(d&n|~d&e,r,d,t,m,_)}function md5_gg(r,d,n,e,t,m,_){return md5_cmn(d&e|n&~e,r,d,t,m,_)}function md5_hh(r,d,n,e,t,m,_){return md5_cmn(d^n^e,r,d,t,m,_)}function md5_ii(r,d,n,e,t,m,_){return md5_cmn(n^(d|~e),r,d,t,m,_)}function safe_add(r,d){var n=(65535&r)+(65535&d),e=(r>>16)+(d>>16)+(n>>16);return e<<16|65535&n}function bit_rol(r,d){return r<<d|r>>>32-d}!function(r){r.extend(r.fn,{cookie:function(d,n,e){var t,m,_,i;return arguments.length>1&&"[object Object]"!==String(n)?(e=r.extend({},e),null!==n&&void 0!==n||(e.expires=-1),"number"==typeof e.expires&&(t=24*e.expires*60*60*1e3,m=e.expires=new Date,m.setTime(m.getTime()+t)),n=String(n),document.cookie=[encodeURIComponent(d),"=",e.raw?n:encodeURIComponent(n),e.expires?"; expires="+e.expires.toUTCString():"",e.path?"; path="+e.path:"",e.domain?"; domain="+e.domain:"",e.secure?"; secure":""].join("")):(e=n||{},i=e.raw?function(r){return r}:decodeURIComponent,(_=new RegExp("(?:^|; )"+encodeURIComponent(d)+"=([^;]*)").exec(document.cookie))?i(_[1]):null)}})}(Zepto);var hexcase=0;
function chooseCity(){rest("/dict/city",{},"get",function(e){if(200==e.code){var t=e.result,i="";for(var a in t)$(".am-padding-sm").append("<a class='box external' href='shops.html"+location.search+"&code="+t[a].code+"&name="+encodeURIComponent(t[a].name)+"'>"+t[a].name+"</a>");$("#city").html(i),$("#total").show()}else toast(e.message)})}function refresh(){window.location.href=location.href+"&time="+(new Date).getTime()}function couponName(e){var t="<div><div style='font-size: .6rem'>"+e.name+"</div>";return t+="<div style='font-size: .5rem;color: #9b9b9b'>"+e.times+"</div></div>"}function addVip(){rest("/remind/guest/"+_id,{},"get",function(e){if(200==e.code){var t="",i={};if(dataS=e,e.result.needPhone){$(".label2").html("您还有权益待领取");var a=0,s=0;for(var o in e.result)"point"!=o&&"reward"!=o||(a++,s++),"coupons"==o&&(a++,s+=e.result[o].length);if(a>1)t='<div class="coupon-gift" style="margin: -1rem 0">惊喜大礼盒包含'+s+"个超值权益哦~</div>";else if(e.result.point)t="<div class='v-item'>"+e.result.point+"积分</div>";else if(e.result.reward)t="<div class='v-reward'><div class='v-item'>"+e.result.reward+"元奖励金</div></div>";else{if(!e.result.coupons){if(e.result.activities&&e.result.activities.length){t+="<div style='height: 8rem;overflow: auto'><img src='/sui_assets/img/vipModal/vip-spit.svg' width='100%'>";for(var n=0;n<e.result.activities.length;n++){var r=e.result.activities[n],d={6001:"升级",6002:"充值",6003:"兑换",6004:"折扣",6005:"打折",6006:"特价",6007:"返券",6008:"积分",6012:"抵扣",6014:"满减",6015:"套餐"};t+='<div class="earn-benefit"><div class="left">'+d[r.category]+"</div>",r.contents.length&&(t+='<div class="right">'+r.contents.join("<br>"),r.time&&(t+="<div class='text-grey'>"+r.time+"</div>"),t+="</div>"),t+="</div>"}t+="</div>",i.extraClass="addVip1"}else i.extraClass="addVip2";return i.afterText='<div class="big-title">您有一张会员卡待领取</div><div class="upgrade-bg" style="background-image: url(\' '+e.result.card+'\')"><img src="'+e.result.logo+'"></div>'+t,i.buttons=[{text:"立即领取",bold:!0,onClick:function(){phoneModal()}}],$.modal(i),void $(".modal").append("<div class='md-close'></div>")}t="<div class='v-coupon'>";for(var l in e.result.coupons)t+="<div class='v-item'>"+couponName(e.result.coupons[l])+"</div>";t+="</div>"}$.modal({afterText:'<img src="'+e.result.picUrl+'" style="height:8rem;width:100%"><div class="modal-content">'+t+"</div>",extraClass:"addVip",buttons:[{text:"立即领取",bold:!0,onClick:function(){phoneModal()}}]}),$(".modal").append("<div class='md-close'></div>")}else rest("/membership",{id:_id},"post",function(e){if(200==e.code){if(e=dataS,$(".phone-box").remove(),$(".earn-box1").remove(),e.result.activities&&e.result.activities.length){t+="<div style='height: 7rem;overflow: auto'><img src='/sui_assets/img/vipModal/vip-spit.svg' width='100%'>";for(var a=0;a<e.result.activities.length;a++){var s=e.result.activities[a],o={6001:"升级",6002:"充值",6003:"兑换",6004:"折扣",6005:"打折",6006:"特价",6007:"返券",6008:"积分",6012:"抵扣",6014:"满减",6015:"套餐"};t+='<div class="earn-benefit"><div class="left">'+o[s.category]+"</div>",s.contents.length&&(t+='<div class="right">'+s.contents.join("<br>"),s.time&&(t+="<div class='text-grey'>"+s.time+"</div>"),t+="</div>"),t+="</div>"}t+="</div>",i.extraClass="addVip1"}else i.extraClass="addVip2";i.afterText='<div class="big-title">恭喜获赠会员卡</div><div class="upgrade-bg" style="background-image: url(\' '+e.result.card+'\')"><img src="'+e.result.logo+'"></div>'+t,i.buttons=[{text:"我知道了",bold:!0,onClick:function(){"selfPay"==basicName?($(".label2").html("new"),app.getCouponsModal()):window.location.href=location.href+"&time="+(new Date).getTime()}}],$.modal(i)}})}else"selfPay"==basicName&&app.getCouponsModal()})}function addVipResult(){var e="";e=dataS.result.memberGradeName?'<div class="big-title">领取成功</div><div class="second-title1">恭喜获赠本店会员卡</div><div class="upgrade-bg" style="background-image: url(\''+dataS.result.card+'\')"><img style="margin-left:1.3rem" src="'+dataS.result.logo+'"></div><div style="padding: 0 0 1rem">请在本店公众号查看您的权益</div>':'<div class="big-title">领取成功</div><div style="font-size: .7rem;padding-top: 2rem">您获得的权益<br>请在本店公众号查询</div>',$.modal({afterText:e,extraClass:"earn-true",buttons:[{text:"我知道了",bold:!0,onClick:function(){"selfPay"==basicName?(app.getCouponsModal(),$(".label2").html("new")):window.location.href=location.href+"&time="+(new Date).getTime()}}]})}function entrance(){if(key_json.t){var e=(new Date).getTime();if(e>key_json.t)return void(location.href="errorTimeOut.html")}$.fn.cookie("t","",{expires:0}),$.fn.cookie("guestid","",{expires:0}),$(".code").html("");var t={};t.type="WXPAY"==version?"wx":"ali",key_json.d&&(t.tableId=key_json.d),rest("/shop/"+shopId,t,"get",function(e){return 200!=e.code?void(location.href="error.html"):("102"!=e.result.checkType&&addVip(),"102"==e.result.checkType&&"self"!==key_json.type?($.fn.cookie("brandName",e.result.brandName+"("+e.result.name+")"),void ajaxUrl("selfPay.html")):(setTitle(e.result.brandName+"("+e.result.name+")"),void rest("/activities/shop/"+shopId,{type:"WXPAY"==version?"wx":"ali"},"get",function(t){if(200==t.code){if($("#loading").addClass("hide"),$.fn.cookie("user",t.result.user.id),t.result.user.avatarUrl&&loadImage(t.result.user.avatarUrl,'$(".addon1 .avatar").attr("src", url)'),t.result.obtaining?$(".earn-box1").removeClass("hide"):t.result.user.phone||$(".phone-box").removeClass("hide"),t.result.topActivity){var i=t.result.topActivity,a=$(".e-card");a.find(".left-img").addClass("b"+i.activityCategory),a.attr("onclick","ajaxUrl('activity.html?aid="+i.activityId+"')");for(var s="",o=i.strategy.length>2?2:i.strategy.length,n=0;n<o;n++){var r=i.strategy[n];switch(r.type){case"1001":s+="<div>"+(r.from?r.from+":":"")+(r.amount?r.amount:"消费即")+"享"+r.benefit+"折</div>";break;case"1002":s+="<div>"+(r.from?r.from+":":"")+(r.amount?"满"+r.amount:"消费即")+"可获得"+r.benefit+"</div>";break;case"1003":s+="<div>"+(r.from?r.from+":":"")+(r.amount?"满"+r.amount:"消费即")+"减"+r.benefit+"</div>";break;case"1004":s+="<div>"+(r.from?r.from+":":"")+(r.amount?r.amount:"消费即")+"抵"+r.benefit+"</div>";break;case"1005":s+="<div>"+(r.from?r.from+":":"")+r.name+" "+r.benefit+" <span class='line-through'>"+r.amount+"</span></div>";break;case"1007":s+="<div>"+(r.from?r.from+":":"")+(r.amount||"")+"积分抵现金"+(r.benefit||"")+"</div>";break;case"1008":s+="<div>"+(r.from?r.from+":":"")+r.amount+"元积"+r.benefit+"分</div>";break;case"1009":s+="<div>"+(r.from?r.from+":":"")+"每满"+r.amount+"元返"+(r.benefit?r.benefit+"</div>":"");break;case"1011":a.attr("onclick","ajaxUrl('couponActivity.html?aid="+i.activityId+"')"),s+="<div>送";break;case"1013":if(a.attr("onclick","ajaxUrl('charge.html')"),s+="<div>"+(r.from?r.from+":":"")+"充"+r.amount+"元",r.benefits){s+="送</div>";for(var d=0;d<r.benefits.length;d++)switch(0!==d&&(s+="，"),r.benefits[d].type){case"1014":s+=r.benefits[d].amount+"元";break;case"1015":s+=r.benefits[d].amount+"积分";break;case"1016":s+=r.benefits[d].name+"("+r.benefits[d].count+"张)"}}else s+="</div>";break;case"1019":a.attr("onclick","ajaxUrl('exchange.html')"),s+="<div>"+(r.from?r.from+":":"")+r.amount+"积分换";break;case"1020":a.attr("onclick","ajaxUrl('mealActivity.html?aid="+i.activityId+"')"),s+="<div>"+(r.from?r.from+":":"")+r.name+" "+r.benefit+"元";break;case"1201":s+="<div>关注送";break;case"1021":a.attr("onclick","ajaxUrl('vip.html')")}if(r.coupons){for(var l=0;l<r.coupons.length;l++)l>0&&(s+=","),s+=r.coupons[l].name;s+="</div>"}}a.find(".right-content").append(s)}else $(".e-card").remove(),$(".addon").css("border-radius","5px");if(t.result.rollingActivities){$(".ad1-text").html("<img src='/sui_assets/img/coupon/2.svg'> "+t.result.rollingActivities[0].name);var c=$(".e-ad1").width();setInterval(function(){c<5-$(".ad1-text").width()&&(c=$(".e-ad1").width()),$(".ad1-text").css("margin-left",c--)},20)}else $(".e-ad1").remove();if(t.result.picUrl?$(".e-black .swiper-wrapper").html('<div class="swiper-slide"><div class="abg" style="background-image:url(\''+t.result.picUrl+"')\"></div> </div>"):$(".e-black .swiper-wrapper").html(""),e.result.order){var u=e.result.order;$.fn.cookie("order_id",u.orderId),u.tableNo?$(".table-no").html(u.tableNo+"桌"):$(".table-no").remove(),key_json.type&&1==u.step?ajaxUrl("waiting.html"):$("#done").show()}else e.result.tableNo?$(".table-no").html(e.result.tableNo+"桌"):$(".table-no").remove(),"102"==e.result.checkType?$(".second-pay").removeClass("hide"):rest("/check/coupons/"+shopId,{},"get",function(t){if(200==t.code){if($(".popup-overlay").addClass("modal-overlay-visible"),setCoupon({items:t.result}),e.result.logo&&loadImage(e.result.logo,'$(".i-flex .avatar").attr("src", url)'),$("#qr").show(),"101"==e.result.checkType){$(".popup-overlay").addClass("modal-overlay-visible");var i=new QRCode($("#my-code1"),{width:200,height:200});i.makeCode(e.result.checkUserCode),$(".send").attr("onclick",'$("#coupons").addClass("up");$("#code").show();socket();$(".popup-overlay").addClass("modal-overlay-visible");$.fn.cookie("limitcoupon", "true", {expires: 0.0034722});'),$(".self-btn").attr("onclick","")}}else if("101"==e.result.checkType){$(".popup-overlay").addClass("modal-overlay-visible"),$(".e-close").addClass("alone").attr("onclick","setBack()");var i=new QRCode($("#my-code1"),{width:200,height:200});i.makeCode(e.result.checkUserCode),$("#code").show(),$(".self-btn").attr("onclick",""),socket()}else $("#ing").show();$.fn.cookie("limitcoupon")&&(/display: block/.test($("#qr").attr("style"))?$("#coupons").addClass("up"):setBack(),$(".popup-overlay").removeClass("modal-overlay-visible"))});if(t.result.couponActivities){for(var m="",v=t.result.couponActivities,c=0;c<v.length;c++){if("6001"==v[c].activityCategory){m='<div class="swiper-slide" onclick="ajaxUrl(\'vip.html\')"><div style="text-align: left" class="bbg"'+(v[c].picUrl?"style=\"background-image:url('"+v[c].picUrl+"')\"":"")+'><div><div><img class="avatar" style="display: inline" src="'+e.result.logo+'">'+e.result.brandName+'</div><div class="i-flex"><div class="left">○'+v[c].name+'</div><div class="right">查看详情</div></div></div></div> </div>'+m;break}for(var p="",h=0;h<v[c].coupons.length;h++)p+="<span style='margin-right: 10px'>○ "+v[c].coupons[h].name+"</span>";m+='<div class="swiper-slide" onclick="ajaxUrl(\'couponActivity.html?aid='+v[c].activityId+'\')"><div class="bg'+c%3+'"'+(v[c].picUrl?"style=\"background-image:url('"+v[c].picUrl+"')\"":"")+'><div><div class="name1">'+v[c].name+'</div> <div class="content1">'+p+"</div></div></div> </div>"}$(".e-black .swiper-wrapper").append(m),$(".e-black").swiper({pagination:".swiper-pagination",paginationClickable:!0,spaceBetween:30,centeredSlides:!0,autoplay:3e3,autoplayDisableOnInteraction:!1})}if(t.result.activityTypes){$(".set-icon").html("");for(var f="",g=t.result.activityTypes.length<3?t.result.activityTypes.length:3,b=0;b<g;b++)f+="<span class='c"+t.result.activityTypes[b]+"'></span>";$(".set-icon").html(f)}$.init(),$.refreshScroller()}else alert(t.message),location.href="error.html"})))})}function setTitle(e){document.title=e;var t=document.createElement("iframe");t.style.display="none",t.onload=function(){setTimeout(function(){t.remove()},9)},document.body.appendChild(t)}function selfPay(){app=new Vue({el:"#app",data:{data:"",view:{},disk:{dish:0,meal:0},visible:{dish:!1,coupon:!1,couponModal:!1,timer:3},post:{},coupons:{},init:{},socketObj:{},swiper:"",bargain:""},beforeCreate:function(){$("#loading").addClass("hide");var e=this,t={};t.type="WXPAY"==version?"wx":"ali",key_json.d&&(t.tableId=key_json.d),rest("/activities/shop/"+shopId+"/check",t,"get",function(t){if(200==t.code){if($.fn.cookie("user",t.result.user.id),e.init=t.result,t.result.order?$.modal({title:"注意",afterText:"您"+(t.result.order.tableNo?"在"+t.result.order.tableNo+"号桌":"")+"有个买单未完成",buttons:[{text:"取消买单",bold:!0,onClick:function(){rest("/check/"+t.result.order.orderId+"/cancel",{},"post",function(i){200!=i.code?($.toast(i.message),403108==i.code?setTimeout(function(){ajaxUrl("strategy.html?oid="+t.result.order.orderId)},2e3):ajaxUrl("entrance.html")):(delete e.init.order,e.init.couponCount&&(delete e.init.couponCount,e.init.existCoupon=!0),addVip())})}},{text:"继续买单",bold:!0,onClick:function(){$.fn.cookie("order_id",t.result.order.orderId),state()}}]}):addVip(),t.result.rollingActivities){$(".e-ad").removeClass("hide"),$(".ad1-text").html("<img src='/sui_assets/img/coupon/2.svg'> "+t.result.rollingActivities[0].name);var i=$(".e-ad1").width();setInterval(function(){i<5-$(".ad1-text").width()&&(i=$(".e-ad1").width()),$(".ad1-text").css("margin-left",i--)},20)}$.init()}else location.href="error.html"})},computed:{number:function(){return this.disk.dish+this.disk.meal},validateDish:function(){return this.data.result.specialDishes?this.data.result.specialDishes.filter(function(e){return e.count>0}):[]},validateMeal:function(){return this.data.result.setmealDishes?this.data.result.setmealDishes.filter(function(e){return e.count>0}):[]}},methods:{updateValue:function(e,t){var i=e.target.value,a=i.trim().slice(0,i.indexOf(".")===-1?i.length:i.indexOf(".")+3);a!==i&&(t?(this.post.amount=Number(a),this.$refs.input.value=Number(a)):(this.post.nonParts=Number(a),this.$refs.input1.value=Number(a)))},closeCouponModal:function(){this.visible.couponModal=!1,$(".a4005").length?this.init.couponCount=$(".a4005").length:(delete this.init.couponCount,this.init.existCoupon=!0)},clear:function(){if(this.data.result.specialDishes)for(var e=0;e<this.data.result.specialDishes.length;e++)this.data.result.specialDishes[e].count=0;if(this.data.result.setmealDishes)for(var t=0;t<this.data.result.setmealDishes.length;t++)this.data.result.setmealDishes[t].count=0;this.disk.dish=0,this.disk.meal=0},cancel:function(e){var t=this;$.confirm("确认放弃后您需要重新出示给店员才可使用",function(){rest("/check/shop/"+shopId+"/coupons/"+e,{},"delete",function(e){200==e.code?t.getCouponData():alert(e.message)})})},socket:function(){var e=this;setTimeout(function(){var t,i="wss://"+location.hostname+"/websocket?id="+e.init.user.id;e.socketObj=websocket=new WebSocket(i),websocket.onopen=function(){t=setInterval(function(){websocket.send("1")},3e4)},websocket.onmessage=function(e){if("success"==e.data)return!1;var t=JSON.parse(e.data);switch(t.orderId&&$.fn.cookie("order_id",t.orderId,{path:"/"}),t.type){case"500100":case"500101":app.getCouponData()}},websocket.onclose=function(){},websocket.onerror=function(){}},3e3)},getDishes:function(){$("input").blur();var e=this;if(e.view.dishes)return e.visible.dish=!0,e.data.result=JSON.parse(JSON.stringify(e.view.dishes)),void(e.disk=JSON.parse(JSON.stringify(e.view.disk)));var t={};this.post.amount&&(t.amount=this.post.amount),rest("/activities/shop/"+shopId+"/dishes",t,"get",function(t){if(e.data=t,200!==e.data.code)return void $.toast("暂无可用的特价菜/套餐");if(e.disk.meal=0,e.disk.dish=0,t.result.setmealDishes)for(var i=0;i<t.result.setmealDishes.length;i++){var a=t.result.setmealDishes[i];a.choosed&&(e.disk.meal+=a.count)}if(t.result.specialDishes)for(var s=0;s<t.result.specialDishes.length;s++){var o=t.result.specialDishes[s];o.choosed&&(e.disk.dish+=o.count)}e.visible.dish=!0})},getCouponData:function(){$("input").blur();var e=this,t={};this.post.amount&&(t.amount=this.post.amount),rest("/check/coupons/"+_id,t,"get",function(t){200==t.code&&(e.coupons=t.result)})},getCoupons:function(){$("input").blur();var e=this,t={};this.post.amount&&(t.amount=this.post.amount),rest("/check/coupons/"+_id,t,"get",function(t){200==t.code&&(e.coupons=t.result,e.visible.couponModal=!0,e.$nextTick(function(){for(var t in e.coupons)if(!$("#code"+t).html()){var i=new QRCode($("#code"+t),{width:100,height:100});i.makeCode(e.coupons[t].id)}$(".swiper-container").swiper({pagination:".swiper-pagination",paginationClickable:!0,slidesPerView:1.3,spaceBetween:30,centeredSlides:!0}),e.socket()}))})},getCouponsModal:function(){if(this.init.couponCount)this.visible.timer=0;else{this.getCoupons(),_self=this;var e=setInterval(function(){_self.visible.timer--,0==_self.visible.timer&&clearInterval(e)},1e3)}},checked:function(){this.visible.checked=!this.visible.checked,this.visible=JSON.parse(JSON.stringify(this.visible))},confirmDish:function(){this.view.amount=this.post.amount,Vue.set(app.view,"dishes",this.data.result),this.view.disk=JSON.parse(JSON.stringify(this.disk)),this.visible.dish=!1,this.visible.checked=!1},plus:function(e){if(this.disk.meal)return void $.toast("对不起，本店特价菜与套餐不可同享。");var t=this.data.result.specialDishes[e];this.data.result.specialDishes[e].count?t.count++:t.count=1,this.disk.dish++,Vue.set(this.data.result.specialDishes,e,t)},reduce:function(e){var t=this.data.result.specialDishes[e];t.count-=1,this.disk.dish--,Vue.set(this.data.result.specialDishes,e,t)},plusMeal:function(e){if(this.disk.dish)return void $.toast("对不起，本店特价菜与套餐不可同享。");var t=this.data.result.setmealDishes[e];this.data.result.setmealDishes[e].count?t.count++:t.count=1,this.disk.meal++,Vue.set(this.data.result.setmealDishes,e,t)},reduceMeal:function(e){var t=this.data.result.setmealDishes[e];t.count-=1,this.disk.meal--,Vue.set(this.data.result.setmealDishes,e,t)},submitFn:function(){if(_self=this,!$(".toast").length){var e=this.data.result;if(!this.post.amount||!parseFloat(this.post.amount))return void $.toast("请先填写消费总额");var t={};if(this.disk.dish){t.specialMap={};for(var i=0;i<e.specialDishes.length;i++)e.specialDishes[i].count&&(t.specialMap[e.specialDishes[i].code]=parseInt(e.specialDishes[i].count))}if(this.disk.meal){t.meals={};for(var a=0;a<e.setmealDishes.length;a++)e.setmealDishes[a].count&&(t.meals[e.setmealDishes[a].code]=parseInt(e.setmealDishes[a].count))}if(t.amount=this.post.amount,$(".checkbox").hasClass("checked")&&this.post.nonParts){if(parseInt(this.post.nonParts)>parseInt(this.post.amount))return void $.toast("不参与金额不得大于总金额");t.nonParticationAmount=this.post.nonParts}key_json.d&&(t.tableId=key_json.d),rest("/check/shop/"+key_json.id+"/autonomy",t,"post",function(e){200==e.code?($.fn.cookie("order_id",e.result.orderId),$.modal({title:"",afterText:"<div class='text-center'><img src='sui_assets/img/selfPay/calculate.gif' style='height: 4.5rem'><p>请稍后<br/>正在为您计算优惠方案</p></div>"}),setTimeout(function(){ajaxUrl("strategy.html?oid="+e.result.orderId)},2e3)):alert(e.message)})}},bargainFn:function(e){e?rest("/bargain/order/"+_self.data.orderId,{},"post",function(e){200==e.code}):rest("/check/calculate/"+_self.data.orderId,{},"post",function(e){200==e.code})}}}),app.$watch("disk",function(e){e.meal+e.dish==0&&(this.visible.checked=!1)},{deep:!0})}function checkTime(e){return e<10&&(e="0"+e),""+e}function grouponInfo(){new Vue({el:"#app",data:{cover:""},beforeCreate:function(){var e=this;rest("/groupon/activity/"+key_json.aid+"/cover",{},"get",function(t){if(200==t.code){$("#loading").addClass("hide"),e.cover=t.result;var i=3;setInterval(function(){1==i&&(e.initFn(),clearInterval(i)),i--,$("#time").html(i)},1e3)}})},methods:{initFn:function(){location.href=location.origin+"/groupon.html"+location.search}}})}function groupon(){var e=new Vue({el:"#app",data:{data:"",view:"",time:[],state:!1},beforeCreate:function(){var e=this;return key_json.aid?void rest("/groupon/activity/"+key_json.aid,{},"get",function(t){function i(){var t=new Date(e.data.activity.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),s=parseInt(t/1e3/60/60%24,10),o=parseInt(t/1e3/60%60,10),n=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(s)),Vue.set(e.time,2,checkTime(o)),Vue.set(e.time,3,checkTime(n))}if(200==t.code){$("#loading").addClass("hide"),setTitle(t.result.brandName+"邀您来砍价"),t.result.groupon&&rest("/groupon/"+t.result.groupon.grouponId+"/record",{},"get",function(t){200==t.code&&(e.view={list:t.result},setTimeout(function(){$("#Marquee_x").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100))}),e.data=t.result;var a=setInterval(i,1e3);if("WXPAY"==version){var s={};s.url=location.href,rest("/auth/sign",s,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl","menuItem:share:timeline"]}),wx.onMenuShareAppMessage({title:"我参加了"+e.data.brandName+"巨惠砍价，快来帮我砍低价",desc:"老板发狠心，只为你满意，大礼滚滚而来",link:e.data.groupon?location.origin+"/groupee.html?gid="+e.data.groupon.grouponId+"&guestid="+key_json.guestid:location.href,imgUrl:e.data.activity.picUrl,type:"",dataUrl:"",success:function(){rest("/groupon/activity/"+key_json.aid+"/invitation",{},"post",function(e){})},cancel:function(){}})})}})}}else alert(t.message),location.href="error.html"}):(alert(location.href),void ajaxUrl("groupee.html?gid="+key_json.id))},methods:{bargainFn:function(){_self=this,rest("/groupon/activity/"+key_json.aid,{},"post",function(e){200==e.code?($.toast("成功砍减"+e.result.amount+"元"),rest("/groupon/activity/"+key_json.aid,{},"get",function(e){200==e.code&&(_self.data=e.result,rest("/groupon/"+e.result.groupon.grouponId+"/record",{},"get",function(e){200==e.code&&(_self.view={list:e.result})}))})):alert(e.message)})},ruleFn:function(){$.showIndicator();var e=this;rest("/groupon/activity/"+key_json.aid+"/content",{},"get",function(t){200==t.code&&(Vue.set(e.view,"rule",t.result),$("#modal").show())})},earnFn:function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},closeFn:function(){$(".gmodal").hide()},buyFn:function(e){ajaxUrl("buy.html?aid="+key_json.aid)},inviteFn:function(){$(".gmadal-black").append("<div id='loading'></div>");var e=this;$(".gmadal-black").show(),$("#canvas").html()?rest("/groupon/activity/"+key_json.aid+"/invitation",{},"post",function(t){200==t.code&&(e.qrcode=t.result,e.$nextTick(function(){var e=new QRCode($("#my-code1"),{width:100,height:100});e.makeCode(t.result.url);var i=$("#canvas"),a=i.width(),s=i.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=a*e,t.height=s*e,t.style.width=a*e+"px",t.style.height=s*e+"px";var i=t.getContext("2d");i.scale(e,e),html2canvas($("#canvas"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$("#img").attr("src",t),$("#canvas").remove(),$(".gmadal-black #loading").remove()}})},100)}))}):$(".gmadal-black #loading").remove()},pageFn:function(){var e=this;e.view.list.page>=e.view.list.pageSize||rest("/groupon/"+this.data.groupon.grouponId+"/record",{page:++e.view.list.page,count:e.view.list.count},"get",function(t){200==t.code&&(e.view.list.items=e.view.list.items.concat(t.result.items))})}}});e.$watch("data.groupon.amount",function(e){console.log(e)},{deep:!0})}function groupee(){new Vue({el:"#app",data:{data:"",view:"",time:[],state:!1},beforeCreate:function(){var e=this;return key_json.gid?void rest("/groupon/"+key_json.gid,{},"get",function(t){function i(){var t=new Date(e.data.activity.endTime)-new Date;if(!t)return void clearInterval(s);var i=parseInt(t/1e3/60/60/24,10),o=parseInt(t/1e3/60/60%24,10),n=parseInt(t/1e3/60%60,10),r=parseInt(t/1e3%60,10);Vue.set(e.time,0,a(i)),Vue.set(e.time,1,a(o)),Vue.set(e.time,2,a(n)),Vue.set(e.time,3,a(r))}function a(e){return e<10&&(e="0"+e),""+e}if(200==t.code){if($("#loading").addClass("hide"),e.data=t.result,setTitle(t.result.brandName),1==t.result.self)return void ajaxUrl("groupon.html?aid="+t.result.activity.activityId);rest("/groupon/"+key_json.gid+"/record",{},"get",function(t){200==t.code?(e.view={list:t.result},setTimeout(function(){$("#Marquee_x").Marquee({marquee:"y",speed:50,margin_bottom:"5px"})},100)):$(".infinite-scroll-preloader").remove()});var s=setInterval(i,1e3);if("WXPAY"==version){var o={};o.url=location.href,rest("/auth/sign",o,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl","menuItem:share:timeline"]}),wx.onMenuShareAppMessage({title:"我参加了"+e.data.brandName+"巨惠砍价，快来帮我砍低价",desc:"老板发狠心，只为你满意，大礼滚滚而来",link:location.href,imgUrl:e.data.activity.picUrl,type:"",dataUrl:"",success:function(){},cancel:function(){}})})}})}}else alert(t.message),location.href="error.html"}):void alert("no")},methods:{bargainFn:function(){var e=this;rest("/groupon/"+key_json.gid,{},"post",function(t){200==t.code?($.toast("成功砍减"+t.result.amount+"元"),rest("/groupon/"+key_json.gid,{},"get",function(t){200==t.code&&(e.data=t.result,rest("/groupon/"+key_json.gid+"/record",{},"get",function(t){200==t.code&&(e.view={list:t.result})}))})):405015==t.code?($("#my-code2").html()||(qrcode=new QRCode($("#my-code2"),{width:140,height:140}),qrcode.makeCode(t.result.url)),$("#qrcode").show()):alert(t.message)})},ruleFn:function(){var e=this;$.showIndicator(),rest("/groupon/activity/"+e.data.activity.activityId+"/content",{},"get",function(t){200==t.code?(Vue.set(e.view,"rule",t.result),$("#modal").show()):alert(t.message)})},earnFn:function(){$.showIndicator(),ajaxUrl("buyRecord.html?aid="+this.data.activity.activityId)},closeFn:function(){$(".gmodal").hide()},buyFn:function(e){ajaxUrl("buy.html?aid="+this.data.activity.activityId+"&gid="+key_json.gid)},restartFn:function(){ajaxUrl("groupon.html?aid="+this.data.activity.activityId)},pageFn:function(){var e=this;e.view.list.page>=e.view.list.pageSize||rest("/groupon/"+this.data.groupon.grouponId+"/record",{page:++e.view.list.page,count:e.view.list.count},"get",function(t){200==t.code&&(e.view.list.items=e.view.list.items.concat(t.result.items))})}}})}function buy(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){$("#loading").addClass("hide");var e=this,t={};key_json.gid&&(t.grouponId=key_json.gid),rest("/groupon/"+key_json.aid+"/buy",t,"get",function(t){200==t.code?e.data=t.result:history.back()})},methods:{buyFn:function(e){function t(){var e={activityId:key_json.aid,url:encodeURIComponent(location.href),failedUrl:encodeURIComponent(location.href)};if(payment)e.payCategory=payment;else if(i.data.amount>0)return void alert("暂无可支持的方式");key_json.gid&&(e.grouponId=key_json.gid),rest("/groupon/buy",e,"post",function(e){if(200!=e.code)return alert(e.message),void $.hideIndicator();if(0==i.data.amount)return $("#succed").show(),void setTimeout(function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},1500);var t=e.result.orderId;if(e.result.url)return void(location.href=e.result.url);switch(payment){case"1005":var a=e.result.js,s=e.result.pay;s.success=function(){$.hideIndicator(),$(".pay-fixed").hide(),$("#succed").show(),setTimeout(function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},1500)},s.cancel=function(){$.hideIndicator(),rest("/groupon/buy/"+t+"/cancel",{},"post",function(){})},s.fail=function(e){$.hideIndicator(),rest("/groupon/buy/"+t+"/cancel",{},"post",function(){}),alert("支付失败")},a.debug=!1,a.jsApiList=["chooseWXPay"],delete a.url,wx.config(a),wx.ready(function(){wx.chooseWXPay(s)});break;case"1101":AlipayJSBridge.call("tradePay",{tradeNO:e.result.pay.tradeNO},function(e){return"6001"==e.resultCode?void rest("/groupon/buy/"+t+"/cancel",{},"post",function(){}):("9000"==e.resultCode&&($.hideIndicator(),$(".pay-fixed").hide(),$("#succed").show(),setTimeout(function(){ajaxUrl("buyRecord.html?aid="+key_json.aid)},1500)),void $.hideIndicator())})}})}$.showIndicator();var i=this;return 0==i.data.amount?void t():void setPayMode(t)},closeFn:function(){$(".gmodal").hide()}}})}function buyRecord(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){$("#loading").addClass("hide");var e=this;rest("/groupon/"+key_json.aid+"/buy/record",{},"get",function(t){200==t.code&&(e.data=t.result,"WXPAY"==version&&rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;t.subscribe||loadImage(t.url,'$(".shop_url").attr("src", url);$("#addon").attr("style","justify-content: center;-webkit-justify-content: center;display:flex")')}))})},methods:{pageFn:function(){var e=this;e.data.page>=e.data.pageSize||rest("/groupon/"+key_json.aid+"/buy/record",{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}})}function checkbox(){$(".checkbox").toggleClass("checked"),$("#checkbox").toggleClass("hide")}function mealDetail(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/activities/activity/"+key_json.aid+"/setmeal/"+key_json.rid,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):alert(t.message)})},methods:{}})}function mealActivity(){rest("/activities/setmeal/"+key_json.aid,{},"get",function(e){if(200==e.code){var t=e.result;t.remainCount&&$(".relative-label").html("剩"+t.remainCount+"份"),$(".coupon-name").html(t.name);for(var i=0;i<t.strategy.length;i++){var a=t.strategy[i],s=$(".hide .item").clone();s.attr("onclick","ajaxUrl('mealDetail.html?aid="+a.activityId+"&rid="+a.ruleTupleId+"')"),a.desUrl&&s.find(".m-bg").attr("style","background-image:url("+a.desUrl+")"),a.from&&s.find(".i-grade").html("<span>"+a.from+"可参加</span>"),s.find(".m-bg .m-title").html(a.name),a.content&&s.find(".m-content .m-title").html(a.content[0]),s.find(".text-orange").html("￥"+a.benefit),s.find(".amount").html("￥"+a.amount),$(".set-coupon").append(s)}$("#loading").addClass("hide")}})}function user(){rest("/benefit/guest/"+_id,{},"get",function(e){var t=e.result;if($.fn.cookie("user",t.id),t.obtaining?($("#set").addClass("round").attr("onclick","ajaxUrl('userInfo.html?type=coupon')"),$(".earn-box1").removeClass("hide")):t.phone||($("#set").addClass("round").attr("onclick","ajaxUrl('userInfo.html?type=phone')"),$(".phone-box").removeClass("hide")),$.fn.cookie("phone",t.phone||""),$(".shop").html(t.brandName),$("title").html(t.brandName),t.logoUrl&&loadImage(t.logoUrl,'$(".avatar").attr("src", url)'),t.order&&($(".i-border .item:nth-child(1)").attr("style","width:50%"),$(".i-border .item:nth-child(2)").attr("style","width:50%"),$(".i-border .item:nth-child(3)").remove(),$(".order").show(),$.fn.cookie("order_id",e.result.order.orderId)),"9001"==t.relationType?(t.card&&loadImage(t.card,'$(".i-card").attr("style", "background-image:url(" + url + ")")'),$(".i-footer").html("<div class='set-content'><div style='font-size: .7rem'>"+t.memberGradeName+"</div><div>"+t.memberCardNo+"</div></div><div><span class='iconA'></span></div>"),$(".set-content").attr("style","padding-left:10px"),$(".i-card").attr("onclick","ajaxUrl('vip.html')"),$(".i-title").remove()):t.memberUpgrade?(t.card&&loadImage(t.card,'$(".i-card").attr("style", "background-image:url(" + url + ")")'),$(".set-content").html(""),$(".i-card").attr("onclick","ajaxUrl('vip.html')")):t.existMemberRule||$(".i-bg").hide(),$(".charge").html(t.charge||0),$(".point").html(t.point||0),t.coupon){$("#count").html(t.coupon.total);var i=1,a=t.coupon.count,s=!1,o=t.coupon.total;$(".set-coupon").html(""),setCoupon(t.coupon),o<=a&&$(".infinite-scroll-preloader").remove(),$(document).on("infinite",".infinite-scroll-bottom",function(){s||(s=!0,setTimeout(function(){return i*a>=o?($(".infinite-scroll-preloader").remove(),void $(".set-coupon").append("<div class='text-grey' style='text-align: center;padding: 1rem 0'>——没有更多了——</div>")):(i++,rest("/benefit/coupons/guest/"+_id,{page:i,count:a},"get",function(e){e.result&&setCoupon(e.result)}),s=!1,void $.refreshScroller())},1e3))})}else $(".infinite-scroll-preloader").remove();addVip(),$.init(),$("#loading").addClass("hide")})}function my(){rest("/benefit/guest/"+_id,{},"get",function(e){var t=e.result;if(t.phone||phoneModal(),$.fn.cookie("phone",t.phone||""),$(".shop").html(t.brandName),setTitle(t.brandName),t.obtaining?$(".earn-box1").removeClass("hide"):t.phone||$(".phone-box").removeClass("hide"),"9001"==t.relationType?(t.card&&loadImage(t.card,'$(".i-card").attr("style", "background-image:url(" + url + ")")'),t.logoUrl&&loadImage(t.logoUrl,'$(".avatar").attr("src", url)'),$(".i-footer").html("<div class='set-content' ><div style='font-size: .7rem'>"+t.memberGradeName+"</div><div>"+t.memberCardNo+"</div></div><div><span class='iconA'></span></div>"),$(".set-content").attr("style","padding-left:10px"),$(".i-card").attr("onclick","ajaxUrl('vip.html')"),$(".i-title").remove()):$(".i-bg").hide(),$(".charge").html(t.charge||0),
$(".point").html(t.point||0),t.coupon){var i=1,a=t.coupon.count,s=!1,o=t.coupon.total;$("#count").html(t.coupon.total),$(".set-coupon").html(""),setCoupon(t.coupon),o<=a&&$(".infinite-scroll-preloader").remove(),$(document).on("infinite",".infinite-scroll-bottom",function(){s||(s=!0,setTimeout(function(){return i*a>=o?void $(".infinite-scroll-preloader").remove():(i++,rest("/benefit/coupons/guest/"+_id,{page:i,count:a},"get",function(e){e.result&&setCoupon(e.result)}),s=!1,void $.refreshScroller())},1e3))})}else $(".infinite-scroll-preloader").remove();$.init(),$("#loading").addClass("hide")})}function face(){rest("/check/code",{},"get",function(e){200==e.code?($("#my-code1").html()||(qrcode=new QRCode($("#my-code1"),{width:200,height:200}),qrcode.makeCode(e.result.code)),$("#loading").addClass("hide"),socket()):history.back(),$.init()})}function activityDetail(){function e(){$.showIndicator(),rest("/benefit/obtain/guest/"+_id,{activityId:key_json.aid},"post",function(e){switch(e.code){case 200:earnTrue();break;case 405017:alert(e.message),ajaxUrl(key_json.guestid?"more.html":"entrance.html");break;case 405015:rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;$.modal({title:"<strong>关注本店公众号<br/>才可参与本活动</strong>",afterText:'<div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><div class=""><img style="width: 68%;min-height: 8rem" src="'+t.url+'"></div><div class="text-grey" style="padding: 1rem 0 .5rem">长按二维码关注</div><img src="/sui_assets/img/finger.gif"><div class="md-close"></div></div>',extraClass:"bg-green"})});break;default:$.toast(e.message)}$.hideIndicator()})}rest("/activities/activity/"+key_json.aid+"/coupon",{},"get",function(e){if(200==e.code){$("title").html(e.result.brandName),e.result.logo&&loadImage(e.result.logo,'$(".avatar").attr("src", url)'),e.result.existPhone||($("#bind").show(),$("#phone").hide(),$(".strength").show()),e.result.remainCount&&$(".relative-label").html("剩"+e.result.remainCount+"份"),$(".coupon-name").html(e.result.name),$(".set-coupon").html("");for(var t=e.result.cells,i=0;i<t.length;i++)for(var a=0;a<t[i].coupons.length;a++){var s=t[i].coupons[a],o=$(".hide .coupon_show").clone();switch(o.attr("index",s.id),0==a?o.find(".i-grade").html("<span>"+t[i].name+"尊享</span>"):o.find(".i-grade").remove(),s.category){case"902":case"9021":o.find(".i-uncoupon").addClass("dui"),o.addClass("more"),o.find(".follow-box").append(' <div class="right"> <div class="currentAmount" style="font-weight: 700">'+(s.currentAmount?"￥"+s.currentAmount:"免费")+'</div> <div class="amount" style="font-size: .5rem">￥'+s.amount+"</div> </div>");break;case"903":o.find(".i-uncoupon").addClass("di"),o.addClass("more");break;case"904":o.find(".i-uncoupon").addClass("gift1")}"902"==s.category||"9021"==s.category||"904"==s.category,s.useStrategy&&o.find(".follow-box .left").append("<div>"+s.useStrategy+"</div>"),s.effectTimes&&o.find(".follow-box .left").append("<div>"+s.effectTimes+"</div>"),o.find(".text-lg").html(s.name),$(".set-coupon").append(o)}if($("#time").html(e.result.time||"不限"),e.result.limit){var n="";for(var r in e.result.limit)n+="<li>"+e.result.limit[r]+"</li>";$("#content").html(n)}}else alert(e.message);$.init(),$("#loading").addClass("hide")});var t;$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){var i=90;t=setInterval(function(){return i--,i?void $(".input-text").html("已发送 "+i+" s"):(clearInterval(t),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#bindPhone").off().click(function(){11==$("#tel").val().length&&6==$("#validate").val().length?$(this).hasClass("disabled")||($(this).addClass("disabled"),rest("/phone/bindup",{phone:$("#tel").val(),validateCode:$("#validate").val()},"post",function(i){200==i.code?(i.result&&i.result.token&&$.fn.cookie("token",i.result.token,{expires:7,path:"/"}),e()):($("#validate").val(""),clearInterval(t),$(".input-text").removeClass("disabled").html("重新获取验证码"),$.toast(i.message),$(this).removeClass("disabled"))})):$.toast("输入框不能为空")}),$("body").on("click",".earnCoupon",function(){e()})}function couponActivity(){function e(){$.showIndicator(),rest("/benefit/obtain/guest/"+_id,{activityId:key_json.aid},"post",function(e){switch(e.code){case 200:earnTrue();break;case 405017:alert(e.message),ajaxUrl(key_json.guestid?"more.html":"entrance.html");break;case 405015:rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;$.modal({title:"<strong>关注本店公众号<br/>才可参与本活动</strong>",afterText:'<div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><div class=""><img style="width: 68%;min-height: 8rem" src="'+t.url+'"></div><div class="text-grey" style="padding: 1rem 0 .5rem">长按二维码关注</div><img src="/sui_assets/img/finger.gif"><div class="md-close"></div></div>',extraClass:"bg-green"})});break;default:$.toast(e.message)}$.hideIndicator()})}rest("/activities/activity/"+key_json.aid+"/coupon",{},"get",function(e){if(200==e.code){$("title").html(e.result.brandName),e.result.logo&&loadImage(e.result.logo,'$(".avatar").attr("src", url)'),e.result.existPhone||($("#bind").show(),$("#phone").hide(),$(".strength").show()),e.result.remainCount&&$(".relative-label").html("剩"+e.result.remainCount+"份"),$(".coupon-name").html(e.result.name),$(".set-coupon").html("");for(var t=e.result.cells,i=0;i<t.length;i++)for(var a=0;a<t[i].coupons.length;a++){var s=t[i].coupons[a],o=$(".hide .coupon_show").clone();switch(o.attr("index",s.id),0==a?o.find(".i-grade").html("<span>"+t[i].name+"尊享</span>"):o.find(".i-grade").remove(),s.category){case"9021":case"902":o.find(".i-uncoupon").addClass("dui"),o.addClass("more"),o.find(".follow-box").append(' <div class="right"> <div class="currentAmount" style="font-weight: 700">'+(s.currentAmount?"￥"+s.currentAmount:"免费")+'</div> <div class="amount" style="font-size: .5rem">￥'+s.amount+"</div> </div>");break;case"903":o.find(".i-uncoupon").addClass("di"),o.addClass("more");break;case"904":o.find(".i-uncoupon").addClass("gift1")}"902"==s.category||"9021"==s.category||"904"==s.category,s.useStrategy&&o.find(".follow-box .left").append("<div>"+s.useStrategy+"</div>"),s.effectTimes&&o.find(".follow-box .left").append("<div>"+s.effectTimes+"</div>"),o.find(".text-lg").html(s.name),$(".set-coupon").append(o)}if($("#time").html(e.result.time||"不限"),e.result.limit){var n="";for(var r in e.result.limit)n+="<li>"+e.result.limit[r]+"</li>";$("#content").html(n)}}else alert(e.message);$.init(),$("#loading").addClass("hide")});var t;$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){var i=90;t=setInterval(function(){return i--,i?void $(".input-text").html("已发送 "+i+" s"):(clearInterval(t),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#bindPhone").off().click(function(){11==$("#tel").val().length&&6==$("#validate").val().length?$(this).hasClass("disabled")||($(this).addClass("disabled"),rest("/phone/bindup",{phone:$("#tel").val(),validateCode:$("#validate").val()},"post",function(i){200==i.code?(i.result&&i.result.token&&$.fn.cookie("token",i.result.token,{expires:7,path:"/"}),e()):($("#validate").val(""),clearInterval(t),$(".input-text").removeClass("disabled").html("重新获取验证码"),$.toast(i.message),$(this).removeClass("disabled"))})):$.toast("输入框不能为空")}),$("body").on("click",".earnCoupon",function(){e()})}function success(){"fail"==key_json.type&&$(".success").addClass("fail"),rest("/shop/"+_id+"/mp",{},"get",function(e){var t=e.result;setTitle(t.name),t&&t.url?$(".wx-img img").attr("src",t.url):$(".direct-content").hide()}),$.init(),$("#loading").addClass("hide")}function waiting(){socket();var e=$.fn.cookie("order_id");e||(alert("订单不存在"),ajaxUrl("entrance.html")),rest("/check/coupons/"+_id,{},"get",function(e){200==e.code&&(setCoupon({items:e.result}),$("#coupon").show())}),$.init(),$("#loading").addClass("hide"),rest("/check/"+e,{},"get",function(e){function t(){var e=[];e[0]=Math.floor(a%60),e[1]=Math.floor(a%3600/60),e[2]=Math.floor(a/3600);for(var t=0;t<3;t++)e[t]<10&&(e[t]="0"+e[t]);$(".clark").html(e[2]+" : "+e[1]+" : "+e[0]),a+=1}if(200!=e.code)return void history.back();if(1!=e.result.step)return void state();var i=e.result,a=i.times||0;setInterval(t,1e3)}),$(".cancel").click(function(){$.closeModal(),$.modal({title:"注意",afterText:"<p>为了保障上宾权益，您一天最多可以取消三次买单</p>",buttons:[{text:"不取消",bold:!0},{text:"确认取消",bold:!0,onClick:function(){rest("/check/"+$.fn.cookie("order_id")+"/cancel",{},"post",function(e){200==e.code?ajaxUrl():$.toast(e.message)})}}]})})}function strategy(){socket(),key_json.oid&&$.fn.cookie("order_id",key_json.oid),app=new Vue({el:"#app",data:{data:"",key:0,payment:{},step:0,list:{},list1:{},qrcode:{}},beforeCreate:function(){function e(e){_self.payment=e,rest("/check/"+$.fn.cookie("order_id"),{},"get",function(e){200==e.code?(dataS=e.result,setTitle("原单金额 ￥"+e.result.amount),e.result.strategy&&(e.result.strategies=[e.result.strategy]),_self.data=e.result,e.result.bargain&&e.result.bargain.bargainId&&"803"!=e.result.bargain.state?(_self.list=e.result.bargain,setTimeout(function(){$("#bargain .bargain-record").show()},100)):e.result.bargain||setTimeout(function(){$(".recommend").show()},100)):history.back()})}$("#loading").addClass("hide"),_self=this,setPayMode(e)},methods:{choosedFn:function(){var e=this.data.strategies[this.key];this.data.strategies=[],Vue.set(this.data.strategies,0,e),this.key=0,$(".gift1").remove()},startBargainFn:function(){$(".hongbao").remove(),$(".qrcode").show(),$("#bargain .bargain-record").hide(),_self=this,"#"==$("#img").attr("src")&&($(".qrcode").append("<div id='loading'></div>"),rest("/bargain/order/"+_self.data.orderId,{},"post",function(e){if(200==e.code){_self.qrcode=e.result;var t=new QRCode($("#my-code"),{width:100,height:100});t.makeCode(e.result.url);var i=$("#htmlCode"),a=i.width(),s=i.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=a*e,t.height=(s+55)*e,t.style.width=a*e+"px",t.style.height=s*e+"px";var i=t.getContext("2d");i.scale(e,e),html2canvas($("#htmlCode"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$("#img").attr("src",t),$("#htmlCode").remove(),$(".qrcode #loading").remove()}})},100)}}))},closeBargainFn:function(){$.showIndicator(),_self=this,rest("/check/calculate/"+_self.data.orderId,{},"post",function(e){200==e.code?(_self.list={},_self.data=e.result,$(".bargain").hide(),$(".recommend").show()):404014==e.code?history.back():alert(e.message),$.hideIndicator()})},bargainListFn:function(){$.showIndicator(),_self=this,rest("/bargain/"+(_self.data.bargain.bargainId||_self.qrcode.bargainId),{},"get",function(e){200==e.code&&($.hideIndicator(),_self.list=e.result,setTimeout(function(){$("#bargain .bargain-record").show()},100))})},detailFn:function(){$.showIndicator(),_self=this,rest("/bargain/"+(_self.data.bargain.bargainId||_self.qrcode.bargainId),{},"get",function(e){200==e.code&&($.hideIndicator(),_self.list1=e.result,setTimeout(function(){$("#bargain1").show()},100))})},moreFn:function(){Vue.set(app.data,"no1",!0)},submitFn:function(){_self=this,$.confirm("选定策略后不可更改,确定？",function(){var e=_self.payment;$.showIndicator();var t={orderId:$.fn.cookie("order_id"),strategyId:$(".plan-box-focus").attr("id"),payCategory:e?e.payMode:"",url:encodeURIComponent(location.origin+"/payment.html"+location.search),failedUrl:encodeURIComponent(location.href)};rest("/check/pay",t,"post",function(t){if(404014==t.code)alert("订单不存在！"),history.back();else if(200!=t.code)return void alert(t.message);if(0==_self.data.strategies[_self.key].finalAmount)return void ajaxUrl("payment.html?order="+$.fn.cookie("order_id"));if(t.result.url)return void(location.href=t.result.url);switch(e.payMode){case"1005":var i=t.result.js,a=t.result.pay;a.success=function(){setTimeout(function(){ajaxUrl("payment.html?order="+$.fn.cookie("order_id"))},100)},a.cancel=function(){cancelPay()},a.fail=function(e){cancelPay()},i.debug=!1,i.jsApiList=["chooseWXPay"],delete i.url,wx.config(i),wx.ready(function(){wx.chooseWXPay(a)});break;case"1101":AlipayJSBridge.call("tradePay",{tradeNO:t.result.pay.tradeNO},function(e){return"6001"==e.resultCode?void cancelPay():void("9000"==e.resultCode&&ajaxUrl("payment.html?order="+$.fn.cookie("order_id")))})}})})}}}),app.$watch("data",function(e){console.log(e)},{deep:!0})}function cancelPay(){rest("/order/"+$.fn.cookie("order_id")+"/pay/revoke",{},"post",function(e){200==e.code&&(app?app.choosedFn():refresh())})}function bargainList(){rest("/bargain/"+$.fn.cookie("bargain_id"),{},"get",function(e){if($(".currentAmount").html((e.result.amount||0)+"元"),e.result.details){$(".media-list").html("");for(var t=0;t<e.result.details.length;t++){var i=$(".hide ul").clone(),a=e.result.details[t];if(!a.enabled)break;a.myself&&i.css("background","beige"),i.find(".c-star").html(t+1),i.find(".item-media img").attr("src",a.avatarUrl),i.find(".text-orange").html(a.amount+"元"),i.find(".item-title").html(a.nickname),i.find(".text-xs").html(a.createTime),$(".media-list").append(i)}}$(".modal-overlay").addClass("modal-overlay-black"),$("#list").show(),$.init(),$("#loading").addClass("hide")})}function bargain(){rest("/bargain/"+key_json.bid,{},"post",function(e){switch($.init(),$("#loading").addClass("hide"),e.code){case 405326:$("#text").html("还没人为我凑单"),$(".self").removeClass("hide"),$(".continue").show(),$("body").on("click",".continue",function(){location.href="strategy.html?id="+e.result.shopId+"&oid="+e.result.orderId});break;case 405325:$(".top").addClass("fail"),$(".auth").removeClass("hide");break;case 405324:$(".top").addClass("fail"),$(".auth").removeClass("hide");break;case 405323:$(".top").addClass("fail"),$(".expire").removeClass("hide");break;case 200:$(".done").removeClass("hide");break;case 405328:$(".top").addClass("fail"),$(".top").html('<div style="padding: 0 20px"><div class="c-expire"></div><div>本次凑单已经结束啦~</div></div>');break;default:$(".top").addClass("fail"),$(".top").html('<div style="padding: 0 20px"><div class="c-expire"></div><div>'+e.message+"</div></div>")}if($(".currentAmount").html((e.result.effective||0)+"元"),$(".reduce").html((e.result.eachAmount||0)+"元"),$(".time").html(e.result.timesLimit),$(".name").html(e.result.nickname||""),e.result.details){$(".media-list").html("");for(var t=0;t<e.result.details.length;t++){var i=$(".hide ul").clone(),a=e.result.details[t];if(!a.enabled)break;i.find(".item-title").html(a.nickname),a.myself&&(i.find(".item-title").html("我"),i.css("background","beige")),i.find(".c-star").html(t+1),i.find(".item-media img").attr("src",a.avatarUrl),i.find(".text-orange").html(a.amount+"元"),i.find(".text-xs").html(a.createTime),$(".media-list").append(i)}}})}function record(){rest("/order/guest/"+_id,{},"get",function(e){function t(e){for(var t=0;t<e.length;t++){var i=$(".hide .card").clone();i.find("#finalAmount").html("实付款 ￥"+(e[t].amount-(e[t].reduceAmount||0))),i.find("#amount").html("消费 ￥"+e[t].amount),i.find(".c-record .text-grey").html(e[t].checkTime),i.find(".shop").html(e[t].shopName),i.find(".btn-w").attr("onclick","goto('orderDetail.html?order="+e[t].orderId+"')"),i.find(".operate .pull-right").html(e[t].staffName||"");var a=e[t].strategy;if(a){if(a.coupons)for(var s=0;s<a.coupons.length;s++){var o=a.coupons[s],n=$(".hide .c-coupon").clone();"901"==o.category?n.find(".left").html("现金券"):"904"==o.category&&n.find(".left").html("礼品券"),n.find(".right").html(o.name+" "+o.count+"张<div class='text-xs'>"+o.effectTimes+"</div>"),i.find(".set-coupon").append(n)}a.points&&i.find(".c-point").html('<img src="/sui_assets/img/svg/2@1x.svg">'+a.points.point+"积分")}else i.find(".c-box").remove(),i.find(".c-record").addClass("empty");$(".set-code").append(i)}}var i,a=1,s=20,o=!1;200==e.code?(e.result.items&&t(e.result.items),i=e.result.total,i<=s&&$(".infinite-scroll-preloader").remove(),$.init(),$("#loading").addClass("hide")):($(".infinite-scroll-preloader").remove(),$(".content").append('<div class="text-center" style="padding: 3rem 2.5rem"><div class="v_green_wrong_coupon" style="margin: 0 auto;float: inherit"></div><p class="text">您还没有成功的买单哦~</p></div>')),$(document).on("infinite",".infinite-scroll-bottom",function(){o||(o=!0,setTimeout(function(){return o=!1,a++,a*s>=i?void $(".infinite-scroll-preloader").remove():(rest("/order/guest/"+_id,{page:a,count:s},"get",function(e){e.result&&t(e.result.items)}),void $.refreshScroller())},1e3))})})}function orderDetail(){return key_json.order?void rest("/order/"+key_json.order+"/detail",{},"get",function(e){if(200==e.code){var t=e.result,i=e.result.strategy;if($(".shop").html(e.result.shopName),$("#finalAmount").html("实付款 ￥"+i.finalAmount),$("#amount").html(t.paymentModeText),$(".plan-box").html('<div class="padding-xs"> <div class="left">原单金额</div> <div class="right">￥'+t.amount+"</div> </div>"),!t.hasOwnProperty("obtained")||t.obtained?"906"==t.state?($(".btn-w").removeClass("hide"),shopId&&$(".btn-w").attr("onclick","ajaxUrl('my.html')")):($(".c-text").html("奖励已发放至您的账户:"),shopId?$(".set-coupon").attr("onclick","ajaxUrl('my.html')"):$(".set-coupon").attr("onclick","ajaxUrl('user.html')"),$(".c-point").attr("onclick","ajaxUrl('exchange.html')")):$(".btn-g").removeClass("hide"),t.strategy.coupons)for(var a=0;a<t.strategy.coupons.length;a++){var s=t.strategy.coupons[a],o=$("#code .c-coupon").clone();"901"==s.category?o.find(".left").html("现金券"):"904"==s.category&&o.find(".left").html("礼品券"),o.find(".right").html(s.name+" "+s.count+"张<div class='text-xs'>"+s.effectTimes+"</div>"),$(".set-coupon").append(o)}if(t.strategy.points&&$(".c-point").html('<img src="/sui_assets/img/svg/2@1x.svg">'+t.strategy.points.point+"积分"),t.strategy.points||t.strategy.coupons||$(".c-box").remove(),i.nonPart){var n='<div class="padding-xs"><div class="left">不计优惠</div><div class="right">'+i.nonPart.name+'<span class="pull-right">￥'+i.nonPart.amount+"</span></div></div>";$(".plan-box").append(n)}if(i.used){for(var n='<div class="padding-xs"><div class="left">金额抵用</div><div class="right">',r=0;r<i.used.length;r++){var d=i.used[r].count?"("+i.used[r].count+" 张)":"";n+="<div>"+i.used[r].content+'<span class="pull-right">- ￥'+i.used[r].amount+d+"</span></div>"}n+="</div></div>",$(".plan-box").append(n)}$(".plan-box").append('<div class="padding-xs"> <div class="left">操作人员</div> <div class="right">'+(t.staffName||"自助买单")+"</div> </div>"),$.init(),$("#loading").addClass("hide")}else alert(e.message)}):void alert("无订单信息")}function couponFn(){Vue.component("coupon",{props:["coupon","start","end"],template:'<div  v-on:click="couponDetailFn(coupon.id)" ><div class="cash-coupon" v-if="coupon.couponCategory==\'901\'"><div class="bg" :style="{backgroundImage: \'url(\'+ (coupon.picUrl||\'\') +\')\'}"><div class="left-label" v-if="start">第{{end?(start+\'~\'+end):start}}名</div><div class="border"></div></div><div class="detail"><span class="amount">{{coupon.amount}}</span><span class="label">代金券</span></div></div><div class="object-coupon" v-else><div class="bg" :style="{backgroundImage: \'url(\'+ (coupon.picUrl||\'\') +\')\'}"><div class="left-label" v-if="start">第{{end?(start+\'~\'+end):start}}名</div><div class="name">{{coupon.name}}<div class="pull-right">￥{{coupon.amount}}</div></div></div><div class="text" v-if="coupon.descriptor">{{coupon.descriptor}}</div><div class="meal" v-if="coupon.couponCategory==\'9021\'"><div class="meal-title">套餐菜品</div><div class="item" v-for="item in coupon.dishess">{{item.name}}({{item.count}}份)<div class="pull-right">￥{{item.price}}</div></div><div class="total">总价值￥{{coupon.total}}</div></div><div class="detail-in"></div></div></div>',methods:{couponDetailFn:function(e){ajaxUrl("couponDetail.html?cid="+e)}}})}function payment(){if(!key_json.order)return void alert("无订单信息");new Vue({el:"#app",data:{data:"",state:""},beforeCreate:function(){var e=this;rest("/praise/order/"+key_json.order,{},"get",function(t){if(200==t.code){if(t.result.step<3)return void ajaxUrl("praise.html?cid="+t.result.commentId);if(3==t.result.step&&ajaxUrl("prize.html?cid="+t.result.commentId),$("#loading").addClass("hide"),e.data=t.result,t.result.needPhone){var i="";if(t.result.order.strategy.coupons){i="<div class='v-coupon'>";for(var a in t.result.order.strategy.coupons)i+="<div class='v-item'>"+t.result.order.strategy.coupons[a].name+"</div>";i+="</div>"}t.result.order.strategy.points&&(i+="<div class='v-point'><div class='v-item'>"+t.result.order.strategy.points.point+"积分</div></div>"),$(".page-group").html('<div class="earn-true"><div class="big-title">恭喜获得以下权益！</div>'+i+'</div><div class="modal-button">立即领取</div><div class="md-close" onclick="$(\'.page-group\').hide();"></div>'),$(".modal-button").click(function(){$(".page-group").show().html('<div class="bg-green"><div style="padding-top: .5rem;font-size: .9rem">补全手机后，即可领取权益</div><div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><input type="tel" placeholder="您的常用手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="收到的验证码" id="validate" maxlength="6"/></div><div class="btn-green" id="submitFn">领取</div><div class="md-close" onclick="$(\'.page-group\').hide();"></div></div>'),$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#submitFn").off().click(function(){if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};key_json.id?e.shopId=_id:e.guestId=_id,e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),rest("/phone/bindup",e,"post",function(e){200==e.code?(e.token&&$.fn.cookie("token",e.token,{expires:7}),$(".page-group").html(""),$.toast("操作成功")):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message?e.message:"请重试"))})}else $.toast("请输入正确的验证码")})}),t.result.order.strategy.coupons||t.result.order.strategy.points?$(".page-group").show():$(".modal-button").click()}}else 404e3==t.code?setTimeout(function(){refresh()},5e3):alert(t.message)})},methods:{openFn:function(){ajaxUrl("comment.html?oid="+key_json.order)}}})}function comment(){new Vue({el:"#app",data:{data:"",view:{},post:{dishes:""},dishes:"",chooseImg:"",count:0,state:1,rule:""},beforeCreate:function(){var e=this;rest("/praise/comment/order/"+key_json.oid,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),$("#content").css("height",window.screen.height-139+"px"),rest("/praise/dishes/"+key_json.id,{},"get",function(t){200==t.code&&(e.dishes=t.result,e.dishes.pageSize>1&&$(window).scroll(function(){if("dish"==e.currentView){var t=$(this).scrollTop(),i=$(document).height(),a=$(this).height();t+a===i&&(e.dishes.page++,rest("/praise/dishes/"+key_json.id,{page:e.dishes.page},"get",function(t){200==t.code&&(e.dishes.items=e.dishes.items.concat(t.result.items))}))}}))}),e.data=t.result,t.result.defaultComment&&(e.post.comment=t.result.defaultComment)):ajaxUrl("payment.html?order="+key_json.oid)})},methods:{changeCommentFn:function(){this.post.comment==this.data.defaultComment?this.post=Object.assign({},this.post,{comment:""}):this.post.comment=this.data.defaultComment},ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{orderId:key_json.oid},"get",function(e){200==e.code&&(_self.rule=e.result,$(".page-group1").show())})},joinFn:function(){var e=this;if(!this.post.comment||this.post.comment.length<15)return void alert("请先填写15字以上评价");var t=[];if(!this.post.dishes||!this.post.dishes.length){if(!this.data.defaultDishes)return void alert("请先选择满意的商品");this.post.dishes=this.data.defaultDishes}for(var i=0;i<this.post.dishes.length;i++)this.post.dishes[i]&&this.post.dishes[i].id&&t.push(this.post.dishes[i].id);this.data.needPhone?($("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group").show().html('<div class="bg-green"><div style="padding-top: .5rem;font-size: .9rem"">补全手机后，即可领取权益</div><div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><input type="tel" placeholder="您的常用手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="收到的验证码" id="validate" maxlength="6"/></div><div class="btn-green" id="submitFn">提交评论</div>'+"<div class=\"md-close\" onclick=\"  $('.page-group').hide();$('#app').css('overflow', 'auto');\"></div></div>"),$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/benefit/validate",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#submitFn").off().click(function(){11==$("#tel").val().length&&6==$("#validate").val().length?($.showIndicator(),rest("/praise/comment/"+key_json.oid,{comment:e.post.comment,dishes:t,phone:$("#tel").val(),validateCode:$("#validate").val()},"post",function(t){200==t.code?(e.data.comment=t.result,t.result.benefit?$(".page-group").html('<div class="achieve"><div class="big-title">评论成功！</div><div style="font-size: .7rem">恭喜获得</div><div class="text-red" style="font-size: 1.2rem;padding: .7rem 0">'+t.result.benefit+'</div><div class="border"><div>红包已发至您的账号</div><div>可在本店公众号中查看获赠权益</div></div><div class="btn" onclick="ajaxUrl(\'praise.html?cid='+t.result.commentId+"')\">我知道了</div></div>"):$(".page-group").html('<div class="achieve"><div class="big-title">评论成功！</div><div class="text-red" style="font-size: 1.2rem;padding: 1rem 0">恭喜您评论成功</div><div class="btn" onclick="ajaxUrl(\'praise.html?cid='+t.result.commentId+"')\">我知道了</div></div>")):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(result.message?result.message:"请重试"))})):$.toast("请输入正确的验证码")})):rest("/praise/comment/"+key_json.oid,{comment:this.post.comment,dishes:t},"post",function(t){200==t.code?(e.data.comment=t.result,t.result.benefit?$(".page-group").html('<div class="achieve"><div class="big-title">评论成功！</div><div style="font-size: .7rem">恭喜获得</div><div class="text-red" style="font-size: 1.2rem;padding: .7rem 0">'+t.result.benefit+'</div><div class="border"><div>红包已发至您的账号</div><div>可在本店公众号中查看获赠权益</div></div><div class="btn" onclick="ajaxUrl(\'praise.html?cid='+t.result.commentId+"')\">我知道了</div></div>"):$(".page-group").html('<div class="achieve"><div class="big-title">评论成功！</div><div class="text-red" style="font-size: 1.2rem;padding: 1rem 0">恭喜您评论成功</div><div class="btn" onclick="ajaxUrl(\'praise.html?cid='+t.result.commentId+"')\">我知道了</div></div>"),$(".page-group").show()):alert(t.message)})},chooseImgFn:function(e){var t=this.dishes.items[e];if(t.checked)this.count--,t.checked=!1;else{if(3==this.count)return;t.checked=!0,this.count++}Vue.set(this.dishes.items,e,t)},checkedImg:function(){if(!$(".relative .btn").hasClass("disabled")){this.state=1,this.post.dishes=[];for(var e=0;e<this.dishes.items.length;e++)this.dishes.items[e].checked&&this.post.dishes.push(this.dishes.items[e])}}}})}function couponDetail(){new Vue({el:"#app",data:{data:""},beforeCreate:function(){var e=this;rest("/activities/coupon/"+key_json.cid,{},"get",function(t){200==t.code?($("#loading").addClass("hide"),e.data=t.result):alert(t.message)})},methods:{}})}function praise(){couponFn();new Vue({el:"#app",data:{data:"",data1:"",time:[],state:!1},beforeCreate:function(){var e=this;rest("/praise/activity/comment/"+key_json.cid,{},"get",function(t){function i(){var t=new Date(e.data.lottery.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),s=parseInt(t/1e3/60/60%24,10),o=parseInt(t/1e3/60%60,10),n=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(s)),Vue.set(e.time,2,checkTime(o)),Vue.set(e.time,3,checkTime(n))}if(200==t.code){if($("#loading").addClass("hide"),e.data=t.result,t.result.lottery)var a=setInterval(i,1e3);if(t.result.lastWinners&&setTimeout(function(){$("#Marquee_x").Marquee({marquee:"x",margin_right:"10px",speed:50})},100),"WXPAY"==version){var s={};s.url=location.href,rest("/auth/sign",s,"post",function(t){if(200==t.code){var i=t.result;i.jsApiList=["hideMenuItems","onMenuShareAppMessage"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl","menuItem:share:timeline"]}),wx.onMenuShareAppMessage({title:e.data.lottery?"我正在参加"+e.data.brand.brand+"的晒单评奖活动":e.data.nickname+"邀您领"+e.data.brand.brand+"的红包",desc:"助力好友，领优惠",link:location.origin+"/paymentee.html?id="+key_json.id+"&cid="+key_json.cid,imgUrl:e.data.picUrl,type:"",dataUrl:"",success:function(){},cancel:function(){}})})}else alert(t.message)})}}})},methods:{inviteFn:function(){$(".gmadal-black").append("<div id='loading'></div>");var e=this;$(".gmadal-black").show(),$("#htmlCode").html()?rest("/praise/share/comment/"+key_json.cid,{},"post",function(t){200==t.code&&(e.data1=t.result,e.$nextTick(function(){var e=new QRCode($("#my-code1"),{width:100,height:100});e.makeCode(t.result.url);var i=$("#htmlCode"),a=i.width(),s=i.height(),o=2,n=document.createElement("canvas");n.width=a*o,n.height=s*o+20,n.style.width=a*o+"px",n.style.height=s*o+"px";var r=n.getContext("2d");r.scale(o,o),html2canvas($("#htmlCode"),{useCORS:!0,canvas:n,onrendered:function(e){var t=e.toDataURL();$("#img").attr("src",t),$("#htmlCode").remove(),$(".gmadal-black #loading").remove()}})}))}):$(".gmadal-black #loading").remove()},pageFn:function(){var e=this;rest("/praise/candidate/"+key_json.cid,{page:this.data.candidaters.page+1,count:this.data.candidaters.count},"get",function(t){200==t.code&&(e.data.candidaters.page++,e.data.candidaters.items=e.data.candidaters.items.concat(t.result.items))})}}})}function upvoters(){new Vue({el:"#app",data:{data:"",data1:"",time:[],state:!1},beforeCreate:function(){var e=this;rest("/praise/upvote/"+key_json.cid,{},"get",function(t){200==t.code&&($("#loading").addClass("hide"),e.data=t.result)})},methods:{pageFn:function(){var e=this;e.data.page>=e.data.pageSize||rest("/praise/upvote/"+key_json.cid,{page:++e.data.page,count:e.data.count},"get",function(t){200==t.code&&(e.data.items=e.data.items.concat(t.result.items))})}}})}function paymentee(){couponFn(),app=new Vue({el:"#app",data:{data:"",data1:"",time:[],rule:"",state:!1},beforeCreate:function(){key_json.cid=key_json.comment?key_json.comment:key_json.cid;var e=this;rest("/praise/share/comment/"+key_json.cid,{},"get",function(t){function i(){var t=new Date(e.data.lottery.endTime)-new Date;if(!t)return void clearInterval(a);var i=parseInt(t/1e3/60/60/24,10),s=parseInt(t/1e3/60/60%24,10),o=parseInt(t/1e3/60%60,10),n=parseInt(t/1e3%60,10);Vue.set(e.time,0,checkTime(i)),Vue.set(e.time,1,checkTime(s)),Vue.set(e.time,2,checkTime(o)),Vue.set(e.time,3,checkTime(n))}if(200==t.code){if(t.result.self)return void ajaxUrl(3==t.result.step?"prize.html?cid="+key_json.cid:"praise.html?cid="+key_json.cid);if(3==t.result.step&&ajaxUrl("prize.html?cid="+key_json.cid),e.data=t.result,$("#loading").addClass("hide"),t.result.lottery)var a=setInterval(i,1e3);if("WXPAY"==version){var s={};s.url=location.href,rest("/auth/sign",s,"post",function(t){if(200==t.code){var i=t.result;
i.jsApiList=["hideMenuItems","onMenuShareAppMessage"],wx.config(i),wx.ready(function(){wx.hideMenuItems({menuList:["menuItem:copyUrl","menuItem:share:timeline"]}),wx.onMenuShareAppMessage({title:e.data.nickname+"邀您领"+e.data.name+"的红包",desc:"助力好友，领优惠",link:location.href,imgUrl:e.data.picUrl,type:"",dataUrl:"",success:function(){},cancel:function(){}})})}})}}else alert(t.message)})},methods:{inviteFn:function(){$(".gmadal-black").append("<div id='loading'></div>");var e=this;$(".gmadal-black").show(),$("#htmlCode").html()?rest("/praise/share/comment/"+key_json.cid,{},"post",function(t){200==t.code&&(e.data1=t.result,e.$nextTick(function(){var e=new QRCode($("#my-code1"),{width:100,height:100});e.makeCode(t.result.url);var i=$("#htmlCode"),a=i.width(),s=i.height();setTimeout(function(){var e=2,t=document.createElement("canvas");t.width=a*e,t.height=s*e+20,t.style.width=a*e+"px",t.style.height=s*e+"px";var i=t.getContext("2d");i.scale(e,e),html2canvas($("#htmlCode"),{useCORS:!0,canvas:t,onrendered:function(e){var t=e.toDataURL();$("#img").attr("src",t),$("#htmlCode").remove(),$(".gmadal-black #loading").remove()}})},100)}))}):$(".gmadal-black #loading").remove()},submitFn:function(){var e=this;this.data.needPhone?($("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group").show().html('<div class="bg-green"><div style="padding-top: .5rem;font-size: .9rem"">补全手机后，即可领取权益</div><div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><input type="tel" placeholder="您的常用手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="收到的验证码" id="validate" maxlength="6"/></div><div class="btn-green" id="submitFn">领取</div>'+"<div class=\"md-close\" onclick=\"  $('.page-group').hide();$('#app').css('overflow', 'auto');\"></div></div>"),$(".input-text").click(function(){11==$("#tel").val().length?($(this).addClass("disabled"),rest("/benefit/validate",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号")}),$("#submitFn").off().click(function(){11==$("#tel").val().length&&6==$("#validate").val().length?($.showIndicator(),rest("/praise/upvote/"+key_json.cid,{phone:$("#tel").val(),validateCode:$("#validate").val()},"post",function(t){200==t.code?e.data.benefits?($(".page-group").html('<div class="achieve"><div class="big-title">领取成功！</div><div style="font-size: .7rem">恭喜获得</div><div class="text-red" style="font-size: 1.2rem;padding: .7rem 0">'+("901"==e.data.benefits[0].couponCategory?e.data.benefits[0].amount+"元代金券":e.data.benefits[0].name)+'</div><div class="border"><div>红包已发至您的账号</div><div>可在本店公众号中查看获赠权益</div></div><div class="btn" onclick="refresh()">我知道了</div></div>'),$(".page-group").show()):($(".page-group").html('<div class="achieve"><div class="big-title">助力成功！</div><div class="text-red" style="font-size: 1.2rem;padding: 1rem 0">恭喜助力成功</div><div class="btn" onclick="refresh()">我知道了</div></div>'),$(".page-group").show()):($("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(t.message?t.message:"请重试"))})):$.toast("请输入正确的验证码")})):rest("/praise/upvote/"+key_json.cid,{},"post",function(t){200==t.code?($("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),e.data.benefits?($(".page-group").html('<div class="achieve"><div class="big-title">领取成功！</div><div style="font-size: .7rem">恭喜获得</div><div class="text-red" style="font-size: 1.2rem;padding: .7rem 0">'+("901"==e.data.benefits[0].couponCategory?e.data.benefits[0].amount+"元代金券":e.data.benefits[0].name)+'</div><div class="border"><div>红包已发至您的账号</div><div>可在本店公众号中查看获赠权益</div></div><div class="btn" onclick="refresh()">我知道了</div></div>'),$(".page-group").show()):($(".page-group").html('<div class="achieve"><div class="big-title">助力成功！</div><div class="text-red" style="font-size: 1.2rem;padding: 1rem 0">恭喜助力成功</div><div class="btn" onclick="refresh()">我知道了</div></div>'),$(".page-group").show())):alert(t.message)})},pageFn:function(){var e=this;rest("/praise/candidate/"+key_json.cid,{page:this.data.candidaters.page+1,count:this.data.candidaters.count},"get",function(t){200==t.code&&(e.data.candidaters.page++,e.data.candidaters.items=e.data.candidaters.items.concat(t.result.items))})},ruleFn:function(){_self=this,rest("/praise/activity/"+this.data.activityId,{commentId:key_json.cid},"get",function(e){200==e.code&&(_self.rule=e.result,$("#app").css("height",$(window).height()+"px"),$("#app").css("overflow","hidden"),$(".page-group1").show())})}}})}function prize(){couponFn();new Vue({el:"#app",data:{data:"",winners:"",upvoters:""},beforeCreate:function(){key_json.cid=key_json.comment?key_json.comment:key_json.cid;var e=this;rest("/praise/lottery/"+key_json.cid,{},"get",function(t){200==t.code&&($("#loading").addClass("hide"),e.data=t.result,rest("/praise/winner/"+key_json.cid,{},"get",function(t){200==t.code&&(e.winners=t.result)}),rest("/praise/upvote/"+key_json.cid,{},"get",function(t){200==t.code&&(e.upvoters=t.result)}))})},methods:{pageFn:function(){var e=this;rest("/praise/winner/"+key_json.cid,{page:this.winners.page+1},"get",function(t){200==t.code&&(e.winners.page++,e.winners.items=e.winners.items.concat(t.result.items))})},moreFn:function(){var e=this;e.upvoters.page>=e.upvoters.pageSize||rest("/praise/upvote/"+key_json.cid,{page:++e.upvoters.page,count:e.upvoters.count},"get",function(t){200==t.code&&(e.upvoters.items=e.upvoters.items.concat(t.result.items))})}}})}function userInfo(){rest("/user",{},"get",function(e){function t(e){var t="";switch(e){case"F":t='女士 <span class="F"></span>';break;case"M":t='男士 <span class="M"></span>';break;default:t="保密"}$("#gender .item-after").html(t)}200==e.code&&($(".name").html(e.result.nickname),$(".avatar").attr("src",e.result.avatarUrl),e.result.phone?($.fn.cookie("phone",e.result.phone),$("#phone").attr("onclick","ajaxUrl('changePhone.html')"),$("#phone .item-after").html(e.result.phone+"<span class='text-green'> 修改手机</span>")):($("#set").addClass("round"),"coupon"==key_json.type?(phoneModal(),$(".earn-box1").removeClass("hide")):phoneModal("phone"),$("#phone").addClass("round")),e.result.gender&&t(e.result.gender),e.result.birthday&&($("#birth .item-after").html(e.result.birthday),$("#birth").addClass("has-birth")),$("#gender").click(function(){var t="F"==e.result.gender?2:"M"==e.result.gender?3:4;$.modal({title:"请选择您的性别",afterText:'<div class="text-center" style="font-size: .75rem;line-height: 2"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><div><input type="radio" id="radio1" name="gender" value="F"/> <label for="radio1">女士 <span class="F"></span></label></div><div><input type="radio" id="radio2" name="gender" value="M"/> <label for="radio2">男士 <span class="M"></span></label></div><div><input type="radio" id="radio3" name="gender" value="N"/> <label for="radio3">保密 <span class="N"></span></label></div><div class="btn-green" style="width: 100%;margin: 1rem -1px 0;height: 2rem;line-height: 2rem" id="gender-submit">确认</div><div class="md-close"></div>',extraClass:"bg-green"}),$(".modal-inner .text-center div:nth-child("+t+") input").attr("checked","checked")}),$("body").on("click","#gender-submit",function(){if($("input:checked").val()){rest("/user",{gender:$("input:checked").val()},"post",function(i){200==i.code?($.closeModal(),$.toast("操作成功!"),e.result.gender=$("input:checked").val(),t($("input:checked").val())):toast(i.message)})}else $.toast("请先选择性别！")}),$.init(),$("#loading").addClass("hide"))})}function brand(){var e={};e.type="WXPAY"==version?"wx":"ali",rest("/activities/guest/"+_id,e,"get",function(e){if(e.result){$("#loading").addClass("hide"),$(".shop").html(e.result.brandName),$("title").html(e.result.brandName);var t=e.result;if(t.memberActivity&&(e.result.memberActivity.card&&loadImage(e.result.memberActivity.card,'$(".card-bg").attr("style", "background-image:url(" + url + ")")'),e.result.logo&&loadImage(e.result.logo,'$(".card-content .avatar").attr("src", url)'),$(".card-bg").attr("onclick","ajaxUrl('vip.html')"),$(".set-content").html('<div class="coupon-content"> <div class="right"><span class="iconA"></span></div> </div>'),$(".card-grey").removeClass("hide")),t.activeActivities&&setActivityCode(t.activeActivities),t.checkActivities&&setCheckCode(t.checkActivities),t.topActivity){var i=[t.topActivity];t.topActivity.activityCategory<6005||"6007"==t.topActivity.activityCategory?setActivityCode(i,1):setCheckCode(i,1)}if(t.followActivity){for(var a="",s=t.followActivity,o=s.coupons.length>2?2:s.coupons.length,n=0;n<o;n++)switch(s.coupons[n].category){case"9021":case"902":a+='<div class="food-box">'+s.coupons[n].value+'<span class="pull-right">￥'+s.coupons[n].currentAmount+'<span class="amount" style="font-size: .5rem;"> ￥'+s.coupons[n].amount+"</span></span></div>";break;case"901":a+='<div class="money-box">'+s.coupons[n].name+"</div>";break;case"9011":a+='<div class="discount-box">'+s.coupons[n].name+"</div>";break;case"904":a+='<div class="gift-box">'+s.coupons[n].name+"</div>";break;case"9031":a+='<div class="di-box">'+s.coupons[n].name+"</div>";break;case"903":a+='<div class="di-box">全场'+s.coupons[n].name+"</div>"}$(".separate").html('<div class="follow-card" onclick="ajaxUrl(\'follow.html\')"><div class="follow">'+a+"</div></div>")}$.init(),$("#loading").addClass("hide")}})}function more(){var e={};e.type="WXPAY"==version?"wx":"ali",e.id=_id,rest("/activities/shop",e,"get",function(e){if(e.result){$(".shop").html(e.result.brandName),$("title").html(e.result.brandName);var t=e.result;if(t.memberActivity&&shopId&&(e.result.card&&loadImage(e.result.card,'$(".card-bg").attr("style", "background-image:url(" + url + ")")'),e.result.logo&&loadImage(e.result.logo,'$(".card-content .avatar").attr("src", url)'),$(".card-bg").attr("onclick","ajaxUrl('vip.html')"),$(".set-content").html('<div class="coupon-content"><div class="right"><span class="iconA"></span></div> </div>'),$(".card-grey").removeClass("hide")),t.activeActivities&&setActivityCode(t.activeActivities),t.checkActivities&&setCheckCode(t.checkActivities),t.topActivity){var i=[t.topActivity];t.topActivity.activityCategory<6005||"6007"==t.topActivity.activityCategory?setActivityCode(i,1):setCheckCode(i,1)}if(t.followActivity){for(var a="",s=t.followActivity,o=s.coupons.length>2?2:s.coupons.length,n=0;n<o;n++)switch(s.coupons[n].category){case"9021":case"902":a+='<div class="food-box">'+s.coupons[n].value+'<span class="pull-right">￥'+s.coupons[n].currentAmount+'<span class="amount" style="font-size: .5rem;"> ￥'+s.coupons[n].amount+"</span></span></div>";break;case"901":a+='<div class="money-box">'+s.coupons[n].value+"元代金券</div>";break;case"9011":a+='<div class="discount-box">'+s.coupons[n].name+"</div>";break;default:a+='<div class="gift-box">'+s.coupons[n].value+"</div>"}$(".separate").html('<div class="follow-card" onclick="ajaxUrl(\'follow.html\')"><div class="">关注本店公众号，即可获专享优惠</div> <div class="follow">'+a+"</div></div>")}$.init(),$("#loading").addClass("hide")}})}function follow(){rest("/activities/follow/guest/"+_id,{},"get",function(e){200!=e.code&&$.modal({title:"",afterText:"<div >您不是本店的新粉丝<br>不能参加此活动哦~<br>我们将带您到活动中心</div>",buttons:[{text:"我知道了",onClick:function(){ajaxUrl(shopId?"entrance.html":"brand.html")}}]}),rest("/shop/"+_id+"/mp",{},"get",function(t){if(200==t.code){$("title").html(e.result.brandName);for(var i=e.result,a="",s=i.coupons.length,o=0;o<s;o++)switch(i.coupons[o].category){case"902":case"9021":a+='<div class="food-box"><span class="ellipsis">'+i.coupons[o].value+'</span><span class="pull-right">￥'+i.coupons[o].currentAmount+'<span class="amount" style="font-size: .5rem"> ￥'+i.coupons[o].amount+"</span></span></div>";break;case"901":a+='<div class="money-box">'+i.coupons[o].value+"元代金券</div>";break;case"9011":a+='<div class="discount-box">'+i.coupons[o].name+"</div>";break;default:a+='<div class="gift-box">'+i.coupons[o].value+"</div>"}t.result.subscribe?e.result.existPhone?$(".inner").html('<div class="text-xs">您已关注！快来领取专属好礼！</div><div class="coupon-list">'+a+'</div><div class="phone-box1"><div><img onclick="earn(\''+i.activityId+"','"+i.ruleTupleId+'\')" src="/sui_assets/img/follow/submit.svg" style="width: 3.5rem;margin-top: 1rem"></div>'):($(".inner").html('<div class="text-xs">您已关注！快来领取专属好礼！</div><div class="coupon-list">'+a+'</div><div class="phone-box1" id="bind"><input type="tel" placeholder="请输入手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="输入验证码" id="validate" maxlength="6"/></div><div id="bindPhone" index="'+i.activityId+"&"+i.ruleTupleId+'"><img src="/sui_assets/img/follow/submit.svg" style="width: 3.5rem;margin-top: -.25rem"></div>'),bind()):$(".inner").html('<div class="text-xs">关注本店公众号，即可获专属优惠</div><div class="coupon-list">'+a+'</div><div class="follow-wx"><div> <div>长按关注再领券</div><img src="/sui_assets/img/finger.gif"> </div> <div > <img src="'+t.result.url+'" class="shop_url"> </div> </div>'),$.init(),$("#loading").addClass("hide")}})})}function bind(){$("#loading").addClass("hide"),$(".input-text").click(function(){$(".toast").hasClass("modal-in")||(11==$("#tel").val().length?($(this).addClass("disabled"),rest("/validate/bindup",{phone:$("#tel").val()},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled"),$.toast(e.message)})):$.toast("请输入正确的手机号"))}),$("#bindPhone").off().click(function(){if(!$(".toast").hasClass("modal-in"))if(11==$("#tel").val().length&&6==$("#validate").val().length){$.showIndicator();var e={};key_json.id?e.shopId=_id:e.guestId=_id,e.phone=$("#tel").val(),e.validateCode=$("#validate").val(),rest("/phone/bindup",e,"post",function(e){if(200==e.code)switch($.closeModal(),e.token&&$.fn.cookie("token",e.token,{expires:7}),basicName){case"bind":alert("绑定手机成功，请继续您未完成的操作"),history.go(-1);break;case"follow":earn($("#bindPhone").attr("index").split("&")[0],$("#bindPhone").attr("index").split("&")[1]);break;case"payment":case"orderDetail":$.toast("正在同步您的权益，请稍后",3e3),setTimeout(function(){ajaxUrl(key_json.guestid?"user.html":"my.html")},2e3);break;case"userInfo":"coupon"==key_json.type?$.toast("权益已自动发放，请刷新查看",3e3):$.toast("补全手机成功"),location.href=location.href+"&time="+new Date;break;case"entrance":case"selfPay":case"user":$(".modal").remove(),addVipResult();break;default:alert("操作成功"),ajaxUrl(shopId?"my.html":"user.html")}else $("#validate").val(""),$(".input-text").html("重新获取验证码"),$.toast(e.message?e.message:"请重试")})}else 11==$("#tel").val().length?$.toast("请输入正确的验证码"):$.toast("请输入正确的手机号")})}function reuion(){app=new Vue({el:"#bind",data:{data:"",post:{},list:""},beforeCreate:function(){$("#loading").addClass("hide")},methods:{validateFn:function(){_self=this,$(".input-text").hasClass("disabled")||($(".input-text").addClass("disabled"),rest("/membership/"+this.data.id+"/binding/validate",{},"post",function(e){if(200==e.code){$.toast("获取成功");var t=90,i=setInterval(function(){return t--,t?void $(".input-text").html("已发送 "+t+" s"):(clearInterval(i),$(".input-text").html("重新获取验证码"),void $(".input-text").removeClass("disabled"))},1e3)}else $(".input-text").removeClass("disabled")}))},searchFn:function(){_self=this,rest("/membership/binding/guest/"+_id,{param:this.post.tel},"get",function(e){200==e.code?_self.data=e.result:$.toast("对不起，没有查到相关权益，请重新提交或呼叫服务员为您服务。")})},submitFn:function(){return _self=this,6!=this.post.validate.length?void $.toast("请先填写正确的验证码"):void rest("/membership/"+this.data.id+"/binding",{validateCode:this.post.validate},"post",function(e){200==e.code?_self.list=e.result:$.toast(e.message)})},redirectFn:function(){ajaxUrl(key_json.id?"my.html":"user.html")}}})}function birth(){rest("/user",{},"get",function(e){var t=e.result;t&&$(".name").html(t.nickname),$("input").calendar({maxDate:"2017-01-01",dateFormat:"yyyy-mm-dd",value:["1990-01-01"],onOpen:function(){$(".picker-calendar-year-picker").insertBefore($(".picker-calendar-month-picker"),$(".toolbar-inner"))}}),$(".btn-orange").click(function(){$("input").val()?$.confirm("注意！请填写您的真实生日，生日一旦设置将不可更改！您设置的生日将可能影响您在商家正常行使权益。",function(){rest("/user",{birthday:$("input").val()},"post",function(e){200==e.code?($.toast("操作成功!"),history.back()):toast(e.message)})}):$.toast("请填写生日！")}),$.init(),$("#loading").addClass("hide")})}function control(){function e(){var e="";"c"==key_json.t?(e="902"==dataS.category||"9021"==dataS.category?"<div class='m-title'>恭喜获得价值<span style='color: #ed393a'>"+(dataS.amount-dataS.currentAmount)+"元</span>优惠礼</div>":"901"==dataS.category?"<div class='m-title'>恭喜获得价值<span style='color: #ed393a'>"+dataS.amount+"元</span>优惠礼</div>":"<div class='m-title'>恭喜获得<span style='color: #ed393a'>"+dataS.name+"</span></div>",e+="<div class='coupon-box1'>"+dataS.name+"</div><div style='font-size: 10px;color:#ad1c1b'>"+dataS.times+"</div>"):e="<div class='m-title'>恭喜获得<span style='color: #ed393a'>"+dataS.value+"积分</span></div><div class='point-box1'>"+dataS.value+"积分</div>",rest("/shop/"+_id+"/mp",{},"get",function(t){var i=t.result,a="";i&&i.url&&(a="<div class='addon'><div><img src='"+i.url+"'/></div><div>长按识别<br>查看获赠权益</div></div>"),$.modal({afterText:"<div class='bg-green'><div class='modal-title'>领取成功</div>"+e+"<div class='grey'>下次扫码买单时将【自动使用权益】</div></div>"+a+"<div class='close' onclick=\"window.location.href = location.href + '&time=' + ((new Date()).getTime());\"></div>"})})}function t(e,t){$(e).html(t),setTimeout(function(){$(e).html("")},3e3)}key_json.guestid=key_json.id;var i;"c"==key_json.t?i="coupon":"p"==key_json.t?(i="point",$(".coupon-box").addClass("point")):location.href="error.html",rest("/user",{},"get",function(a){a.result.phone&&$(".user").hide(),$.init(),$("#loading").addClass("hide"),$(".new-in .button-fill").click(function(){if(a.result.phone)rest("/benefit/"+i,{id:$(this).attr("id")},"post",function(t){200==t.code?(t.result&&$.fn.cookie("token",t.result.token,{expires:7}),e()):$.toast(t.message)});else{var s=$("#code").val();6!==s.length?t(".title","请填写正确的验证码"):s.length?rest("/benefit/"+i,{phone:$("#phone").val(),id:$(this).attr("id"),validateCode:s},"post",function(i){200==i.code?(i.result&&$.fn.cookie("token",i.result.token,{expires:7}),e()):t(".title",i.message)}):t(".title","请正确填写手机号码！")}})}),rest("/benefit/"+i+"/"+key_json.v,{},"get",function(e){if(200==e.code){var i=e.result;if(dataS=i,setTitle(i.brandName),$("#shop").html(i.brandName),4004==i.state?$(".old-in").removeClass("hide1"):$(".new-in").removeClass("hide1"),"905"==i.category)$("#limits").remove(),$("#coupon").html(i.value+"积分");else{$("#coupon").html(i.name),"902"!=i.category&&"9021"!=i.category||($(".line-through").html("原价 ￥"+i.amount),$(".now").html(" 现价 ￥"+i.currentAmount));var a="";if("901"!=i.category&&"904"!=i.category||(a+='<div class="item"><div class="left">价值：</div><div class="right"> '+i.amount+"元</div></div>"),a+='<div class="item"><div class="left">使用条件：</div><div class="right">'+i.useStrategy+'</div></div><div class="item"><div class="left">有效期：</div><div class="right">'+i.times+'</div></div><div class="item"><div class="left">详情：</div><div class="right">',i.content)for(var s=0;s<i.content.length;s++)a+="<div>"+i.content[s]+"</div>";a+='</div></div><div class="item"><div class="left">备注：</div><div class="right"><div>本券不找零，不兑现，不做外卖使用</div><div>最终解释权归本公司所有</div></div></div>',$("#limits").html(a)}$(".button-fill").attr("id",i.id)}else alert(e.message);$(".help-btn").click(function(){var e=$("#phone").val();""==e?$.toast("手机号码不能为空！"):/^\s*1\d{10}\s*$/.test(e)?rest("/benefit/validate",{phone:e},"post",function(e){if(200==e.code){$(".help-btn").addClass("disabled"),t(".title","获取成功");var i=90,a=setInterval(function(){return i?($(".help-btn").html("已发送 "+i+" s"),void i--):(clearInterval(a),$(".help-btn").html("重新获取验证码"),void $(".help-btn").removeClass("disabled"))},1e3)}else $.toast(e.message)}):t(".title","请正确填写手机号码")})})}function vipNew(){ajaxUrl("vip.html")}function vip(){function e(){rest("/membership/guest/"+_id,{},"get",function(e){function t(t){$(".pages:nth-child("+t+")").addClass("current");var i=e.result.strategies[t-1],a="";if(e.result.currentGrade&&i.toGrade<=e.result.currentGrade)return void $(".pay-fixed .gold").html("<div style='color:#ffffff;text-align: center'>您已是"+e.result.memberGradeName+"</div>");if(i.strategy){for(var s=!0,o=0;o<i.strategy.length;o++){var n=i.strategy[o],r='<div class="detail"><div class="index">'+n.content+"</div>",d=n.usable?"":"disabled";switch(n.type){case"FREE":s=!1,r='<button class="button '+d+' free">立即领取</button>',o=i.strategy.length;break;case"BUY":r+='<button class="button '+d+' charge" id="'+n.activityId+'">立即购买</button>';break;case"CHARGE":r+='<button class="button '+d+' charge" id="'+n.activityId+'">立即充值</button>';break;case"POINT_EXCHANGE":r+='<button class="button '+d+' exchange" id="'+n.amount+"&"+n.activityId+"&"+n.ruleTupleId+'">立即兑换</button>'}a=a+r+"</div>"}i.strategy.length>1&&s?($(".pay-fixed .gold").show(),$(".pay-fixed .gold").html("<div style='text-align: center'><button style='float: inherit' id='more' class='button'>立即升级会员等级</button></div>"),$(".pay-fixed .gold").append("<div class='modal-code' style='display: none'>"+a+'<div class="close"></div></div>')):($(".pay-fixed .gold").show(),$(".pay-fixed .gold").html(a))}else $(".pay-fixed .gold").hide()}if(200==e.code){setTitle(e.result.brandName),$(".shop").html(e.result.brandName),loadImage(e.result.logoUrl,'$(".card-content .avatar").attr("src", url)'),e.result.card&&loadImage(e.result.card,'$(".card-bg").attr("style", "background-image:url(" + url + ")")');var i=0;if(e.result.currentGrade?(i=e.result.currentGrade-1,$(".card-detail .text").html(e.result.memberGradeName),e.result.memberCardNo&&$(".card-detail .opacity").html("卡号："+e.result.memberCardNo)):($(".grade").html("普通顾客"),$(".card-detail .opacity").attr("style","text-align:center").html("尊贵会员 特权专享")),$("#navBar").html(""),$("#pageContain").html(""),e.result.strategies){t(i+1);for(var a in e.result.strategies){var s=e.result.strategies[a],o='<div class="vip-name">当前可享权益 </div>';if(s.benefits){o+='<div class="earn-detail"> <div class="left">升级</div> <div class="right">';for(var n=0;n<s.benefits.length;n++)o+=s.benefits[n].content+"<br>";o+="</div></div>"}else o+='<div class="earn-detail"> <div class="left">升级</div> <div class="right">成功升级，得尊享大礼</div></div>';if(s.ruleText)for(var r in s.ruleText){var d=s.ruleText[r],l={6001:"升级",6002:"充值",6003:"兑换",6004:"折扣",6005:"打折",6006:"特价",6007:"返券",6008:"积分",6012:"抵扣",6014:"满减",6015:"套餐"};o+='<div class="earn-detail"><div class="left">'+l[d.category]+"</div>",d.contents.length&&(o+='<div class="right">'+d.contents.join("<br>"),d.time&&(o+="<div class='text-grey'>"+d.time+"</div>"),o+="</div>"),o+="</div>"}$("#pageContain").append('<div class="pages '+(i==a?"current":"")+'"> <div class="contain"> <div class="earn-detail1">'+o+"</div></div></div>"),$("#navBar").append("<li class='"+(i==a?"active":"")+"' index='"+s.toGrade+"'><div></div>"+s.toName+"</li>"),e.result.currentGrade&&$("li:nth-child("+e.result.currentGrade+")").addClass("king")}$("#loading").addClass("hide"),$.init()}else alert("该商户还未启用会员系统"),history.back();$("body").on("click","li",function(){$(".current").removeClass("current"),$(".active").removeClass("active"),$(this).addClass("active"),t($(this).attr("index"))})}})}setPayMode(e)}function changePhone(){var e,t=$.fn.cookie("phone");t&&$("#tel").val(t),$.init(),$("#loading").addClass("hide"),$("body").on("click",".code",function(){clearInterval(e);rest("/validate/binded",{},"post",function(t){e=validatePhone(t)})}),$("body").on("click",".submit",function(){clearInterval(e),$(".btn-orange").removeClass("submit");rest("/phone/binded",{validateCode:$("#code").val()},"post",function(e){200==e.code?($.fn.cookie("validateResult",e.result.validateResult),$("#old").hide(),$("#new").show(),$("#new .btn-orange").addClass("disabled").removeClass("submit").html("收取验证码")):($(".btn-orange").addClass("code").removeClass("submit"),$(".code").html("重新获取验证码"),$.toast(e.message?e.message:"请重试"))})}),$("body").on("input","#new_tel",function(){11==$("#new_tel").val().length?$(".disabled").removeClass("disabled").addClass("code1"):$(".btn-orange").addClass("disabled")}),$("body").on("click",".code1",function(){clearInterval(e),$("#new_code").show();var t=rest("/validate/binding",{phone:$("#new_tel").val()},"post",function(){if(200==t.code){$("#new_code").show(),$(".btn-orange").addClass("disabled");var e=90;setInterval(function(){e-=1,6==$("#new_code").val().length?($(".btn-orange").addClass("submit1").removeClass("disabled code1"),$(".btn-orange").html("确定")):($(".btn-orange").removeClass("submit1").addClass("code1"),e<=0?($(".btn-orange").removeClass("disabled"),$(".btn-orange").html("重新获取验证码")):($(".btn-orange").addClass("disabled"),$(".btn-orange").html("验证码已发送 "+e+"s")))},1e3)}else toast(t.message)})}),$("body").on("click",".submit1",function(){$(".btn-orange").removeClass("submit1");rest("/phone/binding",{phone:$("#new_tel").val(),validateCode:$("#new_code").val(),validateResult:$.fn.cookie("validateResult")},"post",function(e){200==e.code?(alert("成功"),history.go(-1)):toast(e.message)})})}function exchange(){rest("/activities/exchange/guest/"+_id,{},"get",function(e){if(200==e.code){var t=e.result;t.customerRelationId?$.fn.cookie("relation_id",t.customerRelationId):$(".button-light").hide(),$(".text-lg").html(t.point||0),$.fn.cookie("point",t.point||0);var i=$("#code ul");if(t.activity.length)for(var a=0;a<t.activity.length;a++){var s=t.activity[a],o=i.clone();if(o.find(".item-subtitle .text-orange").html(s.amount+".0"),o.find(".item").html(s.times),s.usable?o.find(".btn-orange").attr("id",s.amount+"&"+s.activityId+"&"+s.ruleTupleId):o.find(".btn-orange").addClass("disabled"),s.remainCount&&$("#remain").html("剩余"+s.remainCount+"个"),o.find(".from").html("适用对象： "+(s.from?s.from:"所有人")),s.coupons){var n=s.coupons[0];o.find(".label-update").attr("src","../sui_assets/img/exchange/coupon.svg"),o.find(".senior").remove(),o.find(".effectTimes").html(n.effectTimes),o.find(".name").html(n.name),"902"==n.category||"9021"==n.category?(o.find(".current-amount").html("<span style='font-size: .6rem'>￥</span>"+n.currentAmount),o.find(".amount").html("￥"+n.amount)):"9031"==n.category?(o.find(".name").html(n.value),o.find(".current-amount").html(n.amount+"<span style='font-size: .6rem'>折</span>")):"903"==n.category&&o.find(".current-amount").html(n.amount+"<span style='font-size: .6rem'>折</span>"),o.find(".coupon_show").attr("index",n.id)}else o.find(".coupon").remove(),o.find(".name").html(s.name),o.find(".senior").attr("style","background:url('../sui_assets/img/exchange/"+s.benefit+".png') no-repeat;background-size: 100% 86%;background-position: center;");$("#insert").append(o)}else $(".content").append('<img src="/assets/images/kong.png" style="width:40%;display:block;position:relative;margin: 50% auto;">');$.init(),$("#loading").addClass("hide")}})}function remainder(){function e(e){var t="";for(var i in e.items){var a=$(".hide #record").html();a=a.replace("@date@",e.items[i].date);var s="";for(var o in e.items[i].records){var n=$(".hide #context").html();n="601"==e.items[i].records[o].type?n.replace("@color@",'<span class="text-orange">+@money@</span>'):n.replace("@color@",'<span class="text-blue">-@money@</span>'),n=n.replace("@name@",e.items[i].records[o].content),n=n.replace("@time@",e.items[i].records[o].time),n=n.replace("@money@",e.items[i].records[o].amount),s+=n}a=a.replace("@record@",s),t+=a}$(".set-code").append(t)}var t=$.fn.cookie("relation_id");if(!t)return void history.go(-1);var i,a=1,s=15,o=!1;$("#amount").html($.fn.cookie("charge")||0),rest("/benefit/"+t+"/record/charge",{page:a,count:s},"get",function(t){200==t.code?(t.result&&e(t.result),i=t.result.total,i<=s&&$(".infinite-scroll-preloader").remove(),$.init(),$("#loading").addClass("hide")):($(".infinite-scroll-preloader").remove(),$(".set-code").html('<img src="/assets/images/kong.png" style="width:40%;display:block;position:relative;margin: 20% auto;">'))}),$(document).on("infinite",".infinite-scroll-bottom",function(){o||(o=!0,setTimeout(function(){if(!(a*s>=i)){a++;rest("/benefit/"+t+"/record/charge",{page:a,count:s},"get",function(t){t.result&&e(t.result),o=!1,$.refreshScroller()})}},1e3))})}function pointRecord(){function e(e){var t="",i=$(".hide #record").html();for(var a in e.items){var s=i;s=s.replace("@date@",e.items[a].date),s=s.replace("@got@",e.items[a].got||0),s=s.replace("@use@",e.items[a].used||0);var o="";for(var n in e.items[a].records){var r=$(".hide #context").html();r="601"==e.items[a].records[n].type?r.replace("@color@",'<span class="text-orange">+@money@</span>'):r.replace("@color@",'<span class="text-blue">-@money@</span>'),r=r.replace("@name@",e.items[a].records[n].content),r=r.replace("@time@",e.items[a].records[n].time),r=r.replace("@money@",e.items[a].records[n].amount),o+=r}s=s.replace("@record@",o),t+=s}$(".set-code").append(t)}var t=$.fn.cookie("relation_id");t||history.go(-1);var i,a=1,s=20,o=!1;$("#amount").html($.fn.cookie("point")||0),rest("/benefit/"+t+"/record/point",{page:a,count:s},"get",function(t){if(200==t.code){var a=t.result;e(a),i=a.total,i<=s&&$(".infinite-scroll-preloader").remove(),$.init(),$("#loading").addClass("hide")}else $(".infinite-scroll-preloader").remove(),$(".set-code").html('<img src="/assets/images/kong.png" style="width:40%;display:block;position:relative;margin: 20% auto;">')}),$(document).on("infinite",".infinite-scroll-bottom",function(){o||(o=!0,setTimeout(function(){if(a*s>=i)return void $(".infinite-scroll-preloader").remove();a++;rest("/benefit/"+t+"/record/point",{page:a,count:s},"get",function(t){t.result&&e(t.result),o=!1,$.refreshScroller()})},1e3))})}function activity(){rest("/activities/activity/"+key_json.aid,{},"get",function(e){if(200==e.code){var t=e.result;if(t.get||t.used){var i=t.get||[];i=i.concat(t.used||[]),t.get=i;for(var a=$("#code #get"),s=0;s<t.get.length;s++){var o=a.clone();if(o.find(".am-name").text(t.get[s].name),t.get[s].periods?o.find("#periods .lang").html(t.get[s].periods):o.find("#periods").hide(),t.get[s].shared?o.find("#shared .lang").html(t.get[s].shared):o.find("#shared").hide(),t.get[s].shops?o.find("#shops .lang").html(t.get[s].shops):o.find("#shops").hide(),t.get[s].nonParticipations?o.find("#nonParticipations .lang").html(t.get[s].nonParticipations):o.find("#nonParticipations").hide(),t.get[s].time?o.find("#time .lang").html(t.get[s].time):o.find("#time").hide(),t.get[s].descriptor?o.find("#descriptor .lang").html(t.get[s].descriptor):o.find("#descriptor").hide(),null!=t.get[s].limit){var n="";for(var r in t.get[s].limit){var d=$("#limit-content").html();d=d.replace("@limit@",t.get[s].limit[r]),n+=d}o.find("#limit-content").html(n)}else o.find("#limit").hide();var l="";for(var c in t.get[s].strategy){var u=$("#code #activity-title").html();u=u.replace("@class@",t.get[s].strategy[c].name);var m="",v=t.get[s].strategy[c].details;for(var p in v){var h=$("#code #activity-content").html();if(null!=v[p].content){var f="";for(var g in v[p].content){var b=o.find("#list-name").html();b=b.replace("@content@",v[p].content[g]),f+=b}h=h.replace($("#code #list-name").html(),f)}var y="";if(null!=v[p].coupons)for(var g in v[p].coupons){var k=v[p].coupons[g],x="";"901"==k.category?(x=$("#code #tmp-coupon-charge").html(),x=x.replace("@@name@@",k.name),x=x.replace("@@effectTimes@@",k.effectTimes),x=x.replace("@id@",k.id)):"902"==k.category||"9021"==k.category?(x=$("#code #tmp-coupon-consume").html(),x=x.replace("@@name@@",k.name),x=x.replace("@@amount@@",k.amount),
x=x.replace("@@currentAmount@@",k.currentAmount?"￥"+k.currentAmount:"免费"),x=x.replace("@@effectTimes@@",k.effectTimes),x=x.replace("@id@",k.id)):(x=$("#code #tmp-coupon-charge").html(),x=x.replace("@@name@@",k.name),x=x.replace("@@effectTimes@@",k.effectTimes),x=x.replace("@id@",k.id),x=x.replace("代金券","礼品券")),y+=x}h=h.replace($("#code #coupon").html(),y),m+=h}u=u.replace($("#code #activity-content").html(),m),l+=u}o.find("#activity-title").html(l),$(".set_code").append(o),$(".loader-bg").hide()}}$.init(),$("#loading").addClass("hide")}else history.go(-1)})}function charge(){app=new Vue({el:"#app",data:{data:"",key:0,payment:{}},beforeCreate:function(){function e(e){e&&e.payMode?_self.payment=e:$(".submit .right").remove(),rest("/activities/recharge/guest/"+_id,{},"get",function(e){if(200==e.code){if(e.result.customerRelationId?($.fn.cookie("relation_id",e.result.customerRelationId),$.fn.cookie("charge",e.result.charge)):$(".record").hide(),e.result.activity&&e.result.activity.length)for(var t in e.result.activity){var i=[];for(var a in e.result.activity[t].benefits){var s=e.result.activity[t].benefits[a];switch(s.type){case"1014":i.push(s.amount+"元");break;case"1015":i.push(s.amount+"积分");break;case"1016":i.push(s.name+"（"+s.count+"张）"+(s.countLimit?"最多"+s.countLimit+"张":""))}}e.result.activity[t].str=i.join("、")}_self.data=e.result}else alert(e.message)})}$("#loading").addClass("hide"),_self=this,setPayMode(e)},methods:{submitFn:function(){if(_self=this,$.showIndicator(),"false"==$(this).attr("usable"))return $.hideIndicator(),void alert("当前活动不可参与！");var e={activityId:_self.data.activity[_self.key].activityId,ruleTupleId:_self.data.activity[_self.key].ruleTupleId,payCategory:_self.payment.payMode,url:encodeURIComponent(location.href),failedUrl:encodeURIComponent(location.href)};"channel"==key_json.type&&(e.channel="401"),rest("/benefit/recharge/guest/"+_id,e,"post",function(e){if(200!=e.code)return alert(e.message),void $.hideIndicator();var t=e.result.orderId;if(e.result.url)return void(location.href=e.result.url);switch(_self.payment.payMode){case"1005":var i=e.result.js,a=e.result.pay;a.success=function(){rest("/order/"+t,{},"get",function(e){"200"==e.code||"404014"==e.code?earnTrue():alert(e.message)}),$.hideIndicator()},a.cancel=function(){cancelPay(),$.hideIndicator()},a.fail=function(e){cancelPay(),$.hideIndicator(),alert("支付失败")},i.debug=!1,i.jsApiList=["chooseWXPay"],delete i.url,wx.config(i),wx.ready(function(){wx.chooseWXPay(a)});break;case"1101":AlipayJSBridge.call("tradePay",{tradeNO:e.result.pay.tradeNO},function(e){return"6001"==e.resultCode?void cancelPay():("9000"==e.resultCode&&rest("/order/"+t,{},"get",function(e){"200"==e.code||"404014"==e.code?earnTrue():alert(e.message)}),void $.hideIndicator())})}})}}})}function phoneModal(e){"phone"==e?$.modal({title:"<strong>【补全手机】</strong>",afterText:'<div class="text-xs" style="padding-top: .5rem">补全手机后，同步您已有权益/方便参与更多活动</div><div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><input type="tel" placeholder="您的常用手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="收到的验证码" id="validate" maxlength="6"/></div><div class="btn-green" style="margin: 1rem -1px 0;" id="bindPhone">确认</div><div class="md-close"></div>',extraClass:"bg-green"}):$.modal({title:"<strong>【补全手机 领取权益】</strong>",afterText:'<div class="text-xs" style="padding-top: .5rem">绑定手机号后，您的权益将立即到账</div><div class="text-center"><div style="height: 2px;background: #e1e1e1;margin: 1rem 40%"></div><input type="tel" placeholder="您的常用手机号码" id="tel" maxlength="11"/><div class="input-text">获取验证码</div><input type="tel" placeholder="收到的验证码" id="validate" maxlength="6"/></div><div class="btn-green" style="margin: 1rem -1px 0;" id="bindPhone">确认</div><div class="md-close"></div>',extraClass:"bg-green"}),bind()}function setA1(){$(".modal")?($(".modal").show(),$(".modal-overlay").addClass("modal-overlay-visible")):alert("只有新用户可以参与")}function setBack(){$("#code").hide(),$("#ing").attr("onclick","$('#code').show();$('.popup-overlay').addClass('modal-overlay-visible')").show(),$(".popup-overlay").removeClass("modal-overlay-visible"),$.fn.cookie("limitcoupon","true",{expires:.0034722})}function earnTrue(e){"channel"==key_json.type?$.modal({title:"操作成功",buttons:[{text:"我的权益",onClick:function(){"WXPAY"==version?rest("/user/guest/"+_id,{},"get",function(e){ajaxUrl(200!=e.code||e.result.subscribe?"my.html":"success.html")}):ajaxUrl("my.html")}},{text:"继续买单",bold:!0,onClick:function(){state()}}]}):$.modal({title:"操作成功",buttons:[{text:"我知道啦",onClick:function(){"WXPAY"==version?rest("/user/guest/"+_id,{},"get",function(e){200!=e.code||e.result.subscribe?shopId?ajaxUrl("my.html"):ajaxUrl():ajaxUrl("success.html")}):shopId?ajaxUrl("my.html"):ajaxUrl()}}]})}function setPayMode(e){rest("/shop/"+_id+"/paymode",{type:version},"get",function(t){200==t.code?(payment=t.result.payMode,$.fn.cookie("payment",JSON.stringify(t.result))):$.fn.cookie("payment","",{expires:0}),e&&e(t.result)})}function toast(e){$("body").append("<div class='toast-center'><div class='toast'>"+e+"</div></div>"),setTimeout(function(){$(".toast-center").remove()},3e3)}function validatePhone(e){if(200==e.code){$("#code").show(),$(".btn-orange").addClass("disabled");var t=90,i=setInterval(function(){6==$("#code").val().length?($(".btn-orange").addClass("submit").removeClass("disabled code"),$(".btn-orange").html("确定")):($(".btn-orange").removeClass("submit").addClass("code"),t-=1,t<=0?($(".btn-orange").removeClass("disabled"),$(".btn-orange").html("重新获取验证码")):($(".btn-orange").addClass("disabled"),$(".btn-orange").html("验证码已发送 "+t+"s")))},1e3);return i}$.toast(e.message)}function earn(e,t){var i={activityId:e,ruleTupleId:t},a="/benefit/follow/guest/"+_id;rest(a,i,"post",function(e){200==e.code?($.closeModal(),shopId?earnTrue("my.html"):earnTrue()):$.toast(e.message)})}function checkCoupon(){$("#coupons").toggleClass("up"),$(".popup-overlay").toggleClass("modal-overlay-visible"),$.fn.cookie("limitcoupon","true",{expires:.0034722})}function refreshCode(){rest("/check/code",{},"get",function(e){200==e.code&&($("#my-code1").html(""),qrcode=new QRCode($("#my-code1"),{width:200,height:200}),qrcode.makeCode(e.result.code))})}function check(){$.showIndicator();var e={},t="/check/shop/"+shopId;key_json.d&&(e={tableId:key_json.d}),rest(t,e,"post",function(e){switch(e.code){case 200:$.fn.cookie("order_id",e.result.orderId),$.fn.cookie("table_no",e.result.tableNo),ajaxUrl("waiting.html");break;case 405004:$("#loading").removeClass("hide"),$.confirm("您在"+(e.result.shopname||"本店"+e.result.tableNo+"号桌")+"有一个买单正在进行中,是否取消？",function(){rest("/check/shop/"+e.result.shopId+"/cancel",{},"post",function(e){200==e.code&&(alert("取消成功！"),check())})},function(){"waiting"==basicName&&wx.ready(function(){wx.closeWindow()})}),$("#loading").addClass("hide");break;case 405007:alert("当前桌台有个请求正在处理，请让服务员处理");break;default:alert(e.message),"waiting"==basicName&&wx.ready(function(){wx.closeWindow()})}})}function state(){rest("/check/"+$.fn.cookie("order_id"),{},"get",function(e){if(200==e.code){var t=e.result;1==t.step?t.online?($.fn.cookie("table_no",t.tableNo),ajaxUrl("waiting.html")):$.toast("上宾正在加速为您配置专属优惠方案"):t.state>=2?goto("strategy.html"):window.location.href=location.href+"&time="+(new Date).getTime()}else ajaxUrl("entrance.html")})}function setCoupon(e){for(var t=$(".hide .coupon_show"),i=0;i<e.items.length;i++){var a=t.clone(),s=e.items[i];switch(a.attr("id",s.id),a.find(".name").html(s.name),s.category){case"9021":case"902":a.find(".amount0").html("<span style='font-size: .6rem'>可抵 ￥</span>"+(s.amount-s.currentAmount)+'<div class="through">'+s.amount+"</div>");break;case"9031":a.find(".name").html(s.value),a.find(".amount0").html(s.amount+"<span style='font-size: .6rem'> 折</span>");break;case"904":a.find(".amount0").html("<span style='font-size: .6rem'>价值 ￥</span>"+s.amount);break;default:a.find(".amount0").remove()}a.find(".a4001").addClass("a"+s.state),a.find(".addon").html("<span>"+s.times+"</span>"),a.find(".addon").append("<span>"+s.useStrategy+"</span>"),$(".set-coupon").append(a)}}function setCheckCode(e,t){for(var i={6001:"MEMBERUPGRADE",6002:"CHARGE",6003:"EXCHANGE",6004:"COUPONFREE",6005:"DISCOUNT",6006:"SPECIAL_PRICE",6007:"COUPON",6008:"POINT",6012:"SPENDAS",6014:"LIMITREDUCE",6015:"SETMEAL"},a=0;a<e.length;a++){var s=e[a].activities;if("6007"!=e[a].activityCategory){more=$("#code #more");for(var o=0;o<s.length;o++){var n=s[o],r=i[e[a].activityCategory],d=more.clone();if(d.find(".set-title").addClass(r),0==o&&d.find(".set-title").append($("#code .content-title1").html()),d.find(".text").html(n.name),s.length>1)switch(d.find(".set-title").append($("#code .content-desc1").html()),d.find(".content-desc").html(n.name),d.find(".right").addClass("hide"),e[a].activityCategory){case"6005":d.find(".text").html("全单折扣有力度");break;case"6006":d.find(".text").html("特价促销");break;case"6008":d.find(".text").html("小积分大用处");break;case"6012":d.find(".text").html("抵扣活动");break;case"6014":d.find(".text").html("满额减免");break;case"6015":d.find(".text").html("套餐活动")}var l=$("#code #more").find("li");d.attr("onclick","goto('activity.html?aid="+n.activityId+"')");for(var c=0;c<n.strategy.length;c++){var u=n.strategy[c];if(u.coupons)for(var m=0;m<u.coupons.length;m++){var v=u.coupons[m],p=l.clone();p.find(".item-title .name").html(v.value),p.find(".item-title .text-grey .orange-lg").html("￥"+v.currentAmount),p.find(".item-title .text-grey .line-through").html(" ￥"+v.amount),p.find(".item-media").html('<img src="/sui_assets/img/space_coupon.png" class="space"/>'),p.find(".item-after").html(text),d.find("ul").append(p)}else{var p=l.clone();switch(p.find(".item-title .text-grey").html(n.time),r){case"POINT":p.find(".item-media").remove(),u.amount?p.find(".item-title .name").html((u.from?u.from+":":"")+"消费<span class='orange-lg'>"+u.amount+"</span>元积<span class='orange-lg'>"+u.benefit+"</span>分"):p.find(".item-title .name").html("消费即获得<span class='orange-lg'>"+u.benefit+"</span>积分"),u.type&&"1007"==u.type&&p.find(".item-title .name").html(n.limit[0]);break;case"DISCOUNT":p.find(".item-media").remove(),u.amount?p.find(".item-title .name").html("消费满<span class='orange-lg'>"+u.amount+"</span>元 享<span class='orange-lg'>"+u.benefit+"</span>折"):p.find(".item-title .name").html("消费即享<span class='orange-lg'>"+u.benefit+"</span>折");break;case"SPECIAL_PRICE":u.desUrl?p.find(".item-media").html('<img src="'+u.desUrl+'" class="space"/>'):p.find(".item-media").html('<img src="/sui_assets/img/space.png" class="space"/>'),p.find(".item-title .name").html(u.name);break;case"LIMITREDUCE":p.find(".item-media").remove(),p.find(".item-title .name").html("消费每满<span class='orange-lg'>"+u.amount+"</span>元减<span class='orange-lg'>"+u.benefit+"</span>元");break;case"SPENDAS":p.find(".item-media").remove(),p.find(".item-title .name").html("<span class='orange-lg'>"+u.amount+"</span>元可抵<span class='orange-lg'>"+u.benefit+"</span>元消费");break;case"SETMEAL":u.desUrl?p.find(".item-media").html('<img src="'+u.desUrl+'" class="space"/>'):p.find(".item-media").html('<img src="/sui_assets/img/space.png" class="space"/>'),p.find(".item-title .name").html("<span class='orange-lg'>"+u.amount+"</span>套餐现价<span class='orange-lg'>"+u.benefit+"</span>元"),d.attr("onclick","goto('mealActivity.html?aid="+n.activityId+"')")}d.find("ul").append(p)}}t?$(".top").html(d):$(".code").append(d)}}else{var h=[e[a]];setActivityCode(h,"6007")}}}function setActivityCode(e,t){var i={6001:"MEMBERUPGRADE",6002:"CHARGE",6003:"EXCHANGE",6004:"COUPONFREE",6005:"DISCOUNT",6006:"SPECIAL_PRICE",6007:"COUPON",6008:"POINT"};if(e)for(var a=e,s=0;s<a.length;s++)for(var o=a[s].activities,n=a[s].activityCategory,r=0;r<o.length;r++){if("6004"==n||"6007"==n){for(var d=0;d<o[r].strategy.length;d++){var l=o[r].strategy[d],c=$("#code #coupons").clone();c.find(".set-title").addClass(i[n]),0==d&&c.find(".set-title").append($("#code .content-title1").html()),o[r].strategy.length>1?(c.find(".set-title").append($("#code .content-desc1").html()),c.find(".content-desc").html(o[r].name),"6004"==n?c.find(".text").html("免费领取礼遇"):c.find(".text").html("消费即送大礼")):c.find(".text").html(o[r].name);var u="";c.find(".text-grey").html(l.from),"6007"==n?(c.find(".btn-green-light").html("买单即享"),c.attr("onclick","ajaxUrl('activity.html?aid="+o[r].activityId+"')")):c.attr("onclick","ajaxUrl('couponActivity.html?aid="+o[r].activityId+"&rid="+l.ruleTupleId+"')");for(var m=0;m<l.coupons.length;m++){var v=l.coupons[m];switch(v.category){case"901":u=$("#code .money-box").clone(),u.find(".coupon-content").addClass("money-box"),u.find(".name").html(v.value+"元代金券"),u.find(".text-gold").html(v.value);break;case"9021":case"902":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(v.value),u.find(".current-amount").html(v.currentAmount?"￥"+v.currentAmount:"免费"),u.find(".amount").html("￥"+v.amount);break;case"9011":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(v.currentAmount+"元抵"+v.amount+"元"),u.find("img").attr("src","sui_assets/img/card/dikou.svg").css("margin-top","0px");break;case"904":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(v.value);break;case"9031":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html(v.value),u.find(".current-amount").html(v.amount+"折");break;case"903":u=$("#code .good-box").clone(),u.find(".coupon-content").addClass("good-box"),u.find(".name").html("全场"+v.amount+"折"),u.find(".current-amount").html(v.amount+"折")}u.find("ul").append("<li>"+v.effectTimes+"</li>"),v.useStrategy&&u.find("ul").append("<li>"+v.useStrategy+"</li>");var p="";l.remainCount?u.find(".limit-label").html("剩"+l.remainCount+"份"):0==l.remainCount?(p="disabled",c.find(".btn-green-light").html("已抢光"),u.find(".limit-label").html("剩 0 份")):u.find(".limit-label").remove(),c[0].className="coupons row no-gutter "+i[n]+" "+p,c.find(".set_coupon").append(u?u.html():"")}1===t?$(".top").append(c):$(".code").append(c)}c=""}else if("6002"==n){var c=$("#code #coupons").clone(),u="";c.find(".set-title").append($("#code .content-title1").html()),c[0].className="coupons row no-gutter "+i[n],c.find(".text").html(o[r].name),c.attr("onclick","ajaxUrl('charge.html')"),u=$("#code .charge-box").clone();for(var h=0;h<o[r].strategy.length;h++){var l=o[r].strategy[h],f=$("#code .charge-content").clone();if(f.find(".name").html(l.amount+"元"),l.benefits)switch(l.benefits[0].type){case"1014":f.find("ul").append("<li>"+l.benefits[0].amount+"元</li>");break;case"1015":f.find("ul").append("<li>"+l.benefits[0].amount+"积分</li>");break;case"1016":f.find("ul").append("<li>"+l.benefits[0].name+"（"+l.benefits[0].count+"张）</li>")}else f.find(".row").html("充值有礼");u.find(".card1").append(f)}c.find(".text-grey").html(o[r].strategy[0].from),c.find(".btn-green-light").html("立即充值"),c.find(".set_coupon").html(u?u.html():"")}else{var c=$("#code #coupons").clone(),u="";c.find(".set-title").append($("#code .content-title1").html()),c[0].className="coupons row no-gutter "+i[n],c.find(".text").html(o[r].name),c.attr("onclick","ajaxUrl('exchange.html')"),u=$("#code .charge-box").clone();for(var h=0;h<o[r].strategy.length;h++){var f=$("#code .charge-content").clone();if(f.find(".no-gutter").addClass("exchange"),f.find(".name").html(o[r].strategy[h].amount+"积分"),o[r].strategy[h].coupons)for(var g=o[r].strategy[h].coupons,b=0;b<g.length;b++){var y="";y="901"==g[b].category?"元代金券":"902"==g[b].category||"9021"==g[b].category?"抵用券":"礼品券",f.find("ul").append("<li>"+o[r].strategy[h].coupons[b].value+y+"</li>")}else f.find("ul").append("<li>"+o[r].strategy[h].amount+"元</li>");u.find(".card1").append(f)}c.find(".text-grey").html(o[r].strategy[0].from),c.find(".btn-green-light").html("立即兑换"),c.find(".set_coupon").html(u?u.html():"")}t?$(".top").append(c):$(".code").append(c)}}function setMemberCode(e){var t=$("#code .coupons").clone();t.attr("onclick","ajaxUrl('vip.html')"),t[0].className="coupons row no-gutter MEMBERUPGRADE",t.find(".set-title").append($("#code .content-title1").html());var i=$("#code .card-box").clone();if(i.find(".name").html(e.toName),t.find(".btn-green-light").html("立即加入"),user.card&&loadImage(user.card,'$(".card-bg").attr("style", "background-image:url(" + url + ")")'),e.ruleText.length){var a="<div style='display: list-item;margin-left: .8rem'>"+e.ruleText[0].name+"</div><div style='font-size: 1rem'> ...</div>";i.find(".card-demand").html(a)}t.find(".text").html("加入会员享优惠"),t.find(".set_coupon").html(i.html()),$(".code").append(t)}function loadImage(url,callback){var img=new Image;img.src=url,img.onload=function(){eval(callback)}}function goto(e){ajaxUrl(e)}function ajaxUrl(e){$("body").html("");var t="?";e||(e=shopId?"entrance.html":"user.html"),2==e.split("?").length&&(t="&"),shopId?e+=key_json.d?t+"id="+shopId+"&d="+key_json.d:t+"id="+shopId:(e+=t+"guestid="+key_json.guestid,$.fn.cookie("relation_id")?location.href=e+"&relationid="+$.fn.cookie("relation_id"):""),location.href=e,setTimeout(function(){location.href=e},10)}function socket(){setTimeout(function(){var e,t="wss://"+location.hostname+"/websocket?id="+$.fn.cookie("user"),i=new WebSocket(t);i.onopen=function(){e=setInterval(function(){i.send("1")},3e4)},i.onmessage=function(e){if("success"==e.data)return!1;var t=JSON.parse(e.data);switch(t.orderId&&$.fn.cookie("order_id",t.orderId,{path:"/"}),t.type){case"500000":ajaxUrl("waiting.html");break;case"500042":$.toast("支付完成"),ajaxUrl("payment.html?order="+t.orderId);break;case"500051":alert("买单被取消"),ajaxUrl();break;case"500052":alert("pad下线"),ajaxUrl();break;case"500053":alert("买单请求超时未处理被取消"),ajaxUrl();break;case"500054":ajaxUrl("strategy.html?oid="+t.orderId);break;case"500005":ajaxUrl("payment.html?order="+t.orderId);break;case"500055":ajaxUrl("strategy.html?oid="+t.orderId);break;case"500050":alert("服务员未响应"),ajaxUrl()}},i.onclose=function(){setTimeout(function(){window.location.href=location.href+"&time="+(new Date).getTime()},1e4)},i.onerror=function(){}},100)}function rest(e,t,i,a){function s(e){var t="037925fa578c4ed98885d7b28ade5462",i=[];if(Object.keys(e).length)for(var a in e)i.push(a);e.timestamp=(new Date).getTime(),i.push("timestamp"),i.sort();var s="",o={};for(var n in i)s+=i[n]+"="+e[i[n]],o[i[n]]=e[i[n]];s+=t;for(var r=hex_md5(s),d="",l=0;l<r.length;l+=2)d+=r.charAt(l);for(var c=1;c<r.length;c+=2)d+=r.charAt(c);return o.signature=d,o}function o(){for(var e="037925fa578c4ed98885d7b28ade5462",t=(new Date).getTime(),i=hex_md5("timestamp="+t+e),a="",s=0;s<i.length;s+=2)a+=i.charAt(s);for(var o=1;o<i.length;o+=2)a+=i.charAt(o);return"timestamp="+t+"&signature="+a}$.fn.cookie("apikey","6b774cc5eb7d45818a9c7cc0a4b6920f",{expire:30,path:"/"});var n=location.origin+e,r={};"get"==i?r=s(t):(n+="?"+o(),r=JSON.stringify(t)),xh=$.ajax({url:n,data:r,timeout:15e3,type:i,dataType:"json",async:!0,beforeSend:function(e){e.setRequestHeader("Content-Type","application/json")},success:function(e){return 403e3==e.code?($("body").html(""),$.fn.cookie("token","",{expires:0}),$.fn.cookie(_id,"false",{expires:0}),$.fn.cookie("url",location.href,{expires:.002}),void ajaxUrl("index.html")):403060==e.code?(ajaxUrl("bind.html"),void alert("请先绑定手机号")):(a(e),void $.hideIndicator())},complete:function(e,t){$.hideIndicator(),"timeout"==t&&(xh.abort(),alert("网络状况不好，请刷新重试"))}})}var key_json={},shopId="",guestId,key="",_id="",version="ALIPAY",stop=1,payment,dataS={};if(location.search){for(var key_str=location.search.substr(1),i=0;i<key_str.split("&").length;i++){var j=key_str.split("&")[i].split("=");key_json[j[0]]=j[1]}key_json.id&&(shopId=key_json.id),key_json.guestid&&(guestId=key_json.guestid),_id=key_json.id||key_json.guestid}else location.href="error.html";"undefined"!==key_json.id&&"undefined"!==key_json.guestid||(location.href="error.html");var ua=window.navigator.userAgent.toLowerCase();if("micromessenger"==ua.match(/MicroMessenger/i)&&(version="WXPAY",$.fn.cookie("token")?$.fn.cookie(_id)||(stop=0,rest("/author",{},"get",function(e){200==e.code?($.fn.cookie(_id,"true",{expires:1}),location.href=location.origin+"/author/guest/"+_id+"?url="+encodeURIComponent(location.href.split("&state=1")[0])):location.href="index.html"+location.search.split("&state=1")[0]})):(stop=0,$.fn.cookie("url",location.href,{expires:.002}),location.href="index.html"+location.search.split("&state=1")[0])),$.config={router:!1},stop){var basicName=location.pathname.split(".")[0].split("/")[1];basicName?eval(basicName)():entrance(),$(function(){if(shopId&&"WXPAY"==version&&"praise"!=basicName&&"paymentee"!=basicName){var e={};e.url=location.href,rest("/auth/sign",e,"post",function(e){if(200==e.code){var t=e.result;t.jsApiList=["hideOptionMenu","closeWindow"],wx.config(t),wx.ready(function(){wx.hideOptionMenu()})}})}$("body").on("click",".coupon_show",function(){var e,t=$(this);if($(this).attr("index"))e="/activities/coupon/"+$(this).attr("index");else if(e="/benefit/userCoupon/"+$(this).attr("id"),$(this).find(".a4002").length||$(this).find(".a4003").length)return;$.showIndicator(),rest(e,{},"get",function(e){if(200==e.code){var i={901:"本券买单时自动抵用",902:"本券在买单时出示使用",9021:"本券在买单时出示使用",9011:"本券买单时自动抵用",904:"到店出示给服务员即可使用",9031:"到店出示给服务员即可使用",903:"本券买单时自动抵用"},a=e.result,s=$(".popup-coupon");s.length||(s=document.createElement("div"),s.innerHTML='<div class="popup popup-coupon bottom-fx"><div class="liner"><span class="text2"></span><span class="md-close"></span></div><div class="coupon-show-box"><div class="name_add"><div class="name"></div><div class="code"></div><div id="my-code"></div></div></div><div class="coupons-detail"></div>',$(".page-group").append(s),s=$(".popup-coupon")),s.find(".text2").html(i[a.category]),s.find(".name").html(a.name);var o="";"902"!=a.category&&"9021"!=a.category||(o+='<div class="item"><div class="left">价值：</div><div class="right">原价:'+a.amount+"元，现价:"+a.currentAmount+"元</div></div>"),"901"!=a.category&&"904"!=a.category||(o+='<div class="item"><div class="left">价值：</div><div class="right"> '+a.amount+"元</div></div>"),o+='<div class="item"><div class="left">使用条件：</div><div class="right">'+a.useStrategy+'</div></div><div class="item"><div class="left">有效期：</div><div class="right">'+a.times+'</div></div><div class="item"><div class="left">详情：</div><div class="right">';for(var n in a.content)o=o+"<div>"+a.content[n]+"</div>";if(o+='</div></div><div class="item"><div class="left">备注：</div><div class="right"><div>本券不找零，不兑现，不做外卖使用</div><div>最终解释权归本公司所有</div></div></div>',s.find(".coupons-detail").html(o),s.find(".code").html(a.code||""),$("#my-code").html(""),t.attr("id")&&("902"==a.category||"9021"==a.category||"904"==a.category||"9031"==a.category)){var r=new QRCode($("#my-code"),{width:100,height:100});r.makeCode(a.id)}$.popup(".popup-coupon")}})}),$("body").on("click",".exchange",function(){if(!$(this).hasClass("disabled")){var e=$(this).attr("id").split("&");if(e.length<2)return;$.confirm("本次抢兑需要花费"+e[0]+"积分,确认抢兑?",function(){rest("/benefit/exchange/guest/"+_id,{activityId:e[1],ruleTupleId:e[2]},"post",function(e){200==e.code?earnTrue():$.toast(e.message)})})}}),$("body").on("click",".modal-overlay-visible",function(){if($(this).hasClass("popup-overlay"))if("entrance"==basicName){if("display: block;"==$(".modal-in").attr("style"))return void $(".popup").hide();if($.fn.cookie("limitcoupon","true",{expires:.0034722}),$.closeModal(),$(".modal-overlay-visible").removeClass("modal-overlay-visible"),$(".e-close").hasClass("alone"))return void setBack();$(".fix-b").hide(),$("#qr").show(),$("#coupons").addClass("up")}else $.closeModal(),setTimeout(function(){$(".modal-overlay-visible").removeClass("modal-overlay-visible")},100)}),$("body").on("click",".md-close",function(){"entrance"==basicName?($(".modal").hide(),$(".popup").hide(),$(this).parent().hasClass("liner")||($(".modal-overlay-visible").removeClass("modal-overlay-visible"),$.fn.cookie("limitcoupon","true",{expires:.0034722}))):$.closeModal()}),"vip"==basicName&&($("body").on("click","#more",function(){$(".modal-code").show(),$(this).parent().hide()}),$("body").on("click",".close",function(){$(".modal-code").hide(),$("#more").parent().show()}),$("body").on("click",".charge",function(){if(!payment)return void alert("没有可用的付款方式");$.showIndicator(),$.fn.cookie("payment")||$(this).addClass("disabled");var e={activityId:$(this).attr("id"),payCategory:payment,url:encodeURIComponent(location.href),failedUrl:encodeURIComponent(location.href)};"channel"==key_json.type&&(e.channel="401"),rest("/benefit/upgrade/guest/"+_id,e,"post",function(e){if($.hideIndicator(),200!==e.code)return alert(e.message),void $.closeModal();var t=e.result.orderId;if(e.result.url)return void(location.href=e.result.url);switch(payment){case"1005":var i=e.result.js,a=e.result.pay;a.success=function(){rest("/order/"+t,{},"get",function(e){"200"==e.code||"404014"==e.code?earnTrue():alert(e.message)}),$(".alipay").removeClass("disabled")},a.cancel=function(){$(".alipay").removeClass("disabled"),cancelPay()},a.fail=function(e){$(".alipay").removeClass("disabled"),cancelPay()},i.debug=!1,i.jsApiList=["chooseWXPay"],delete i.url,wx.config(i),wx.ready(function(){wx.chooseWXPay(a)});break;case"1101":AlipayJSBridge.call("tradePay",{tradeNO:e.result.pay.tradeNO},function(e){return"6001"==e.resultCode?void cancelPay():void("9000"==e.resultCode&&rest("/order/"+t,{},"get",function(e){200==e.code||404014==e.code?earnTrue():alert(e.message)}))})}$("this").removeClass("disabled")})}),$("body").on("click",".free",function(){var e=$(this),t=(e.attr("id"),{id:_id});"channel"==key_json.type&&(t.channel="401"),rest("/membership",t,"post",function(e){200==e.code?earnTrue():(alert(e.message),"405053"==e.code&&ajaxUrl())})})),"dishes"==basicName&&setTimeout(function(){$(".right").on("scroll",function(){$(this).scrollTop()<$("#meal").height()+20?($("#first").addClass("active"),$("#second").removeClass("active")):($("#first").removeClass("active"),$("#second").addClass("active"))})},1e3)})}var interval;
!function(e,n){"function"==typeof define&&(define.amd||define.cmd)?define(function(){return n(e)}):n(e,!0)}(this,function(e,n){function i(n,i,t){e.WeixinJSBridge?WeixinJSBridge.invoke(n,o(i),function(e){c(n,e,t)}):u(n,t)}function t(n,i,t){e.WeixinJSBridge?WeixinJSBridge.on(n,function(e){t&&t.trigger&&t.trigger(e),c(n,e,i)}):t?u(n,t):u(n,i)}function o(e){return e=e||{},e.appId=P.appId,e.verifyAppId=P.appId,e.verifySignType="sha1",e.verifyTimestamp=P.timestamp+"",e.verifyNonceStr=P.nonceStr,e.verifySignature=P.signature,e}function r(e){return{timeStamp:e.timestamp+"",nonceStr:e.nonceStr,"package":e["package"],paySign:e.paySign,signType:e.signType||"SHA1"}}function a(e){return e.postalCode=e.addressPostalCode,delete e.addressPostalCode,e.provinceName=e.proviceFirstStageName,delete e.proviceFirstStageName,e.cityName=e.addressCitySecondStageName,delete e.addressCitySecondStageName,e.countryName=e.addressCountiesThirdStageName,delete e.addressCountiesThirdStageName,e.detailInfo=e.addressDetailInfo,delete e.addressDetailInfo,e}function c(e,n,i){"openEnterpriseChat"==e&&(n.errCode=n.err_code),delete n.err_code,delete n.err_desc,delete n.err_detail;var t=n.errMsg;t||(t=n.err_msg,delete n.err_msg,t=s(e,t),n.errMsg=t),i=i||{},i._complete&&(i._complete(n),delete i._complete),t=n.errMsg||"",P.debug&&!i.isInnerInvoke&&alert(JSON.stringify(n));var o=t.indexOf(":"),r=t.substring(o+1);switch(r){case"ok":i.success&&i.success(n);break;case"cancel":i.cancel&&i.cancel(n);break;default:i.fail&&i.fail(n)}i.complete&&i.complete(n)}function s(e,n){var i=e,t=h[i];t&&(i=t);var o="ok";if(n){var r=n.indexOf(":");o=n.substring(r+1),"confirm"==o&&(o="ok"),"failed"==o&&(o="fail"),-1!=o.indexOf("failed_")&&(o=o.substring(7)),-1!=o.indexOf("fail_")&&(o=o.substring(5)),o=o.replace(/_/g," "),o=o.toLowerCase(),("access denied"==o||"no permission to execute"==o)&&(o="permission denied"),"config"==i&&"function not exist"==o&&(o="ok"),""==o&&(o="fail")}return n=i+":"+o}function d(e){if(e){for(var n=0,i=e.length;i>n;++n){var t=e[n],o=g[t];o&&(e[n]=o)}return e}}function u(e,n){if(!(!P.debug||n&&n.isInnerInvoke)){var i=h[e];i&&(e=i),n&&n._complete&&delete n._complete,console.log('"'+e+'",',n||"")}}function l(e){if(!(_||w||P.debug||"6.0.2">M||V.systemType<0)){var n=new Image;V.appId=P.appId,V.initTime=C.initEndTime-C.initStartTime,V.preVerifyTime=C.preVerifyEndTime-C.preVerifyStartTime,N.getNetworkType({isInnerInvoke:!0,success:function(e){V.networkType=e.networkType;var i="https://open.weixin.qq.com/sdk/report?v="+V.version+"&o="+V.isPreVerifyOk+"&s="+V.systemType+"&c="+V.clientVersion+"&a="+V.appId+"&n="+V.networkType+"&i="+V.initTime+"&p="+V.preVerifyTime+"&u="+V.url;n.src=i}})}}function p(){return(new Date).getTime()}function f(n){T&&(e.WeixinJSBridge?n():S.addEventListener&&S.addEventListener("WeixinJSBridgeReady",n,!1))}function m(){N.invoke||(N.invoke=function(n,i,t){e.WeixinJSBridge&&WeixinJSBridge.invoke(n,o(i),t)},N.on=function(n,i){e.WeixinJSBridge&&WeixinJSBridge.on(n,i)})}if(!e.jWeixin){var g={config:"preVerifyJSAPI",onMenuShareTimeline:"menu:share:timeline",onMenuShareAppMessage:"menu:share:appmessage",onMenuShareQQ:"menu:share:qq",onMenuShareWeibo:"menu:share:weiboApp",onMenuShareQZone:"menu:share:QZone",previewImage:"imagePreview",getLocation:"geoLocation",openProductSpecificView:"openProductViewWithPid",addCard:"batchAddCard",openCard:"batchViewCard",chooseWXPay:"getBrandWCPayRequest",openEnterpriseRedPacket:"getRecevieBizHongBaoRequest",startSearchBeacons:"startMonitoringBeacons",stopSearchBeacons:"stopMonitoringBeacons",onSearchBeacons:"onBeaconsInRange",consumeAndShareCard:"consumedShareCard",openAddress:"editAddress"},h=function(){var e={};for(var n in g)e[g[n]]=n;return e}(),S=e.document,v=S.title,I=navigator.userAgent.toLowerCase(),y=navigator.platform.toLowerCase(),_=!(!y.match("mac")&&!y.match("win")),w=-1!=I.indexOf("wxdebugger"),T=-1!=I.indexOf("micromessenger"),k=-1!=I.indexOf("android"),x=-1!=I.indexOf("iphone")||-1!=I.indexOf("ipad"),M=function(){var e=I.match(/micromessenger\/(\d+\.\d+\.\d+)/)||I.match(/micromessenger\/(\d+\.\d+)/);return e?e[1]:""}(),C={initStartTime:p(),initEndTime:0,preVerifyStartTime:0,preVerifyEndTime:0},V={version:1,appId:"",initTime:0,preVerifyTime:0,networkType:"",isPreVerifyOk:1,systemType:x?1:k?2:-1,clientVersion:M,url:encodeURIComponent(location.href)},P={},A={_completes:[]},L={state:0,data:{}};f(function(){C.initEndTime=p()});var B=!1,O=[],N={config:function(e){P=e,u("config",e);var n=P.check!==!1;f(function(){if(n)i(g.config,{verifyJsApiList:d(P.jsApiList)},function(){A._complete=function(e){C.preVerifyEndTime=p(),L.state=1,L.data=e},A.success=function(e){V.isPreVerifyOk=0},A.fail=function(e){A._fail?A._fail(e):L.state=-1};var e=A._completes;return e.push(function(){l()}),A.complete=function(n){for(var i=0,t=e.length;t>i;++i)e[i]();A._completes=[]},A}()),C.preVerifyStartTime=p();else{L.state=1;for(var e=A._completes,t=0,o=e.length;o>t;++t)e[t]();A._completes=[]}}),P.beta&&m()},ready:function(e){0!=L.state?e():(A._completes.push(e),!T&&P.debug&&e())},error:function(e){"6.0.2">M||(-1==L.state?e(L.data):A._fail=e)},checkJsApi:function(e){var n=function(e){var n=e.checkResult;for(var i in n){var t=h[i];t&&(n[t]=n[i],delete n[i])}return e};i("checkJsApi",{jsApiList:d(e.jsApiList)},function(){return e._complete=function(e){if(k){var i=e.checkResult;i&&(e.checkResult=JSON.parse(i))}e=n(e)},e}())},onMenuShareTimeline:function(e){t(g.onMenuShareTimeline,{complete:function(){i("shareTimeline",{title:e.title||v,desc:e.title||v,img_url:e.imgUrl||"",link:e.link||location.href,type:e.type||"link",data_url:e.dataUrl||""},e)}},e)},onMenuShareAppMessage:function(e){t(g.onMenuShareAppMessage,{complete:function(){i("sendAppMessage",{title:e.title||v,desc:e.desc||"",link:e.link||location.href,img_url:e.imgUrl||"",type:e.type||"link",data_url:e.dataUrl||""},e)}},e)},onMenuShareQQ:function(e){t(g.onMenuShareQQ,{complete:function(){i("shareQQ",{title:e.title||v,desc:e.desc||"",img_url:e.imgUrl||"",link:e.link||location.href},e)}},e)},onMenuShareWeibo:function(e){t(g.onMenuShareWeibo,{complete:function(){i("shareWeiboApp",{title:e.title||v,desc:e.desc||"",img_url:e.imgUrl||"",link:e.link||location.href},e)}},e)},onMenuShareQZone:function(e){t(g.onMenuShareQZone,{complete:function(){i("shareQZone",{title:e.title||v,desc:e.desc||"",img_url:e.imgUrl||"",link:e.link||location.href},e)}},e)},startRecord:function(e){i("startRecord",{},e)},stopRecord:function(e){i("stopRecord",{},e)},onVoiceRecordEnd:function(e){t("onVoiceRecordEnd",e)},playVoice:function(e){i("playVoice",{localId:e.localId},e)},pauseVoice:function(e){i("pauseVoice",{localId:e.localId},e)},stopVoice:function(e){i("stopVoice",{localId:e.localId},e)},onVoicePlayEnd:function(e){t("onVoicePlayEnd",e)},uploadVoice:function(e){i("uploadVoice",{localId:e.localId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},downloadVoice:function(e){i("downloadVoice",{serverId:e.serverId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},translateVoice:function(e){i("translateVoice",{localId:e.localId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},chooseImage:function(e){i("chooseImage",{scene:"1|2",count:e.count||9,sizeType:e.sizeType||["original","compressed"],sourceType:e.sourceType||["album","camera"]},function(){return e._complete=function(e){if(k){var n=e.localIds;n&&(e.localIds=JSON.parse(n))}},e}())},getLocation:function(e){},previewImage:function(e){i(g.previewImage,{current:e.current,urls:e.urls},e)},uploadImage:function(e){i("uploadImage",{localId:e.localId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},downloadImage:function(e){i("downloadImage",{serverId:e.serverId,isShowProgressTips:0==e.isShowProgressTips?0:1},e)},getLocalImgData:function(e){B===!1?(B=!0,i("getLocalImgData",{localId:e.localId},function(){return e._complete=function(e){if(B=!1,O.length>0){var n=O.shift();wx.getLocalImgData(n)}},e}())):O.push(e)},getNetworkType:function(e){var n=function(e){var n=e.errMsg;e.errMsg="getNetworkType:ok";var i=e.subtype;if(delete e.subtype,i)e.networkType=i;else{var t=n.indexOf(":"),o=n.substring(t+1);switch(o){case"wifi":case"edge":case"wwan":e.networkType=o;break;default:e.errMsg="getNetworkType:fail"}}return e};i("getNetworkType",{},function(){return e._complete=function(e){e=n(e)},e}())},openLocation:function(e){i("openLocation",{latitude:e.latitude,longitude:e.longitude,name:e.name||"",address:e.address||"",scale:e.scale||28,infoUrl:e.infoUrl||""},e)},getLocation:function(e){e=e||{},i(g.getLocation,{type:e.type||"wgs84"},function(){return e._complete=function(e){delete e.type},e}())},hideOptionMenu:function(e){i("hideOptionMenu",{},e)},showOptionMenu:function(e){i("showOptionMenu",{},e)},closeWindow:function(e){e=e||{},i("closeWindow",{},e)},hideMenuItems:function(e){i("hideMenuItems",{menuList:e.menuList},e)},showMenuItems:function(e){i("showMenuItems",{menuList:e.menuList},e)},hideAllNonBaseMenuItem:function(e){i("hideAllNonBaseMenuItem",{},e)},showAllNonBaseMenuItem:function(e){i("showAllNonBaseMenuItem",{},e)},scanQRCode:function(e){e=e||{},i("scanQRCode",{needResult:e.needResult||0,scanType:e.scanType||["qrCode","barCode"]},function(){return e._complete=function(e){if(x){var n=e.resultStr;if(n){var i=JSON.parse(n);e.resultStr=i&&i.scan_code&&i.scan_code.scan_result}}},e}())},openAddress:function(e){i(g.openAddress,{},function(){return e._complete=function(e){e=a(e)},e}())},openProductSpecificView:function(e){i(g.openProductSpecificView,{pid:e.productId,view_type:e.viewType||0,ext_info:e.extInfo},e)},addCard:function(e){for(var n=e.cardList,t=[],o=0,r=n.length;r>o;++o){var a=n[o],c={card_id:a.cardId,card_ext:a.cardExt};t.push(c)}i(g.addCard,{card_list:t},function(){return e._complete=function(e){var n=e.card_list;if(n){n=JSON.parse(n);for(var i=0,t=n.length;t>i;++i){var o=n[i];o.cardId=o.card_id,o.cardExt=o.card_ext,o.isSuccess=!!o.is_succ,delete o.card_id,delete o.card_ext,delete o.is_succ}e.cardList=n,delete e.card_list}},e}())},chooseCard:function(e){i("chooseCard",{app_id:P.appId,location_id:e.shopId||"",sign_type:e.signType||"SHA1",card_id:e.cardId||"",card_type:e.cardType||"",card_sign:e.cardSign,time_stamp:e.timestamp+"",nonce_str:e.nonceStr},function(){return e._complete=function(e){e.cardList=e.choose_card_info,delete e.choose_card_info},e}())},openCard:function(e){for(var n=e.cardList,t=[],o=0,r=n.length;r>o;++o){var a=n[o],c={card_id:a.cardId,code:a.code};t.push(c)}i(g.openCard,{card_list:t},e)},consumeAndShareCard:function(e){i(g.consumeAndShareCard,{consumedCardId:e.cardId,consumedCode:e.code},e)},chooseWXPay:function(e){i(g.chooseWXPay,r(e),e)},openEnterpriseRedPacket:function(e){i(g.openEnterpriseRedPacket,r(e),e)},startSearchBeacons:function(e){i(g.startSearchBeacons,{ticket:e.ticket},e)},stopSearchBeacons:function(e){i(g.stopSearchBeacons,{},e)},onSearchBeacons:function(e){t(g.onSearchBeacons,e)},openEnterpriseChat:function(e){i("openEnterpriseChat",{useridlist:e.userIds,chatname:e.groupName},e)}},E=1,b={};return S.addEventListener("error",function(e){if(!k){var n=e.target,i=n.tagName,t=n.src;if("IMG"==i||"VIDEO"==i||"AUDIO"==i||"SOURCE"==i){var o=-1!=t.indexOf("wxlocalresource://");if(o){e.preventDefault(),e.stopPropagation();var r=n["wx-id"];if(r||(r=E++,n["wx-id"]=r),b[r])return;b[r]=!0,wx.ready(function(){wx.getLocalImgData({localId:t,success:function(e){n.src=e.localData}})})}}}},!0),S.addEventListener("load",function(e){if(!k){var n=e.target,i=n.tagName;if(n.src,"IMG"==i||"VIDEO"==i||"AUDIO"==i||"SOURCE"==i){var t=n["wx-id"];t&&(b[t]=!1)}}},!0),n&&(e.wx=e.jWeixin=N),N}});